<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPRM ¬∑ Gesti√≥n de Riesgos de Terceros</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #181c24;
    --surface3: #1e2330;
    --border: #252a36;
    --border2: #2e3545;
    --accent: #3b82f6;
    --accent2: #6366f1;
    --accent-glow: rgba(59,130,246,0.15);
    --text: #e8eaf0;
    --text2: #8b92a5;
    --text3: #5a6278;
    --red: #ef4444;
    --red-soft: rgba(239,68,68,0.12);
    --amber: #f59e0b;
    --amber-soft: rgba(245,158,11,0.12);
    --green: #10b981;
    --green-soft: rgba(16,185,129,0.12);
    --purple: #8b5cf6;
    --purple-soft: rgba(139,92,246,0.12);
    --cyan: #06b6d4;
    --sidebar-w: 240px;
    --header-h: 60px;
    --radius: 10px;
    --radius-sm: 6px;
  }
  :root.light {
    --bg: #f0f2f7;
    --surface: #ffffff;
    --surface2: #f5f7fb;
    --surface3: #eaecf4;
    --border: #dde1ed;
    --border2: #c8cfe0;
    --accent: #2563eb;
    --accent2: #4f46e5;
    --accent-glow: rgba(37,99,235,0.10);
    --text: #111827;
    --text2: #4b5563;
    --text3: #9ca3af;
    --red: #dc2626;
    --red-soft: rgba(220,38,38,0.10);
    --amber: #d97706;
    --amber-soft: rgba(217,119,6,0.10);
    --green: #059669;
    --green-soft: rgba(5,150,105,0.10);
    --purple: #7c3aed;
    --purple-soft: rgba(124,58,237,0.10);
    --cyan: #0891b2;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { transition: background .25s, color .25s; }
  html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
  #sidebar, #main, .card, .modal, input, select, textarea, .nav-item, .topbar, #topbar, table, thead, tbody, tr, th, td {
    transition: background-color .2s, border-color .2s, color .2s;
  }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface2); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  #app { display: flex; height: 100vh; overflow: hidden; }

  #sidebar {
    width: var(--sidebar-w); flex-shrink: 0;
    background: var(--surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow-y: auto; z-index: 100;
  }
  .sidebar-logo { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); }
  .sidebar-logo .logo-text {
    font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .sidebar-logo .logo-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; margin-top: 2px; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-section-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); padding: 0 8px; margin-bottom: 6px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; border-radius: var(--radius-sm);
    cursor: pointer; color: var(--text2); font-size: 13px;
    transition: all 0.15s; margin-bottom: 2px; user-select: none;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent-glow); color: var(--accent); font-weight: 500; }
  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #topbar {
    height: var(--header-h); flex-shrink: 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; border-bottom: 1px solid var(--border); background: var(--surface);
  }
  .topbar-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--surface2); border-radius: 20px; font-size: 12px; cursor: pointer; }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white; flex-shrink: 0;
  }
  #content { flex: 1; overflow-y: auto; padding: 24px; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500; cursor: pointer;
    border: none; transition: all 0.15s; font-family: inherit; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #2563eb; box-shadow: 0 0 20px rgba(59,130,246,0.3); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
  .btn-secondary:hover { background: var(--surface3); }
  .btn-danger { background: var(--red-soft); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
  .btn-danger:hover { background: rgba(239,68,68,0.2); }
  .btn-ghost { background: transparent; color: var(--text2); border: none; }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: var(--radius-sm); }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 16px; }

  .badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; }
  .badge-red { background: var(--red-soft); color: var(--red); }
  .badge-amber { background: var(--amber-soft); color: var(--amber); }
  .badge-green { background: var(--green-soft); color: var(--green); }
  .badge-blue { background: var(--accent-glow); color: var(--accent); }
  .badge-purple { background: var(--purple-soft); color: var(--purple); }
  .badge-gray { background: var(--surface3); color: var(--text2); }

  .hom-status { display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500; }
  .hom-pendiente { background:var(--surface3);color:var(--text3); }
  .hom-fuera { background:var(--surface3);color:var(--text3); }
  .hom-scope { background:rgba(6,182,212,.12);color:#06b6d4; }
  .hom-scoring { background:var(--amber-soft);color:var(--amber); }
  .hom-dd { background:rgba(139,92,246,.12);color:#8b5cf6; }
  .hom-aprobacion { background:var(--accent-glow);color:var(--accent); }
  .hom-completada { background:var(--green-soft);color:var(--green); }

  .btn-success { background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,.2); }
  .btn-success:hover { background:rgba(16,185,129,.2); }

  /* API LOOKUP */
  .api-lookup-box { background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius);padding:16px;margin-top:8px; }
  .api-result-card { background:var(--surface3);border-radius:var(--radius-sm);padding:12px 14px;margin-top:10px;font-size:12px; }
  .api-result-hit { background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-result-clean { background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-result-partial { background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-spinning { display:inline-block;animation:spin .8s linear infinite; }
  @keyframes spin { from{transform:rotate(0deg)}to{transform:rotate(360deg)} }
  .api-provider-card { border:1px solid var(--border2);border-radius:var(--radius);padding:14px;cursor:pointer;transition:all .15s; }
  .api-provider-card:hover { border-color:var(--accent);background:var(--accent-glow); }
  .api-provider-card.selected { border-color:var(--accent);background:var(--accent-glow); }

  /* IMPORT ZONE */
  .import-zone { border:2px dashed var(--border2);border-radius:var(--radius);padding:32px 24px;text-align:center;cursor:pointer;transition:all .2s;position:relative; }
  .import-zone:hover, .import-zone.drag-over { border-color:var(--accent);background:var(--accent-glow); }
  .import-zone input[type=file] { position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%; }
  .import-zone-icon { font-size:36px;margin-bottom:10px;display:block; }

  .ai-proposal-bar { background:linear-gradient(90deg,rgba(99,102,241,.15),rgba(59,130,246,.15));border:1px solid rgba(99,102,241,.3);border-radius:var(--radius);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px; }
  .ai-proposal-badge { background:linear-gradient(135deg,#6366f1,#3b82f6);color:white;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:.5px;flex-shrink:0; }

  .proposal-section-header { background:var(--surface3);border-radius:var(--radius-sm);padding:8px 14px;margin:12px 0 8px;font-size:12px;font-weight:600;color:var(--accent);display:flex;align-items:center;gap:6px; }

  .analyzing-overlay { text-align:center;padding:48px 24px; }
  .analyzing-spinner { width:48px;height:48px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px; }

  /* FORMS */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
  .form-input, .form-select, .form-textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); color: var(--text);
    padding: 8px 12px; font-size: 13px; font-family: inherit;
    outline: none; transition: border-color 0.15s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-input:disabled { opacity: 0.4; cursor: not-allowed; }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-select option { background: var(--surface2); }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .form-note { font-size: 11px; color: var(--text3); margin-top: 4px; }

  /* TOGGLE ‚Äî pure CSS, no JS needed for visual */
  .toggle { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--surface3); border-radius: 20px; transition: 0.2s; }
  .toggle-slider::before { content: ''; position: absolute; width: 14px; height: 14px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: 0.2s; }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  /* CHIP SELECTOR ‚Äî rewritten to use pure data attributes, no classList toggling issues */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid var(--border2); cursor: pointer;
    font-size: 12px; color: var(--text2); transition: all 0.15s;
    user-select: none; background: var(--surface2);
  }
  .chip:hover { border-color: var(--accent); color: var(--text); }
  .chip[data-sel="1"] { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
  .chip-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text3); padding: 10px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 12px 12px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text2); vertical-align: middle; }
  tr:hover td { background: var(--surface2); }
  tr:last-child td { border-bottom: none; }

  /* MODAL */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px); z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.15s ease;
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); width: 90%; max-width: 700px;
    max-height: 90vh; display: flex; flex-direction: column;
    animation: slideUp 0.2s ease;
  }
  .modal-lg { max-width: 900px; }
  .modal-xl { max-width: 1100px; }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; gap: 16px; }
  .modal-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; align-items: center; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* TABS */
  .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 10px 16px; cursor: pointer; color: var(--text2); font-size: 13px; border-bottom: 2px solid transparent; transition: all 0.15s; margin-bottom: -1px; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }

  /* SEARCH */
  .search-bar { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 8px 12px; color: var(--text2); }
  .search-bar input { background: none; border: none; outline: none; color: var(--text); font-size: 13px; flex: 1; font-family: inherit; }
  .search-bar input::placeholder { color: var(--text3); }

  .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; }
  .stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--text3); margin-top: 6px; }

  /* RISK BADGES */
  .risk-tag-sin { background: var(--surface3); color: var(--text3); }
  .risk-tag-proceso { background: var(--accent-glow); color: var(--accent); }
  .risk-tag-alto { background: var(--red-soft); color: var(--red); }
  .risk-tag-medio { background: var(--amber-soft); color: var(--amber); }
  .risk-tag-bajo { background: var(--green-soft); color: var(--green); }

  /* CHART BARS */
  .chart-bar { display: flex; flex-direction: column; gap: 10px; }
  .chart-bar-row { display: flex; align-items: center; gap: 10px; }
  .chart-bar-label { font-size: 12px; color: var(--text2); width: 100px; flex-shrink: 0; text-align: right; }
  .chart-bar-track { flex: 1; height: 20px; background: var(--surface3); border-radius: 4px; overflow: hidden; }
  .chart-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; font-size: 11px; color: white; font-weight: 600; min-width: 4px; }
  .chart-bar-val { font-size: 12px; color: var(--text2); width: 24px; text-align: right; }

  /* QUESTION BUILDER */
  .question-card { background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .question-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent-glow); color: var(--accent); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .option-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .option-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; color: var(--text); font-size: 12px; font-family: inherit; outline: none; }
  .option-input:focus { border-color: var(--accent); }
  .option-score { width: 64px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--amber); font-size: 12px; font-family: inherit; outline: none; text-align: center; }
  .flag-btn { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); background: var(--surface); font-size: 13px; transition: all 0.15s; flex-shrink: 0; }
  .flag-btn.on { background: var(--red-soft); border-color: rgba(239,68,68,0.3); }

  /* WIZARD STEPS */
  .wizard-steps { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
  .wizard-step { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text3); }
  .wizard-step.active { color: var(--accent); font-weight: 600; }
  .wizard-step.done { color: var(--green); }
  .step-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .wizard-step .step-dot { background: var(--surface3); color: var(--text3); }
  .wizard-step.active .step-dot { background: var(--accent); color: white; }
  .wizard-step.done .step-dot { background: var(--green); color: white; }
  .step-sep { color: var(--border2); font-size: 14px; }

  /* COUNTRY TAG INPUT */
  .tag-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 6px 10px; min-height: 42px; cursor: text; }
  .tag-input-wrap:focus-within { border-color: var(--accent); }
  .tag-pill { display: flex; align-items: center; gap: 4px; background: var(--accent-glow); border: 1px solid var(--accent); color: var(--accent); border-radius: 20px; padding: 2px 8px; font-size: 12px; }
  .tag-pill button { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 14px; line-height: 1; padding: 0; opacity: 0.7; }
  .tag-pill button:hover { opacity: 1; }
  .tag-input-field { background: none; border: none; outline: none; color: var(--text); font-size: 13px; font-family: inherit; min-width: 120px; flex: 1; }
  .tag-dropdown { position: absolute; z-index: 200; background: var(--surface); border: 1px solid var(--border2); border-radius: var(--radius-sm); max-height: 220px; overflow-y: auto; width: 100%; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .tag-option { padding: 8px 12px; cursor: pointer; font-size: 13px; color: var(--text2); }
  .tag-option:hover { background: var(--surface2); color: var(--text); }
  .tag-option.highlighted { background: var(--accent-glow); color: var(--accent); }
  .tag-wrap-pos { position: relative; }

  /* NOTIFICATION */
  .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 12px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 500; animation: slideRight 0.3s ease; max-width: 340px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .notification-success { background: var(--green); color: white; }
  .notification-error { background: var(--red); color: white; }
  @keyframes slideRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .section-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
  .section-sub { font-size: 13px; color: var(--text3); margin-top: 2px; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; display: block; margin: 0 auto 16px; }
  .action-plan-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .info-box { background: var(--accent-glow); border: 1px solid rgba(59,130,246,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--accent); }
  .warn-box { background: var(--amber-soft); border: 1px solid rgba(245,158,11,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--amber); }

  /* DOMAIN BUILDER */
  .domain-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:border-color .15s; }
  .domain-card:hover { border-color:var(--border2); }
  .domain-card-head { padding:16px 18px;display:flex;align-items:center;gap:12px; }
  .domain-color-dot { width:10px;height:10px;border-radius:50%;flex-shrink:0; }
  .domain-badge-draft { background:var(--amber-soft);color:var(--amber);font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;letter-spacing:.3px }
  .domain-badge-active { background:var(--green-soft);color:var(--green);font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;letter-spacing:.3px }

  .phase-tabs { display:flex;border-bottom:1px solid var(--border);margin-bottom:20px;gap:0; }
  .phase-tab { padding:10px 18px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap; }
  .phase-tab:hover { color:var(--text);background:var(--surface2); }
  .phase-tab.active { color:var(--accent);border-bottom-color:var(--accent);font-weight:600; }
  .phase-tab .tab-count { display:inline-block;margin-left:6px;background:var(--surface3);color:var(--text3);font-size:10px;font-weight:600;padding:1px 6px;border-radius:10px; }
  .phase-tab.active .tab-count { background:var(--accent-glow);color:var(--accent); }

  .builder-layout { display:grid;grid-template-columns:1fr 280px;gap:16px;align-items:start; }
  .library-panel { background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:sticky;top:0; }
  .library-panel-title { font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px; }
  .lib-item { padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;font-size:12px;color:var(--text2);background:var(--surface);transition:all .15s; }
  .lib-item:hover { border-color:var(--accent);color:var(--text);background:var(--accent-glow); }
  .lib-item-text { font-size:11px;color:var(--text);margin-bottom:3px;line-height:1.3; }
  .lib-item-meta { font-size:10px;color:var(--text3); }

  .threshold-row { display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px; }
  .threshold-box { background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center; }
  .threshold-box-label { font-size:11px;font-weight:600;margin-bottom:8px; }
  .threshold-box input { width:52px;text-align:center; }

  /* HOMOLOGACI√ìN V2 */
  .hom-domain-table { width:100%;border-collapse:collapse; }
  .hom-domain-table th { font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;padding:8px 14px;text-align:left;border-bottom:2px solid var(--border2); }
  .hom-domain-table td { padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle; }
  .hom-domain-table tr:last-child td { border-bottom:none; }
  .hom-domain-table tr:hover td { background:var(--surface2); }

  .dom-fase-cell { display:flex;align-items:center;gap:6px;font-size:12px; }
  .dom-fase-pill { padding:3px 10px;border-radius:10px;font-size:11px;font-weight:600;white-space:nowrap; }
  .dom-fase-pending   { background:var(--surface3);color:var(--text3); }
  .dom-fase-draft     { background:var(--amber-soft);color:var(--amber); }
  .dom-fase-done      { background:var(--green-soft);color:var(--green); }
  .dom-fase-noapply   { background:var(--surface3);color:var(--text3);text-decoration:line-through; }
  .dom-fase-required  { background:var(--red-soft);color:var(--red); }

  .hom-session-modal { max-width:920px;height:90vh;display:flex;flex-direction:column; }
  .hom-domain-tabs { display:flex;gap:0;border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0; }
  .hom-domain-tab { padding:10px 16px;font-size:12px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap;transition:all .15s;display:flex;align-items:center;gap:6px; }
  .hom-domain-tab:hover { color:var(--text); }
  .hom-domain-tab.active { color:var(--accent);border-bottom-color:var(--accent);font-weight:600; }
  .hom-domain-tab .dom-dot { width:8px;height:8px;border-radius:50%;flex-shrink:0; }
  .hom-domain-tab .tab-status { font-size:10px;padding:1px 6px;border-radius:8px; }

  .autosave-indicator { font-size:11px;color:var(--text3);display:flex;align-items:center;gap:5px; }

  /* USER DROPDOWN */
  .user-dropdown-item { padding:10px 14px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:10px;color:var(--text2);transition:background .1s; }
  .user-dropdown-item:hover { background:var(--surface2);color:var(--text); }
  .user-dropdown-item.active { background:var(--accent-glow);color:var(--accent);font-weight:600; }
  .user-dropdown-item .ud-avatar { width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0; }

  /* DASHBOARD V2 */
  .dash-kpi-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px; }
  .dash-kpi { background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color .15s; }
  .dash-kpi:hover { border-color:var(--border2); }
  .dash-kpi-value { font-family:'Syne',sans-serif;font-size:32px;font-weight:800;line-height:1;margin-bottom:4px; }
  .dash-kpi-label { font-size:11px;color:var(--text3);font-weight:500;text-transform:uppercase;letter-spacing:.4px; }
  .dash-kpi-sub { font-size:11px;color:var(--text3);margin-top:6px; }

  .dash-section-title { font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:8px; }
  .dash-two-col { display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px; }
  @media(max-width:900px) { .dash-two-col { grid-template-columns:1fr; } }

  .dash-domain-bar { display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border); }
  .dash-domain-bar:last-child { border-bottom:none; }
  .dash-domain-progress { flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden; }
  .dash-domain-progress-fill { height:100%;border-radius:3px;transition:width .3s; }

  .linked-q-overlay { opacity:.55;pointer-events:none;position:relative; }
  .linked-q-badge { position:absolute;top:50%;right:10px;transform:translateY(-50%);background:var(--surface2);border:1px solid var(--border2);border-radius:4px;font-size:10px;padding:2px 7px;color:var(--text3);pointer-events:none; }

  .dd-section-divider { display:flex;align-items:center;gap:10px;margin:16px 0 10px; }
  .dd-section-divider-line { flex:1;height:1px;background:var(--border2); }
  .dd-section-divider-label { font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);white-space:nowrap;padding:2px 8px;border:1px solid var(--border2);border-radius:4px; }
</style>
</head>
<body>
<div id="app">
  <nav id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">TPRM</div>
      <div class="logo-sub">Risk Management Platform</div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Principal</div>
      <div class="nav-item" data-page="dashboard" onclick="navigate('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="nav-item" data-page="terceros" onclick="navigate('terceros')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Maestro de Terceros
      </div>
      <div class="nav-item" data-page="homologaciones" onclick="navigate('homologaciones')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Homologaciones
      </div>
      <div class="nav-item" data-page="planes" onclick="navigate('planes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Planes de Acci√≥n
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Configuraci√≥n</div>
      <div class="nav-item" data-page="usuarios" onclick="navigate('usuarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Usuarios y Roles
      </div>
      <div class="nav-item" data-page="ambitos" onclick="navigate('ambitos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
        Dominios de Riesgo
      </div>
      <div class="nav-item" data-page="tipos" onclick="navigate('tipos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Tipos de Tercero
      </div>
      <div class="nav-item" data-page="biblioteca" onclick="navigate('biblioteca')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        Biblioteca de Preguntas
      </div>
      <div class="nav-item" data-page="plazos" onclick="navigate('plazos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Plazos de Renovaci√≥n
      </div>
    </div>

    <div style="padding:12px;border-top:1px solid var(--border);margin-top:auto">
      <button onclick="toggleTheme()" id="theme-btn" style="width:100%;display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);border:1px solid var(--border2);background:var(--surface2);color:var(--text2);cursor:pointer;font-size:13px;transition:all .15s">
        <span id="theme-icon">üåô</span>
        <span id="theme-label">Modo oscuro</span>
        <span style="margin-left:auto;width:32px;height:18px;border-radius:9px;background:var(--border2);position:relative;transition:background .2s" id="theme-track">
          <span id="theme-thumb" style="position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--text3);transition:all .2s"></span>
        </span>
      </button>
    </div>

  </nav>

  <main id="main">
    <div id="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <div class="user-badge" onclick="toggleUserDropdown()" style="position:relative;cursor:pointer" id="user-badge-btn">
          <div class="user-avatar" id="topbar-avatar">AU</div>
          <span id="topbar-username">Admin Usuario</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-left:4px;opacity:.5"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div id="user-dropdown" style="display:none;position:absolute;top:56px;right:16px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:1000;overflow:hidden"></div>
      </div>
    </div>
    <div id="content"></div>
  </main>
</div>

<div id="modals"></div>
<div id="notifications"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COUNTRIES LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COUNTRIES = [
  "Afganist√°n","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia",
  "Australia","Austria","Azerbaiy√°n","Bahamas","Banglad√©s","Barbados","Bar√©in","B√©lgica","Belice","Ben√≠n","Bielorrusia",
  "Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","Brun√©i","Bulgaria","Burkina Faso","Burundi","But√°n","Cabo Verde",
  "Camboya","Camer√∫n","Canad√°","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Congo","Corea del Norte",
  "Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador",
  "Emiratos √Årabes Unidos","Eritrea","Eslovaquia","Eslovenia","Espa√±a","Estados Unidos","Estonia","Etiop√≠a","Fiyi",
  "Filipinas","Finlandia","Francia","Gab√≥n","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea",
  "Guinea Ecuatorial","Guinea-Bis√°u","Guyana","Hait√≠","Honduras","Hungr√≠a","India","Indonesia","Irak","Ir√°n","Irlanda",
  "Islandia","Islas Marshall","Islas Salom√≥n","Israel","Italia","Jamaica","Jap√≥n","Jordania","Kazajist√°n","Kenia",
  "Kirguist√°n","Kiribati","Kuwait","Laos","Lesoto","Letonia","L√≠bano","Liberia","Libia","Liechtenstein","Lituania",
  "Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","Mali","Malta","Marruecos","Mauricio","Mauritania","M√©xico",
  "Micronesia","Moldavia","M√≥naco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","N√≠ger",
  "Nigeria","Noruega","Nueva Zelanda","Om√°n","Pa√≠ses Bajos","Pakist√°n","Palaos","Palestina","Panam√°","Pap√∫a Nueva Guinea",
  "Paraguay","Per√∫","Polonia","Portugal","Reino Unido","Rep√∫blica Centroafricana","Rep√∫blica Checa","Rep√∫blica Dominicana",
  "Ruanda","Ruman√≠a","Rusia","Samoa","San Crist√≥bal y Nieves","San Marino","San Vicente y las Granadinas","Santa Luc√≠a",
  "Santo Tom√© y Pr√≠ncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka",
  "Suazilandia","Sud√°frica","Sud√°n","Sud√°n del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","Tayikist√°n",
  "Timor Oriental","Togo","Tonga","Trinidad y Tobago","T√∫nez","Turkmenist√°n","Turqu√≠a","Tuvalu","Ucrania","Uganda",
  "Uruguay","Uzbekist√°n","Vanuatu","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue"
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  currentPage: 'dashboard',
  data: {
    terceros: [
      { id:'t1', nombre:'Accenture Spain', denominacion:'Accenture S.L.', grupo:'Accenture PLC', cif:'B82387770', domicilio:'Av. de Bruselas 35, Alcobendas', pais:'Espa√±a', representante:'Jos√© Garc√≠a', responsable:'Mar√≠a P√©rez', tipo:'Proveedor Directo', fechaPrimera:'2022-03-15', fechaSiguiente:'2025-03-15', fechaUltima:'2024-03-15', riesgo:'medio', comentarios:'Proveedor estrat√©gico de TI', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t2', nombre:'Deloitte Advisory', denominacion:'Deloitte Advisory S.L.', grupo:'Deloitte Global', cif:'B79835397', domicilio:'Plaza Pablo Ruiz Picasso 1, Madrid', pais:'Espa√±a', representante:'Ana L√≥pez', responsable:'Carlos Ruiz', tipo:'Proveedor Directo', fechaPrimera:'2021-06-01', fechaSiguiente:'2024-06-01', fechaUltima:'2023-06-01', riesgo:'bajo', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t3', nombre:'Amazon Web Services', denominacion:'Amazon Web Services EMEA SARL', grupo:'Amazon Inc', cif:'B67890123', domicilio:'38 Av JF Kennedy, Luxemburgo', pais:'Luxemburgo', representante:'Peter Schmidt', responsable:'Laura Torres', tipo:'Proveedor Directo', fechaPrimera:'2023-01-10', fechaSiguiente:'2025-01-10', fechaUltima:'2024-01-10', riesgo:'alto', comentarios:'Procesamiento datos cr√≠ticos', remediacion:'Realizar auditor√≠a de seguridad Q2 2025', remediacionUser:'laura.torres@empresa.com', remediacionFecha:'2025-06-30', activo:true },
      { id:'t4', nombre:'Carrefour Espa√±a', denominacion:'Carrefour Espa√±a S.A.', grupo:'Carrefour Group', cif:'A28375103', domicilio:'C/ Campezo 16, Madrid', pais:'Espa√±a', representante:'Philippe Dumont', responsable:'Ignacio Sanz', tipo:'Cliente', fechaPrimera:'2020-09-01', fechaSiguiente:'2025-09-01', fechaUltima:'2023-09-01', riesgo:'sin valorar', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
    ],
    usuarios: [
      { id:'u1', nombre:'Admin Usuario', email:'admin@empresa.com', roles:['admin'], activo:true },
      { id:'u2', nombre:'Mar√≠a P√©rez', email:'maria.perez@empresa.com', roles:['usuario','aprobador'], activo:true },
      { id:'u3', nombre:'Carlos Ruiz', email:'carlos.ruiz@empresa.com', roles:['supervisor'], activo:true },
      { id:'u4', nombre:'Laura Torres', email:'laura.torres@empresa.com', roles:['usuario'], activo:true },
    ],
    ambitos: [
      {
        id:'a1', nombre:'Cyber', descripcion:'Riesgos de ciberseguridad', responsable:'Mar√≠a P√©rez', color:'#3b82f6',
        borrador: false,
        cuestionario: {
          scopeCheck: {
            preguntas: [
              { id:'sc_a1_1', texto:'¬øEl tercero tiene acceso a sistemas o redes internas?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}], origenId:null },
              { id:'sc_a1_2', texto:'¬øProcesa o almacena datos sensibles de la organizaci√≥n?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}], origenId:null },
            ],
            umbralMaterial: 2
          },
          riskScoring: {
            preguntas: [
              { id:'rs_a1_1', texto:'¬øEn qu√© regi√≥n est√° domiciliado el tercero?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'UE / OCDE',valor:1,flag:false},{texto:'Pa√≠s de riesgo medio',valor:2,flag:false},{texto:'Pa√≠s de alto riesgo o sancionado',valor:3,flag:true}], origenId:null },
              { id:'rs_a1_2', texto:'¬øQu√© nivel de acceso tendr√° a sistemas internos?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'Sin acceso',valor:0,flag:false},{texto:'Acceso limitado',valor:1,flag:false},{texto:'Acceso amplio a sistemas cr√≠ticos',valor:3,flag:true}], origenId:null },
            ],
            umbrales: { sinDD:{max:1}, reducida:{min:2,max:4}, ampliada:{min:5} },
            bloqueoRedFlag: true,
            aprobadores: { reducida:'', ampliada:'Carlos Ruiz' }
          },
          ddReducida: {
            preguntas: [
              { id:'dd_r_a1_1', texto:'¬øDispone de pol√≠tica de ciberseguridad documentada?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠, documentada y actualizada',valor:3,flag:false},{texto:'S√≠, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}], origenId:null },
              { id:'dd_r_a1_2', texto:'¬øRealiza auditor√≠as de seguridad peri√≥dicas?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'Anualmente o m√°s',valor:3,flag:false},{texto:'Cada 2-3 a√±os',valor:2,flag:false},{texto:'Nunca',valor:0,flag:true}], origenId:null },
            ]
          },
          ddAmpliada: {
            preguntas: [
              { id:'dd_a_a1_1', texto:'¬øDispone de pol√≠tica de ciberseguridad documentada?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠, documentada y actualizada',valor:3,flag:false},{texto:'S√≠, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}], origenId:null },
              { id:'dd_a_a1_2', texto:'¬øRealiza auditor√≠as de seguridad peri√≥dicas?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'Anualmente o m√°s',valor:3,flag:false},{texto:'Cada 2-3 a√±os',valor:2,flag:false},{texto:'Nunca',valor:0,flag:true}], origenId:null },
              { id:'dd_a_a1_3', texto:'¬øCuenta con seguro de ciberriesgo?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠, con cobertura adecuada',valor:3,flag:false},{texto:'No',valor:0,flag:false}], origenId:null },
              { id:'dd_a_a1_4', texto:'¬øDispone de plan de respuesta a incidentes probado?', tipo:'select_unico', obligatoria:true, opciones:[{texto:'S√≠, probado en los √∫ltimos 12m',valor:3,flag:false},{texto:'Existe pero no se ha probado',valor:1,flag:false},{texto:'No existe',valor:0,flag:true}], origenId:null },
            ]
          }
        }
      },
      {
        id:'a2', nombre:'Compliance', descripcion:'Cumplimiento normativo', responsable:'Carlos Ruiz', color:'#8b5cf6',
        borrador: true,
        cuestionario: {
          scopeCheck: { preguntas:[], umbralMaterial:1 },
          riskScoring: { preguntas:[], umbrales:{ sinDD:{max:1}, reducida:{min:2,max:4}, ampliada:{min:5} }, bloqueoRedFlag:true, aprobadores:{ reducida:'', ampliada:'' } },
          ddReducida: { preguntas:[] },
          ddAmpliada: { preguntas:[] }
        }
      },
      { id:'a3', nombre:'EUDR', descripcion:'EU Deforestation Regulation', responsable:'Laura Torres', color:'#10b981', borrador:true, cuestionario:{ scopeCheck:{preguntas:[],umbralMaterial:1}, riskScoring:{preguntas:[],umbrales:{sinDD:{max:1},reducida:{min:2,max:4},ampliada:{min:5}},bloqueoRedFlag:true,aprobadores:{reducida:'',ampliada:''}}, ddReducida:{preguntas:[]}, ddAmpliada:{preguntas:[]} } },
      { id:'a4', nombre:'Data Protection', descripcion:'Protecci√≥n de datos RGPD', responsable:'Mar√≠a P√©rez', color:'#f59e0b', borrador:true, cuestionario:{ scopeCheck:{preguntas:[],umbralMaterial:1}, riskScoring:{preguntas:[],umbrales:{sinDD:{max:1},reducida:{min:2,max:4},ampliada:{min:5}},bloqueoRedFlag:true,aprobadores:{reducida:'',ampliada:''}}, ddReducida:{preguntas:[]}, ddAmpliada:{preguntas:[]} } },
      { id:'a5', nombre:'ESG', descripcion:'Environmental, Social & Governance', responsable:'Laura Torres', color:'#84cc16', borrador:true, cuestionario:{ scopeCheck:{preguntas:[],umbralMaterial:1}, riskScoring:{preguntas:[],umbrales:{sinDD:{max:1},reducida:{min:2,max:4},ampliada:{min:5}},bloqueoRedFlag:true,aprobadores:{reducida:'',ampliada:''}}, ddReducida:{preguntas:[]}, ddAmpliada:{preguntas:[]} } },
    ],
    biblioteca: [
      { id:'b1', texto:'¬øEl tercero tiene acceso a sistemas o redes internas?', tipo:'select_unico', opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}], etiquetas:['cyber','acceso'], creadoEn:'a1', fase:'scopeCheck' },
      { id:'b2', texto:'¬øProcesa o almacena datos sensibles de la organizaci√≥n?', tipo:'select_unico', opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}], etiquetas:['cyber','datos'], creadoEn:'a1', fase:'scopeCheck' },
      { id:'b3', texto:'¬øEn qu√© regi√≥n est√° domiciliado el tercero?', tipo:'select_unico', opciones:[{texto:'UE / OCDE',valor:1,flag:false},{texto:'Pa√≠s de riesgo medio',valor:2,flag:false},{texto:'Pa√≠s de alto riesgo o sancionado',valor:3,flag:true}], etiquetas:['region','riesgo'], creadoEn:'a1', fase:'riskScoring' },
      { id:'b4', texto:'¬øDispone de pol√≠tica de ciberseguridad documentada?', tipo:'select_unico', opciones:[{texto:'S√≠, documentada y actualizada',valor:3,flag:false},{texto:'S√≠, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}], etiquetas:['cyber','pol√≠tica'], creadoEn:'a1', fase:'ddAmpliada' },
      { id:'b5', texto:'¬øRealiza auditor√≠as de seguridad peri√≥dicas?', tipo:'select_unico', opciones:[{texto:'Anualmente o m√°s',valor:3,flag:false},{texto:'Cada 2-3 a√±os',valor:2,flag:false},{texto:'Nunca',valor:0,flag:true}], etiquetas:['cyber','auditor√≠a'], creadoEn:'a1', fase:'ddAmpliada' },
    ],
    tipos: [
      { id:'tp1', nivel1:'Proveedor', nivel2:'Proveedor Directo', nivel3:'', terceros:['t1','t2','t3'] },
      { id:'tp2', nivel1:'Proveedor', nivel2:'Proveedor Indirecto', nivel3:'', terceros:[] },
      { id:'tp3', nivel1:'Cliente', nivel2:'', nivel3:'', terceros:['t4'] },
    ],
    cuestionarios: [
      {
        id:'cg1', nombre:'Cuestionario General (Base)', tipo:'general', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'q1', texto:'¬øCu√°ntos a√±os lleva la organizaci√≥n en funcionamiento?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'M√°s de 10 a√±os',valor:3,flag:false},{texto:'Entre 5 y 10 a√±os',valor:2,flag:false},{texto:'Menos de 5 a√±os',valor:1,flag:false}] },
          { id:'q2', texto:'¬øDispone de un c√≥digo de conducta publicado y actualizado?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠, publicado y actualizado',valor:3,flag:false},{texto:'S√≠, pero no actualizado',valor:1,flag:false},{texto:'No',valor:0,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'Mar√≠a P√©rez',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cs1', nombre:'Scope Check', tipo:'scope_check', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'s1', texto:'¬øEl valor anual de la relaci√≥n supera los 100.000‚Ç¨?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s2', texto:'¬øEl tercero tiene acceso a datos personales de clientes?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s3', texto:'¬øEl tercero forma parte de la cadena de suministro cr√≠tica?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:1}, nivelRiesgoMedio:{min:2,max:3}, nivelRiesgoAlto:{min:4,max:99},
        umbralMaterial:2, bloqueoRedFlag:false, aprobadores:{alto:'',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cr1', nombre:'Risk Scoring General', tipo:'risk_scoring', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'r1', texto:'¬øEn qu√© regi√≥n est√° domiciliado el tercero?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'UE / OCDE (bajo riesgo)',valor:1,flag:false},{texto:'Pa√≠s de riesgo medio',valor:2,flag:false},{texto:'Pa√≠s de alto riesgo o sancionado',valor:3,flag:true}] },
          { id:'r2', texto:'¬øQu√© nivel de acceso tendr√° a sistemas internos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sin acceso',valor:0,flag:false},{texto:'Acceso limitado / controlado',valor:1,flag:false},{texto:'Acceso amplio a sistemas cr√≠ticos',valor:3,flag:true}] },
          { id:'r3', texto:'¬øExisten antecedentes de incidentes o sanciones conocidos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'No se conocen',valor:0,flag:false},{texto:'Incidentes menores resueltos',valor:1,flag:false},{texto:'Sanciones o incidentes graves',valor:3,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:2}, nivelRiesgoMedio:{min:3,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'c1', nombre:'Cuestionario Cyber', tipo:'due_diligence', ambito:'Cyber', ambito_id:'a1',
        aplicaTodos:true, paises:[], ambitosAplicables:['Cyber'], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'cq1', texto:'¬øDispone de pol√≠tica de ciberseguridad documentada?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠, documentada y actualizada',valor:3,flag:false},{texto:'S√≠, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}] },
          { id:'cq2', texto:'¬øRealiza auditor√≠as de seguridad peri√≥dicas?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Anualmente o m√°s frecuente',valor:3,flag:false},{texto:'Cada 2-3 a√±os',valor:2,flag:false},{texto:'Nunca o no sabe',valor:0,flag:true}] },
          { id:'cq3', texto:'¬øCuenta con seguro de ciberriesgo?', tipo:'select_unico', obligatoria:true, soloCompleta:true, opciones:[{texto:'S√≠, con cobertura adecuada',valor:3,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'Mar√≠a P√©rez',bajo:''},
        creado:'2024-01-15', modificado:'2024-03-10'
      }
    ],
    homologaciones: [],
    plazos: { alto:12, medio:24, bajo:36 },
    planes: [
      { id:'p1', terceroId:'t3', terceroNombre:'Amazon Web Services', titulo:'Auditor√≠a de seguridad Q2 2025', descripcion:'Realizar auditor√≠a completa de controles de seguridad', responsable:'laura.torres@empresa.com', fechaLimite:'2025-06-30', estado:'en_progreso', prioridad:'alta', creado:'2024-12-01' },
      { id:'p2', terceroId:'t1', terceroNombre:'Accenture Spain', titulo:'Revisi√≥n RGPD contractual', descripcion:'Actualizar cl√°usulas de protecci√≥n de datos en contrato', responsable:'maria.perez@empresa.com', fechaLimite:'2025-04-30', estado:'pendiente', prioridad:'media', creado:'2024-11-15' },
    ]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const notify = (msg, type='success') => {
  const n = document.createElement('div');
  n.className = `notification notification-${type}`;
  n.textContent = msg;
  document.getElementById('notifications').appendChild(n);
  setTimeout(() => n.remove(), 3500);
};

const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const fmtDate = d => d ? new Date(d).toLocaleDateString('es-ES') : '‚Äî';
const daysUntil = d => d ? Math.ceil((new Date(d) - new Date()) / 86400000) : null;

const riskBadge = r => ({
  'sin valorar': '<span class="badge risk-tag-sin">Sin valorar</span>',
  'en proceso':  '<span class="badge risk-tag-proceso">En proceso</span>',
  'alto':        '<span class="badge badge-red">Alto</span>',
  'medio':       '<span class="badge badge-amber">Medio</span>',
  'bajo':        '<span class="badge badge-green">Bajo</span>',
}[r] || '<span class="badge badge-gray">‚Äî</span>');

const SVG = {
  plus:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>',
  x:     '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  check: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  drag:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="1" fill="currentColor"/><circle cx="15" cy="7" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="17" r="1" fill="currentColor"/><circle cx="15" cy="17" r="1" fill="currentColor"/></svg>',
  play:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/></svg>',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API PROVIDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_PROVIDERS = {
  sanctionsnetwork: {
    nombre: 'Sanctions Network',
    descripcion: 'OFAC + ONU + UE ‚Äî gratuito, sin registro, sin l√≠mites',
    icono: 'üõ°Ô∏è',
    color: '#ef4444',
    docsUrl: 'https://sanctions.network',
    requiresKey: false,
    fuentes: ['OFAC SDN (USA)', 'UN Security Council', 'EU Financial Sanctions'],
    autoSelectRule: (result) => {
      if (!result.hits) return { opcionIdx: 0, justificacion: 'Sin coincidencias en OFAC, ONU ni UE' };
      const maxScore = result.topHit?.similarityScore || 0;
      if (maxScore >= 0.85) return { opcionIdx: 2, justificacion: `Coincidencia fuerte ‚Äî score ${(maxScore*100).toFixed(0)}% en ${result.topHit?.source?.toUpperCase()}` };
      return { opcionIdx: 1, justificacion: `${result.hits} coincidencia(s) parcial(es) ‚Äî score m√°x. ${(maxScore*100).toFixed(0)}%` };
    },
    defaultOpciones: [
      { texto: 'Sin coincidencias (OFAC + ONU + UE)', valor: 3, flag: false },
      { texto: 'Coincidencia parcial ‚Äî requiere verificaci√≥n manual', valor: 1, flag: false },
      { texto: 'Coincidencia fuerte en lista de sanciones', valor: 0, flag: true }
    ]
  },
  opencorporates: {
    nombre: 'OpenCorporates',
    descripcion: 'Datos registrales de empresas en +140 pa√≠ses',
    icono: 'üè¢',
    color: '#3b82f6',
    docsUrl: 'https://api.opencorporates.com/',
    requiresKey: false,
    fuentes: ['Registros mercantiles de +140 pa√≠ses'],
    autoSelectRule: (result) => {
      if (!result.hits) return { opcionIdx: 0, justificacion: 'Sin datos registrales encontrados' };
      return { opcionIdx: 1, justificacion: `${result.hits} empresa(s) en registros ‚Äî ${result.topHit?.pais?.toUpperCase()||''}` };
    },
    defaultOpciones: [
      { texto: 'Sin datos registrales encontrados', valor: 1, flag: false },
      { texto: 'Empresa verificada en registros p√∫blicos', valor: 3, flag: false }
    ]
  },
  opensanctions: {
    nombre: 'OpenSanctions',
    descripcion: '+100 fuentes de sanciones ‚Äî requiere API key (trial 30 d√≠as)',
    icono: 'üîë',
    color: '#f59e0b',
    docsUrl: 'https://www.opensanctions.org/docs/api/',
    requiresKey: true,
    fuentes: ['OFAC', 'UE', 'ONU', 'Interpol', '+100 fuentes m√°s'],
    autoSelectRule: (result) => {
      if (result.score >= 0.85) return { opcionIdx: 2, justificacion: `Coincidencia fuerte ‚Äî score ${result.score.toFixed(2)}` };
      if (result.score >= 0.6)  return { opcionIdx: 1, justificacion: `Coincidencia parcial ‚Äî score ${result.score.toFixed(2)}` };
      return { opcionIdx: 0, justificacion: `Sin coincidencias (score ${result.score?.toFixed(2)||'0.00'})` };
    },
    defaultOpciones: [
      { texto: 'Sin coincidencias en listas de sanciones', valor: 3, flag: false },
      { texto: 'Coincidencia parcial ‚Äî requiere verificaci√≥n', valor: 1, flag: false },
      { texto: 'Coincidencia fuerte en listas de sanciones', valor: 0, flag: true }
    ]
  },
  custom: {
    nombre: 'API Personalizada',
    descripcion: 'Conecta cualquier API REST propia o de terceros',
    icono: '‚öôÔ∏è',
    color: '#8b5cf6',
    docsUrl: '',
    requiresKey: false,
    fuentes: ['Tu fuente personalizada'],
    autoSelectRule: () => ({ opcionIdx: 0, justificacion: 'Resultado manual' }),
    defaultOpciones: [
      { texto: 'Resultado satisfactorio', valor: 3, flag: false },
      { texto: 'Resultado no satisfactorio', valor: 0, flag: true }
    ]
  }
};

const API_KEYS = {};

function closeModal() { document.querySelector('.modal-backdrop')?.remove(); }

function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('tprm_theme', isLight ? 'light' : 'dark');
  updateThemeUI(isLight);
}
function updateThemeUI(isLight) {
  const icon  = document.getElementById('theme-icon');
  const label = document.getElementById('theme-label');
  const track = document.getElementById('theme-track');
  const thumb = document.getElementById('theme-thumb');
  if (!icon) return;
  if (isLight) {
    icon.textContent  = '‚òÄÔ∏è';
    label.textContent = 'Modo claro';
    track.style.background = 'var(--accent)';
    thumb.style.left = '16px';
    thumb.style.background = '#fff';
  } else {
    icon.textContent  = 'üåô';
    label.textContent = 'Modo oscuro';
    track.style.background = 'var(--border2)';
    thumb.style.left = '2px';
    thumb.style.background = 'var(--text3)';
  }
}
(function() {
  const saved = localStorage.getItem('tprm_theme');
  const prefersLight = window.matchMedia?.('(prefers-color-scheme: light)').matches;
  const useLight = saved ? saved === 'light' : prefersLight;
  if (useLight) document.documentElement.classList.add('light');
  document.addEventListener('DOMContentLoaded', () => updateThemeUI(useLight));
  if (document.readyState !== 'loading') updateThemeUI(useLight);
})();

function openModal(html) {
  closeModal();
  const bd = document.createElement('div');
  bd.className = 'modal-backdrop';
  bd.innerHTML = html;
  bd.addEventListener('click', e => { if (e.target === bd) closeModal(); });
  document.getElementById('modals').appendChild(bd);
}

async function saveItem(col, item) {
  state.data[col] = state.data[col] || [];
  const idx = state.data[col].findIndex(x => x.id === item.id);
  if (idx >= 0) state.data[col][idx] = item; else state.data[col].push(item);
  if (FS.enabled) FS.set(col, item.id, item).catch(e => console.warn('FS save:', e));
}
async function deleteItem(col, id) {
  state.data[col] = state.data[col].filter(x => x.id !== id);
  if (FS.enabled) FS.delete(col, id).catch(e => console.warn('FS delete:', e));
}

function renderChipGroup(items, selected, name) {
  return items.map(item => {
    const isSel = selected.includes(item.value) ? '1' : '0';
    const dot = item.color ? `<span class="chip-dot" style="background:${item.color}"></span>` : '';
    return `<span class="chip" data-sel="${isSel}" data-value="${item.value}" data-group="${name}" onclick="toggleChip(this)">${dot}${item.label}</span>`;
  }).join('');
}

function toggleChip(el) { el.dataset.sel = el.dataset.sel === '1' ? '0' : '1'; }
function getChipValues(groupName) { return [...document.querySelectorAll(`.chip[data-group="${groupName}"][data-sel="1"]`)].map(el => el.dataset.value); }

const pageTitles = { dashboard:'Dashboard', terceros:'Maestro de Terceros', homologaciones:'Homologaciones', planes:'Planes de Acci√≥n', usuarios:'Usuarios y Roles', ambitos:'√Åmbitos de Riesgo', tipos:'Tipos de Tercero', cuestionarios:'Cuestionarios', plazos:'Plazos de Renovaci√≥n' };

function navigate(page) {
  state.currentPage = page;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.page === page));
  const titleEl = document.getElementById('topbar-title');
  if (titleEl) titleEl.textContent = pageTitles[page] || page;
  ({ dashboard:renderDashboard, terceros:renderTerceros, homologaciones:renderHomologaciones, planes:renderPlanes, usuarios:renderUsuarios, ambitos:renderAmbitos, tipos:renderTipos, cuestionarios:renderCuestionarios, plazos:renderPlazos, biblioteca:renderBiblioteca })[page]?.();
}

const FS = {
  projectId: 'tprm-f4525',
  apiKey:    'AIzaSyDDSXh3FsO6TfrAtx1WhSiIRCSDZHHSZmA',
  enabled:   false,
  _url(col, id) {
    const base = `https://firestore.googleapis.com/v1/projects/${this.projectId}/databases/(default)/documents/${col}`;
    return id ? `${base}/${id}?key=${this.apiKey}` : `${base}?key=${this.apiKey}&pageSize=500`;
  },
  _toVal(v) {
    if (v === null || v === undefined) return { nullValue: null };
    if (typeof v === 'boolean')  return { booleanValue: v };
    if (typeof v === 'number')   return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
    if (typeof v === 'string')   return { stringValue: v };
    if (Array.isArray(v))        return { arrayValue: { values: v.map(x => this._toVal(x)) } };
    if (typeof v === 'object')   return { mapValue: { fields: this._toFields(v) } };
    return { stringValue: String(v) };
  },
  _toFields(obj) {
    const f = {};
    for (const [k, v] of Object.entries(obj)) f[k] = this._toVal(v);
    return f;
  },
  _fromVal(v) {
    if ('nullValue'    in v) return null;
    if ('booleanValue' in v) return v.booleanValue;
    if ('integerValue' in v) return Number(v.integerValue);
    if ('doubleValue'  in v) return v.doubleValue;
    if ('stringValue'  in v) return v.stringValue;
    if ('arrayValue'   in v) return (v.arrayValue.values || []).map(x => this._fromVal(x));
    if ('mapValue'     in v) return this._fromFields(v.mapValue.fields || {});
    return null;
  },
  _fromFields(fields) {
    const obj = {};
    for (const [k, v] of Object.entries(fields)) obj[k] = this._fromVal(v);
    return obj;
  },
  async set(col, id, obj) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fields: this._toFields(obj) })
    });
  },
  async delete(col, id) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), { method: 'DELETE' });
  },
  async list(col) {
    const r = await fetch(this._url(col));
    const json = await r.json();
    return (json.documents || []).map(doc => {
      const obj = this._fromFields(doc.fields || {});
      if (!obj.id) obj.id = doc.name.split('/').pop();
      return obj;
    });
  },
  async init() {
    try {
      const r = await fetch(this._url('terceros') + '&pageSize=1');
      if (!r.ok) throw new Error(r.status);
      this.enabled = true;
      const cols = ['terceros','usuarios','ambitos','tipos','cuestionarios','planes','homologaciones'];
      for (const col of cols) {
        try {
          const docs = await this.list(col);
          if (docs.length > 0) state.data[col] = docs;
        } catch(e) {}
      }
    } catch(e) {}
  }
};

function renderDashboard() {
  const t = state.data.terceros;
  const total = t.length;
  const altos  = t.filter(x => x.riesgo==='alto').length;
  const medios = t.filter(x => x.riesgo==='medio').length;
  const bajos  = t.filter(x => x.riesgo==='bajo').length;
  const sinVal = t.filter(x => !x.riesgo || x.riesgo==='sin valorar').length;
  const enProceso = state.data.homologaciones.filter(h => h.estadoGlobal !== 'completada').length;
  const homologados = t.filter(x => ['alto','medio','bajo'].includes(x.riesgo)).length;
  const pendRenovacion = t.filter(x => { const d=daysUntil(x.fechaSiguiente); return d!==null && d<=90 && d>0; }).length;
  const vencidos = t.filter(x => { const d=daysUntil(x.fechaSiguiente); return d!==null && d<=0; }).length;
  const myTasks = getMyTasks();

  const dominios = getDominiosActivos();
  const domStats = dominios.map(d => {
    const homs = state.data.homologaciones;
    const materiales = homs.filter(h => h.dominios?.[d.id]?.scopeResultado === 'material').length;
    const ddCompletas = homs.filter(h => h.dominios?.[d.id]?.dd?.estado === 'completado').length;
    const aprobados  = homs.filter(h => h.dominios?.[d.id]?.aprobacion?.estado === 'aprobado').length;
    return { ...d, materiales, ddCompletas, aprobados, total: homs.length };
  }).filter(d => d.total > 0);

  const upcoming = t.filter(x => { const d=daysUntil(x.fechaSiguiente); return d!==null && d<=90 && d>0; })
    .sort((a,b)=>new Date(a.fechaSiguiente)-new Date(b.fechaSiguiente)).slice(0,5);

  document.getElementById('content').innerHTML = `
    <div class="dash-kpi-grid">
      ${[
        ['Total Terceros', total, 'var(--accent)', `${homologados} homologados`],
        ['En Proceso', enProceso, 'var(--amber)', 'homologaciones activas'],
        ['Riesgo Alto', altos, 'var(--red)', `${total?Math.round(altos/total*100):0}% del total`],
        ['Riesgo Medio', medios, 'var(--amber)', `${total?Math.round(medios/total*100):0}% del total`],
        ['Riesgo Bajo', bajos, 'var(--green)', `${total?Math.round(bajos/total*100):0}% del total`],
        ['Sin Valorar', sinVal, 'var(--text3)', 'pendientes de proceso'],
        ['Renovaci√≥n ‚â§90d', pendRenovacion, pendRenovacion>0?'var(--amber)':'var(--text3)', `${vencidos} vencidas`],
      ].map(([l,v,c,s]) => `
        <div class="dash-kpi">
          <div class="dash-kpi-value" style="color:${c}">${v}</div>
          <div class="dash-kpi-label">${l}</div>
          <div class="dash-kpi-sub">${s}</div>
        </div>`).join('')}
    </div>

    <div style="margin-bottom:20px">
      <div class="dash-section-title">
        üì• Mis tareas ‚Äî ${getCurrentUser()}
        ${myTasks.length ? `<span style="background:var(--red);color:white;font-size:10px;font-weight:700;padding:1px 8px;border-radius:10px">${myTasks.length}</span>` : ''}
      </div>
      ${myTasks.length ? `
        <div style="display:flex;flex-direction:column;gap:6px">
          ${myTasks.slice(0,5).map(task => {
            const urgColor = task.urgencia==='alta'?'var(--red)':'var(--amber)';
            return `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-left:4px solid ${urgColor};border-radius:var(--radius)">
              ${task.domColor?`<span style="width:8px;height:8px;border-radius:50%;background:${task.domColor};flex-shrink:0"></span>`:''}
              <div style="flex:1;min-width:0">
                <span style="font-weight:600;font-size:13px">${task.label}</span>
                <span style="font-size:11px;color:var(--text3);margin-left:8px">${task.terceroNombre} ¬∑ ${task.detalle}</span>
              </div>
              <button class="btn btn-primary btn-sm" onclick="navigate('homologaciones');setTimeout(()=>resumeHomTask('${task.homId}','${task.tipo}'),100)">Iniciar ‚Üí</button>
            </div>`;
          }).join('')}
        </div>` : `<div style="padding:12px 16px;background:var(--green-soft);border:1px solid rgba(16,185,129,.2);border-radius:var(--radius);font-size:13px;color:var(--green)">‚úì Sin tareas pendientes</div>`}
    </div>

    <div class="dash-two-col">
      <div class="card">
        <div class="card-title">Estado por Dominio</div>
        ${domStats.length ? domStats.map(d => {
          const pct = d.materiales > 0 ? Math.round(d.aprobados / d.materiales * 100) : 0;
          return `<div class="dash-domain-bar">
            <span style="width:8px;height:8px;border-radius:50%;background:${d.color};flex-shrink:0"></span>
            <span style="font-size:13px;font-weight:500;min-width:90px">${d.nombre}</span>
            <div class="dash-domain-progress"><div class="dash-domain-progress-fill" style="width:${pct}%;background:${d.color}"></div></div>
            <span style="font-size:11px;color:var(--text3);text-align:right">${d.aprobados}/${d.materiales} aprobados</span>
          </div>`;
        }).join('') : '<p style="font-size:12px;color:var(--text3)">Inicia homologaciones para ver estad√≠sticas.</p>'}
      </div>

      <div class="card">
        <div class="card-title">Pr√≥ximas Renovaciones <span class="badge badge-amber" style="margin-left:6px">${upcoming.length}</span></div>
        ${upcoming.length ? `<table>
          <thead><tr><th>Tercero</th><th>Fecha</th><th>D√≠as</th><th>Riesgo</th></tr></thead>
          <tbody>${upcoming.map(ter => {
            const d = daysUntil(ter.fechaSiguiente);
            return `<tr>
              <td style="font-weight:500;cursor:pointer;color:var(--accent)" onclick="navigate('terceros')">${ter.nombre}</td>
              <td style="color:var(--text3);font-size:12px">${fmtDate(ter.fechaSiguiente)}</td>
              <td><span class="badge ${d<=30?'badge-red':'badge-amber'}">${d}d</span></td>
              <td>${riskBadge(ter.riesgo)}</td>
            </tr>`;
          }).join('')}</tbody>
        </table>` : '<p style="color:var(--text3);font-size:12px">Sin homologaciones pr√≥ximas.</p>'}
      </div>
    </div>
  `;
}

let terFilter = { search:'', riesgo:'', ambito:'', pais:'', tipo:'' };
let terSort = { col:'nombre', dir:'asc' };

function terSortBy(col) {
  if (terSort.col === col) terSort.dir = terSort.dir === 'asc' ? 'desc' : 'asc';
  else { terSort.col = col; terSort.dir = 'asc'; }
  renderTerceros();
}

function renderTerceros() {
  let terceros = state.data.terceros.filter(t => {
    const s = terFilter.search.toLowerCase();
    if (s && !t.nombre.toLowerCase().includes(s) && !(t.cif||'').toLowerCase().includes(s)) return false;
    if (terFilter.riesgo && t.riesgo !== terFilter.riesgo) return false;
    if (terFilter.ambito && !(t.ambitos||[]).includes(terFilter.ambito)) return false;
    if (terFilter.pais && t.pais !== terFilter.pais) return false;
    if (terFilter.tipo && t.tipo !== terFilter.tipo) return false;
    return true;
  });

  const col = terSort.col, dir = terSort.dir === 'asc' ? 1 : -1;
  const getVal = (t) => {
    if (col === 'nombre') return (t.nombre||'').toLowerCase();
    if (col === 'cif') return (t.cif||'').toLowerCase();
    if (col === 'pais') return (t.pais||'').toLowerCase();
    if (col === 'tipo') return (t.tipo||'').toLowerCase();
    if (col === 'responsable') return (t.responsable||'').toLowerCase();
    if (col === 'riesgo') return ['alto','medio','bajo','en proceso','sin valorar'].indexOf(t.riesgo||'sin valorar');
    if (col === 'fechaSiguiente') return t.fechaSiguiente || 'zzz';
    return '';
  };
  terceros = [...terceros].sort((a,b) => {
    const va = getVal(a), vb = getVal(b);
    return va < vb ? -dir : va > vb ? dir : 0;
  });

  const paises = [...new Set(state.data.terceros.map(t=>t.pais).filter(Boolean))].sort();
  const tipos = [...new Set(state.data.terceros.map(t=>t.tipo).filter(Boolean))].sort();

  const si = (c) => terSort.col !== c ? `<span style="opacity:.25;margin-left:4px">‚áÖ</span>` : `<span style="margin-left:4px;color:var(--accent)">${terSort.dir==='asc'?'‚Üë':'‚Üì'}</span>`;
  const th = (c, label) => `<th style="cursor:pointer;user-select:none;white-space:nowrap" onclick="terSortBy('${c}')">${label}${si(c)}</th>`;

  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Maestro de Terceros</div><div class="section-sub">${terceros.length} de ${state.data.terceros.length} terceros</div></div>
      <button class="btn btn-primary" onclick="showTerceroModal(null)">${SVG.plus} Dar de Alta Tercero</button>
    </div>
    <div class="toolbar">
      <div class="search-bar" style="flex:1;max-width:280px">${SVG.search}<input placeholder="Nombre o CIF..." oninput="terFilter.search=this.value;renderTerceros()" value="${terFilter.search}"></div>
      <select class="form-select" style="width:auto" onchange="terFilter.tipo=this.value;renderTerceros()">
        <option value="">Todos los tipos</option>
        ${tipos.map(tp=>`<option value="${tp}" ${terFilter.tipo===tp?'selected':''}>${tp}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.riesgo=this.value;renderTerceros()">
        <option value="">Todos los riesgos</option>
        ${['sin valorar','en proceso','alto','medio','bajo'].map(r=>`<option value="${r}" ${terFilter.riesgo===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}
      </select>
      <button class="btn btn-ghost btn-sm" onclick="terFilter={search:'',riesgo:'',ambito:'',pais:'',tipo:''};renderTerceros()">‚úï Limpiar</button>
    </div>
    <div class="card" style="padding:0;">
      <div class="table-wrap">
        <table>
          <thead><tr>
            ${th('nombre','Nombre')}
            ${th('cif','CIF')}
            ${th('pais','Pa√≠s')}
            ${th('tipo','Tipo')}
            <th>√Åmbitos</th>
            ${th('responsable','Responsable')}
            ${th('fechaSiguiente','Sig. Homologaci√≥n')}
            ${th('riesgo','Riesgo')}
            <th>Estado Hom.</th>
            <th>Acciones</th>
          </tr></thead>
          <tbody>
            ${terceros.map(t => {
              const d = daysUntil(t.fechaSiguiente);
              const activeHom = getActiveHom(t.id);
              const phase = activeHom ? activeHom.fase : (getLastHom(t.id)?.fase || 'pendiente');
              return `<tr>
                <td><div style="font-weight:500">${t.nombre}</div><div style="font-size:11px;color:var(--text3)">${t.denominacion||''}</div></td>
                <td><code style="font-size:11px">${t.cif||'‚Äî'}</code></td>
                <td>${t.pais||'‚Äî'}</td>
                <td><span class="badge badge-blue">${t.tipo||'‚Äî'}</span></td>
                <td><div style="display:flex;flex-wrap:wrap;gap:3px">${(t.ambitos||[]).map(a=>`<span class="badge badge-gray">${a}</span>`).join('')}</div></td>
                <td>${t.responsable||'‚Äî'}</td>
                <td>${fmtDate(t.fechaSiguiente)}</td>
                <td>${riskBadge(t.riesgo)}</td>
                <td>${homBadge(phase, activeHom?.id)}</td>
                <td>
                  <div style="display:flex;gap:4px;">
                    <button class="btn btn-success btn-sm" onclick="iniciarHom('${t.id}')">${SVG.play} ${activeHom?'Continuar':'Homologar'}</button>
                    <button class="btn btn-ghost btn-icon btn-sm" onclick="showTerceroModal('${t.id}')">${SVG.edit}</button>
                  </div>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function showTerceroModal(id) {
  const t = id ? state.data.terceros.find(x=>x.id===id) : null;
  const isNew = !t;
  const hom = id ? getActiveHom(id) || getLastHom(id) : null;
  openModal(`
    <div class="modal modal-xl">
      <div class="modal-header">
        <div class="modal-title">${isNew ? 'Dar de Alta' : 'Editar: ' + t.nombre}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="tabs" id="t-tabs">
          <div class="tab active" onclick="switchTab('datos')">Datos Generales</div>
          <div class="tab" onclick="switchTab('comentarios')">Comentarios</div>
          ${!isNew ? `<div class="tab" onclick="switchTab('homologacion')">Estado Homologaci√≥n</div>` : ''}
        </div>
        <div id="ttab-datos">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="t-nombre" value="${t?.nombre||''}"></div>
            <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="t-cif" value="${t?.cif||''}"></div>
            <div class="form-group"><label class="form-label">Pa√≠s</label><input class="form-input" id="t-pais" value="${t?.pais||''}"></div>
            <div class="form-group"><label class="form-label">Responsable</label>
              <select class="form-select" id="t-responsable">
                <option value="">Seleccionar...</option>
                ${state.data.usuarios.map(u=>`<option value="${u.nombre}" ${t?.responsable===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
        <div id="ttab-comentarios" style="display:none">
          <textarea class="form-textarea" id="t-comentarios" rows="5">${t?.comentarios||''}</textarea>
        </div>
        <div id="ttab-homologacion" style="display:none">
          ${hom ? `<div class="info-box">Homologaci√≥n iniciada el ${fmtDate(hom.fechaInicio)}. Riesgo actual: ${riskBadge(t?.riesgo)}</div>` : 'Sin procesos activos.'}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveTercero('${id||''}')">${SVG.check} Guardar</button>
      </div>
    </div>
  `);
}

function switchTab(name) {
  ['datos','comentarios','homologacion'].forEach(t => { const el = document.getElementById('ttab-'+t); if (el) el.style.display = t===name?'block':'none'; });
  document.querySelectorAll('#t-tabs .tab').forEach(el => { el.classList.toggle('active', el.getAttribute('onclick').includes(name)); });
}

async function saveTercero(id) {
  const nombre = document.getElementById('t-nombre')?.value.trim();
  if (!nombre) return notify('Nombre obligatorio', 'error');
  const existing = id ? state.data.terceros.find(x=>x.id===id) : null;
  const item = { ...existing, id: id||genId(), nombre, cif: document.getElementById('t-cif').value, pais: document.getElementById('t-pais').value, responsable: document.getElementById('t-responsable').value, comentarios: document.getElementById('t-comentarios').value, activo:true };
  await saveItem('terceros', item);
  notify('Guardado'); closeModal(); renderTerceros();
}

function renderPlanes() {
  const planes = state.data.planes || [];
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div><div class="section-title">Planes de Acci√≥n</div></div><button class="btn btn-primary" onclick="showPlanModal(null)">${SVG.plus} Nuevo Plan</button></div>
    <div class="stats-grid">
      ${['pendiente','en_progreso','completado'].map(s => `<div class="stat-card"><div class="stat-label">${s.toUpperCase()}</div><div class="stat-value">${planes.filter(p=>p.estado===s).length}</div></div>`).join('')}
    </div>
    ${planes.map(p => `<div class="action-plan-card"><strong>${p.titulo}</strong><br><span style="font-size:12px;color:var(--text3)">${p.terceroNombre} ¬∑ ${p.prioridad.toUpperCase()}</span></div>`).join('')}
  `;
}
function showPlanModal() { notify('Funci√≥n b√°sica en esta vista'); }

function renderUsuarios() {
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div><div class="section-title">Usuarios y Roles</div></div><button class="btn btn-primary" onclick="showUsuarioModal(null)">${SVG.plus} Nuevo Usuario</button></div>
    <div class="card" style="padding:0"><table>
      <thead><tr><th>Nombre</th><th>Email</th><th>Roles</th><th>Acciones</th></tr></thead>
      <tbody>${state.data.usuarios.map(u => `<tr><td>${u.nombre}</td><td>${u.email}</td><td>${u.roles.join(', ')}</td><td><button class="btn btn-ghost btn-sm" onclick="showUsuarioModal('${u.id}')">${SVG.edit}</button></td></tr>`).join('')}</tbody>
    </table></div>
  `;
}
function showUsuarioModal(id) {
  const u = id ? state.data.usuarios.find(x=>x.id===id) : null;
  openModal(`<div class="modal"><div class="modal-header"><div class="modal-title">Usuario</div></div><div class="modal-body"><input class="form-input" id="u-nombre" value="${u?.nombre||''}" placeholder="Nombre"></div><div class="modal-footer"><button class="btn btn-primary" onclick="closeModal()">Cerrar</button></div></div>`);
}

function renderAmbitos() {
  const doms = state.data.ambitos;
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div><div class="section-title">Dominios de Riesgo</div></div><button class="btn btn-primary" onclick="openDomainWizard(null)">${SVG.plus} Nuevo Dominio</button></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">${doms.map(d => renderDomainCard(d)).join('')}</div>
  `;
}

function renderDomainCard(d) {
  return `<div class="domain-card"><div class="domain-card-head" style="border-left:4px solid ${d.color}"><div style="font-weight:700">${d.nombre}</div></div><div style="padding:12px 18px"><button class="btn btn-primary btn-sm" onclick="openDomainWizard('${d.id}')">Editar</button></div></div>`;
}

let DW = {};
function openDomainWizard(id) {
  const d = id ? state.data.ambitos.find(x=>x.id===id) : null;
  DW = { id: id||null, nombre: d?.nombre||'', color: d?.color||'#3b82f6', cuestionario: d?.cuestionario || { scopeCheck:{preguntas:[],umbralMaterial:1}, riskScoring:{preguntas:[],umbrales:{sinDD:{max:1},reducida:{min:2,max:4},ampliada:{min:5}},aprobadores:{reducida:'',ampliada:''}}, dd:{preguntas:[]} } };
  openModal(`<div class="modal"><div class="modal-header"><div class="modal-title">Dominio</div></div><div class="modal-body"><input class="form-input" id="dw-nombre" value="${DW.nombre}"></div><div class="modal-footer"><button class="btn btn-primary" onclick="dwSave()">Guardar</button></div></div>`);
}
async function dwSave() {
  const n = document.getElementById('dw-nombre').value;
  const item = { ...DW, id: DW.id||genId(), nombre: n, borrador:false };
  await saveItem('ambitos', item); closeModal(); renderAmbitos();
}

function renderTipos() { document.getElementById('content').innerHTML = '<div class="section-title">Tipos de Tercero</div>'; }
function renderCuestionarios() { document.getElementById('content').innerHTML = '<div class="section-title">Cuestionarios</div>'; }
function renderBiblioteca() { document.getElementById('content').innerHTML = '<div class="section-title">Biblioteca</div>'; }

const addMonths = (date, m) => { const d = new Date(date); d.setMonth(d.getMonth() + m); return d.toISOString().split('T')[0]; };

function homBadge(fase, homId) {
  const h = homId ? state.data.homologaciones.find(x => x.id === homId) : null;
  if (h && h.estadoGlobal !== 'completada' && h.scopeCheck?.estado === 'completado') {
    return '<span class="hom-status hom-aprobacion">En aprobaci√≥n</span>';
  }
  return ({
    pendiente:   '<span class="hom-status hom-pendiente">Sin iniciar</span>',
    fuera_scope: '<span class="hom-status hom-fuera">Fuera de scope</span>',
    scope_check: '<span class="hom-status hom-scope">üîç Scope Check</span>',
    risk_scoring:'<span class="hom-status hom-scoring">üìä Risk Scoring</span>',
    due_diligence:'<span class="hom-status hom-dd">üìã Due Diligence</span>',
    aprobacion:  '<span class="hom-status hom-aprobacion">‚è≥ Aprobaci√≥n</span>',
    completada:  '<span class="hom-status hom-completada">‚úÖ Homologado</span>',
  }[fase] || '<span class="hom-status hom-pendiente">‚Äî</span>');
}

function getActiveHom(tid) { return state.data.homologaciones.find(h => h.terceroId === tid && h.estadoGlobal !== 'completada'); }
function getLastHom(tid) { return state.data.homologaciones.filter(h => h.terceroId === tid).sort((a,b) => new Date(b.fechaInicio)-new Date(a.fechaInicio))[0]; }

function getDominiosActivos() { return (state.data.ambitos||[]).filter(a => !a.borrador); }

function homGetOrCreate(terceroId) {
  let hom = getActiveHom(terceroId);
  if (!hom) {
    const doms = {};
    getDominiosActivos().forEach(d => doms[d.id] = { scopeResultado:'pendiente', riskScoring:{estado:'pendiente',respuestas:{}}, dd:{estado:'pendiente',respuestas:{}}, aprobacion:{estado:'pendiente'} });
    hom = { id: genId(), terceroId, terceroNombre: state.data.terceros.find(t=>t.id===terceroId).nombre, estadoGlobal: 'en_curso', fechaInicio: new Date().toISOString().split('T')[0], dominios: doms, scopeCheck:{estado:'pendiente',respuestasPorDominio:{}} };
    state.data.homologaciones.push(hom);
  }
  return hom;
}

function homCalcRSNivel(dominio, score, hasFlag) {
  const u = dominio.cuestionario?.riskScoring?.umbrales || { sinDD:{max:1}, reducida:{min:2,max:4}, ampliada:{min:5} };
  if (hasFlag && dominio.cuestionario?.riskScoring?.bloqueoRedFlag) return 'ampliada';
  if (score <= (u.sinDD?.max ?? 1)) return 'sinDD';
  if (score <= (u.reducida?.max ?? 4)) return 'reducida';
  return 'ampliada';
}

function homCalcScoreGeneric(preguntas, respuestas) {
  let score = 0, hasFlag = false;
  preguntas.forEach(p => {
    const resp = respuestas[p.id];
    const op = (p.opciones||[]).find(o => o.texto === resp);
    if (op) { score += op.valor||0; if (op.flag) hasFlag = true; }
  });
  return { score, hasFlag };
}

function homGlobalStatus(hom) {
  if (hom.estadoGlobal === 'completada') return 'completada';
  if (hom.scopeCheck.estado !== 'completado') return 'scope_check';
  return 'en_progreso';
}

let HW = {};
let hwAutosaveTimer = null;

function hwStartAutosave() {
  hwStopAutosave();
  hwAutosaveTimer = setInterval(async () => { if (HW.hom) await saveItem('homologaciones', HW.hom); }, 5000);
}
function hwStopAutosave() { if (hwAutosaveTimer) { clearInterval(hwAutosaveTimer); hwAutosaveTimer = null; } }

function iniciarHom(terceroId) {
  HW = { hom: homGetOrCreate(terceroId), tercero: state.data.terceros.find(t => t.id === terceroId) };
  openHWPanel();
}

function openHWPanel() {
  openModal(`
    <div class="modal hom-session-modal">
      <div class="modal-header">
        <div><div class="modal-title">Homologaci√≥n ‚Äî ${HW.tercero.nombre}</div></div>
        <button class="btn btn-ghost btn-icon" onclick="hwClose()">${SVG.x}</button>
      </div>
      <div style="flex:1;overflow-y:auto;padding:20px 24px" id="hw-body">${renderHWBody()}</div>
    </div>
  `);
  hwStartAutosave();
}

function hwClose() { hwStopAutosave(); if (HW.hom) saveItem('homologaciones', HW.hom); closeModal(); navigate(state.currentPage); }

function renderHWBody() {
  const hom = HW.hom;
  const doms = getDominiosActivos();
  const scDone = hom.scopeCheck.estado === 'completado';
  
  const tableRows = doms.map(d => {
    const dom = hom.dominios[d.id] || {};
    const rs = dom.riskScoring;
    const apr = dom.aprobacion;
    const aprLabel = d.cuestionario?.riskScoring?.aprobadores?.[rs?.nivel] || '';
    
    return `<tr>
      <td>${d.nombre}</td>
      <td>${dom.scopeResultado}</td>
      <td>${rs?.estado||'pendiente'}</td>
      <td>${dom.dd?.estado||'‚Äî'}</td>
      <td>${apr?.estado === 'aprobado' ? '‚úì ' + apr.aprobadoPor : (aprLabel ? '‚è≥ ' + aprLabel : '‚Äî')}</td>
    </tr>`;
  }).join('');

  const materiales = doms.filter(d => hom.dominios[d.id]?.scopeResultado === 'material');
  const ddDone = scDone && materiales.every(d => hom.dominios[d.id]?.dd?.estado === 'completado');

  return `
    <div class="card" style="padding:0;margin-bottom:20px">
      <table class="hom-domain-table">
        <thead><tr><th>Dominio</th><th>Scope</th><th>Scoring</th><th>DD</th><th>Aprobaci√≥n</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="openScopeCheckSession()">üîç Scope Check</button>
      <button class="btn btn-secondary" onclick="openRiskScoringSession()" ${!scDone?'disabled':''}>üìä Risk Scoring</button>
      <button class="btn btn-secondary" onclick="openDDSession()" ${!scDone?'disabled':''}>üìã Due Diligence</button>
      ${ddDone ? `<button class="btn btn-primary" onclick="openAprobacionPanel()">‚úÖ Gestionar Aprobaciones</button>` : ''}
    </div>
  `;
}

function openScopeCheckSession() {
  const doms = getDominiosActivos();
  HW.scActiveDom = doms[0].id;
  openModal(`<div class="modal"><div class="modal-header">Scope Check</div><div class="modal-body" id="sc-body">${renderSCBody(doms)}</div><div class="modal-footer"><button class="btn btn-primary" onclick="hwCompletarSC()">Finalizar</button></div></div>`);
}
function renderSCBody(doms) {
  const d = doms.find(x=>x.id===HW.scActiveDom);
  return `<div>Preguntas para ${d.nombre}...<br><label><input type="radio" name="sc-mock" value="material" checked> Es Material</label></div>`;
}
async function hwCompletarSC() {
  getDominiosActivos().forEach(d => HW.hom.dominios[d.id].scopeResultado = 'material');
  HW.hom.scopeCheck.estado = 'completado';
  HW.hom.fase = 'risk_scoring';
  await saveItem('homologaciones', HW.hom); closeModal(); openHWPanel();
}

function openRiskScoringSession() {
  getDominiosActivos().forEach(d => { HW.hom.dominios[d.id].riskScoring = { estado:'completado', nivel:'reducida', score:3 }; });
  HW.hom.fase = 'due_diligence';
  notify('Mock: Scoring completado'); openHWPanel();
}

function openDDSession() {
  getDominiosActivos().forEach(d => { HW.hom.dominios[d.id].dd = { estado:'completado' }; });
  HW.hom.fase = 'aprobacion';
  notify('Mock: DD completada'); openHWPanel();
}

function openAprobacionPanel() {
  const me = getCurrentUser();
  const doms = getDominiosActivos().filter(d => {
    const dom = HW.hom.dominios[d.id];
    const aprReq = d.cuestionario?.riskScoring?.aprobadores?.[dom?.riskScoring?.nivel];
    return dom?.dd?.estado === 'completado' && aprReq && dom.aprobacion?.estado !== 'aprobado';
  });

  openModal(`
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Aprobaciones</div></div>
      <div class="modal-body">
        ${doms.map(d => {
          const aprobador = d.cuestionario?.riskScoring?.aprobadores?.[HW.hom.dominios[d.id].riskScoring.nivel];
          const esMio = aprobador === me;
          return `<div style="padding:10px;border:1px solid var(--border);margin-bottom:10px">
            <strong>${d.nombre}</strong> (Aprobador: ${aprobador})<br>
            ${esMio ? `<button class="btn btn-success btn-sm" onclick="hwAprobarDominio('${d.id}')">Aprobar</button>` : `<small>Solo ${aprobador} puede firmar.</small>`}
          </div>`;
        }).join('')}
      </div>
    </div>
  `);
}

async function hwAprobarDominio(domId) {
  const me = getCurrentUser();
  HW.hom.dominios[domId].aprobacion = { estado:'aprobado', aprobadoPor:me, fecha:new Date().toISOString().split('T')[0] };
  await saveItem('homologaciones', HW.hom);
  notify('Aprobado');

  const matDoms = getDominiosActivos().filter(d => HW.hom.dominios[d.id]?.scopeResultado === 'material');
  const todosAprobados = matDoms.every(d => HW.hom.dominios[d.id]?.aprobacion?.estado === 'aprobado');

  if (todosAprobados) {
    notify('Auto-finalizando homologaci√≥n...');
    closeModal();
    await hwFinalizar();
  } else {
    openAprobacionPanel();
  }
}

async function hwFinalizar() {
  const hoy = new Date().toISOString().split('T')[0];
  HW.hom.estadoGlobal = 'completada';
  HW.hom.fase = 'completada';
  HW.hom.fechaCierre = hoy;
  HW.hom.riesgoFinal = 'bajo';

  const t = state.data.terceros.find(x => x.id === HW.hom.terceroId);
  if (t) {
    t.riesgo = 'bajo';
    t.fechaUltima = hoy;
    t.fechaSiguiente = addMonths(hoy, 24);
    await saveItem('terceros', t);
  }
  await saveItem('homologaciones', HW.hom);
  notify('Homologaci√≥n Cerrada');
  hwStopAutosave(); navigate('terceros');
}

function renderPlazos() { document.getElementById('content').innerHTML = '<div class="section-title">Plazos</div>'; }

function getCurrentUser() { return state.currentUser || 'Admin Usuario'; }

function setCurrentUser(nombre) {
  state.currentUser = nombre;
  const avatar = document.getElementById('topbar-avatar');
  const uname  = document.getElementById('topbar-username');
  if (avatar) avatar.textContent = nombre.split(' ').map(w=>w[0]).join('').toUpperCase();
  if (uname)  uname.textContent = nombre;
  closeUserDropdown();
  navigate(state.currentPage);
}

function toggleUserDropdown() {
  const dd = document.getElementById('user-dropdown');
  if (dd.style.display === 'none') {
    dd.style.display = 'block';
    dd.innerHTML = state.data.usuarios.map(u => `<div class="user-dropdown-item" onclick="setCurrentUser('${u.nombre}')">${u.nombre}</div>`).join('');
  } else dd.style.display = 'none';
}
function closeUserDropdown() { document.getElementById('user-dropdown').style.display = 'none'; }
function closeUserDropdownOutside(e) { if (!document.getElementById('user-badge-btn').contains(e.target)) closeUserDropdown(); }

function getMyTasks() {
  const me = getCurrentUser();
  const tasks = [];
  state.data.homologaciones.forEach(hom => {
    if (hom.estadoGlobal === 'completada') return;
    const doms = getDominiosActivos();
    doms.forEach(d => {
      const hDom = hom.dominios[d.id];
      const aprReq = d.cuestionario?.riskScoring?.aprobadores?.[hDom?.riskScoring?.nivel];
      if (hDom?.dd?.estado === 'completado' && aprReq === me && hDom.aprobacion?.estado !== 'aprobado') {
        tasks.push({ homId: hom.id, terceroNombre: hom.terceroNombre, tipo: 'aprobacion', label: 'Firma pendiente: ' + d.nombre, detalle: 'Revisi√≥n final', urgencia: 'alta' });
      }
    });
  });
  return tasks;
}

function resumeHomTask(id, tipo) { resumeHom(id); if(tipo==='aprobacion') openAprobacionPanel(); }
function resumeHom(id) { HW = { hom: state.data.homologaciones.find(x=>x.id===id), tercero: state.data.terceros.find(t=>t.id===state.data.homologaciones.find(x=>x.id===id).terceroId) }; openHWPanel(); }

function renderHomologaciones() {
  const homs = state.data.homologaciones;
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div class="section-title">Homologaciones</div></div>
    <div class="card" style="padding:0"><table>
      <thead><tr><th>Tercero</th><th>Inicio</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody>${homs.map(h => `<tr><td>${h.terceroNombre}</td><td>${fmtDate(h.fechaInicio)}</td><td>${homBadge(h.fase || 'pendiente', h.id)}</td><td><button class="btn btn-primary btn-sm" onclick="resumeHom('${h.id}')">Abrir</button></td></tr>`).join('')}</tbody>
    </table></div>
  `;
}

FS.init().then(() => navigate('dashboard'));
</script>
</body>
</html>
