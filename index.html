<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPRM ¬∑ Gesti√≥n de Riesgos de Terceros</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0c10;--surface:#111318;--surface2:#181c24;--surface3:#1e2330;--border:#252a36;--border2:#2e3545;--accent:#3b82f6;--accent-glow:rgba(59,130,246,0.15);--text:#e8eaf0;--text2:#8b92a5;--text3:#5a6278;--red:#ef4444;--red-soft:rgba(239,68,68,0.12);--amber:#f59e0b;--amber-soft:rgba(245,158,11,0.12);--green:#10b981;--green-soft:rgba(16,185,129,0.12);--purple:#8b5cf6;--purple-soft:rgba(139,92,246,0.12);--cyan:#06b6d4;--cyan-soft:rgba(6,182,212,0.12);--sidebar-w:240px;--header-h:60px;--radius:10px;--radius-sm:6px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--surface)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
#app{display:flex;height:100vh;overflow:hidden}
#sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;z-index:100}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid var(--border)}
.logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;letter-spacing:-0.5px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:10px;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;margin-top:2px}
.nav-section{padding:16px 12px 8px}
.nav-label{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);padding:0 8px;margin-bottom:6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);font-size:13px;transition:all .15s;margin-bottom:2px;user-select:none}
.nav-item:hover{background:var(--surface2);color:var(--text)}.nav-item.active{background:var(--accent-glow);color:var(--accent);font-weight:500}
.nav-item svg{width:16px;height:16px;flex-shrink:0}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#topbar{height:var(--header-h);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid var(--border);background:var(--surface)}
.topbar-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700}
.topbar-right{display:flex;align-items:center;gap:12px}
.user-badge{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--surface2);border-radius:20px;font-size:12px;cursor:pointer}
.user-avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0}
#content{flex:1;overflow-y:auto;padding:24px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s;font-family:inherit;white-space:nowrap}
.btn-primary{background:var(--accent);color:white}.btn-primary:hover{background:#2563eb;box-shadow:0 0 20px rgba(59,130,246,.3)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border2)}.btn-secondary:hover{background:var(--surface3)}
.btn-danger{background:var(--red-soft);color:var(--red);border:1px solid rgba(239,68,68,.2)}.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-ghost{background:transparent;color:var(--text2);border:none}.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-success{background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,.2)}.btn-success:hover{background:rgba(16,185,129,.2)}
.btn-amber{background:var(--amber-soft);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.btn-sm{padding:5px 10px;font-size:12px}.btn-icon{width:32px;height:32px;padding:0;justify-content:center;border-radius:var(--radius-sm)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px}
.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500}
.badge-red{background:var(--red-soft);color:var(--red)}.badge-amber{background:var(--amber-soft);color:var(--amber)}.badge-green{background:var(--green-soft);color:var(--green)}
.badge-blue{background:var(--accent-glow);color:var(--accent)}.badge-purple{background:var(--purple-soft);color:var(--purple)}.badge-cyan{background:var(--cyan-soft);color:var(--cyan)}.badge-gray{background:var(--surface3);color:var(--text2)}
.risk-sin{background:var(--surface3);color:var(--text3)}.risk-proceso{background:var(--accent-glow);color:var(--accent)}.risk-alto{background:var(--red-soft);color:var(--red)}.risk-medio{background:var(--amber-soft);color:var(--amber)}.risk-bajo{background:var(--green-soft);color:var(--green)}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:12px;color:var(--text2);margin-bottom:6px;font-weight:500}
.form-input,.form-select,.form-textarea{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);padding:8px 12px;font-size:13px;font-family:inherit;outline:none;transition:border-color .15s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent)}.form-input:disabled{opacity:.4;cursor:not-allowed}
.form-textarea{resize:vertical;min-height:80px}.form-select option{background:var(--surface2)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.form-note{font-size:11px;color:var(--text3);margin-top:4px}
.toggle{position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0;position:absolute}.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--surface3);border-radius:20px;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:white;left:3px;top:3px;transition:.2s}
.toggle input:checked+.toggle-slider{background:var(--accent)}.toggle input:checked+.toggle-slider::before{transform:translateX(16px)}
.chip-group{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;border:1px solid var(--border2);cursor:pointer;font-size:12px;color:var(--text2);transition:all .15s;user-select:none;background:var(--surface2)}
.chip:hover{border-color:var(--accent);color:var(--text)}.chip[data-sel="1"]{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.chip-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:12px 12px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text2);vertical-align:middle}
tr:hover td{background:var(--surface2)}tr:last-child td{border-bottom:none}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s ease}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:700px;max-height:92vh;display:flex;flex-direction:column;animation:slideUp .2s ease}
.modal-lg{max-width:900px}.modal-xl{max-width:1100px}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;gap:16px}
.modal-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700}
.modal-body{padding:24px;overflow-y:auto;flex:1}.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;align-items:center}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{padding:10px 16px;cursor:pointer;color:var(--text2);font-size:13px;border-bottom:2px solid transparent;transition:all .15s;margin-bottom:-1px}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:500}
.search-bar{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:8px 12px}
.search-bar input{background:none;border:none;outline:none;color:var(--text);font-size:13px;flex:1;font-family:inherit}.search-bar input::placeholder{color:var(--text3)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px}
.stat-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.stat-value{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;line-height:1}.stat-sub{font-size:11px;color:var(--text3);margin-top:6px}
.chart-bar{display:flex;flex-direction:column;gap:10px}.chart-bar-row{display:flex;align-items:center;gap:10px}
.chart-bar-label{font-size:12px;color:var(--text2);width:110px;flex-shrink:0;text-align:right}
.chart-bar-track{flex:1;height:20px;background:var(--surface3);border-radius:4px;overflow:hidden}
.chart-bar-fill{height:100%;border-radius:4px;transition:width .6s ease;display:flex;align-items:center;padding-left:8px;font-size:11px;color:white;font-weight:600;min-width:4px}
.chart-bar-val{font-size:12px;color:var(--text2);width:24px;text-align:right}
.hom-status{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500}
.hom-fuera{background:var(--surface3);color:var(--text3)}.hom-scope{background:var(--cyan-soft);color:var(--cyan)}.hom-scoring{background:var(--amber-soft);color:var(--amber)}.hom-dd{background:var(--purple-soft);color:var(--purple)}.hom-aprobacion{background:var(--accent-glow);color:var(--accent)}.hom-completada{background:var(--green-soft);color:var(--green)}.hom-pendiente{background:var(--surface3);color:var(--text3)}
.q-card{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.q-text{font-size:14px;color:var(--text);font-weight:500;margin-bottom:12px}.q-required{color:var(--red);margin-left:4px}
.q-radio-group{display:flex;flex-direction:column;gap:8px}
.q-radio{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border2);cursor:pointer;transition:all .15s}
.q-radio:hover{border-color:var(--accent);background:var(--accent-glow)}.q-radio.selected{border-color:var(--accent);background:var(--accent-glow)}.q-radio.selected-flag{border-color:var(--red);background:var(--red-soft)}
.question-card{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.question-num{width:24px;height:24px;border-radius:50%;background:var(--accent-glow);color:var(--accent);font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.option-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.option-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-size:12px;font-family:inherit;outline:none}
.option-input:focus{border-color:var(--accent)}.option-score{width:64px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 8px;color:var(--amber);font-size:12px;font-family:inherit;outline:none;text-align:center}
.flag-btn{width:28px;height:28px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border);background:var(--surface);font-size:13px;transition:all .15s;flex-shrink:0}
.flag-btn.on{background:var(--red-soft);border-color:rgba(239,68,68,.3)}
.only-full-btn{font-size:10px;padding:2px 8px;border-radius:4px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text3);transition:all .15s;white-space:nowrap;user-select:none}
.only-full-btn.on{background:var(--purple-soft);border-color:var(--purple);color:var(--purple)}
.wizard-steps{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:10px}
.wizard-step{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3)}
.wizard-step.active{color:var(--accent);font-weight:600}.wizard-step.done{color:var(--green)}
.step-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;background:var(--surface3);color:var(--text3)}
.wizard-step.active .step-dot{background:var(--accent);color:white}.wizard-step.done .step-dot{background:var(--green);color:white}
.step-sep{color:var(--border2);font-size:14px}
.tag-wrap-pos{position:relative}
.tag-input-wrap{display:flex;flex-wrap:wrap;gap:6px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:6px 10px;min-height:42px;cursor:text}
.tag-input-wrap:focus-within{border-color:var(--accent)}
.tag-pill{display:flex;align-items:center;gap:4px;background:var(--accent-glow);border:1px solid var(--accent);color:var(--accent);border-radius:20px;padding:2px 8px;font-size:12px}
.tag-pill button{background:none;border:none;color:var(--accent);cursor:pointer;font-size:14px;line-height:1;padding:0;opacity:.7}.tag-pill button:hover{opacity:1}
.tag-input-field{background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;min-width:120px;flex:1}
.tag-dropdown{position:absolute;z-index:200;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-sm);max-height:200px;overflow-y:auto;width:100%;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.tag-option{padding:8px 12px;cursor:pointer;font-size:13px;color:var(--text2)}.tag-option:hover,.tag-option.hl{background:var(--surface2);color:var(--text)}
.notif{position:fixed;top:20px;right:20px;z-index:9999;padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:500;animation:slideRight .3s ease;max-width:340px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.notif-success{background:var(--green);color:white}.notif-error{background:var(--red);color:white}
@keyframes slideRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800}.section-sub{font-size:13px;color:var(--text3);margin-top:2px}
.divider{border:none;border-top:1px solid var(--border);margin:20px 0}
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}.empty-state svg{width:48px;height:48px;margin:0 auto 16px;display:block;opacity:.4}
.info-box{background:var(--accent-glow);border:1px solid rgba(59,130,246,.2);border-radius:var(--radius-sm);padding:12px 14px;font-size:12px;color:var(--accent)}
.warn-box{background:var(--amber-soft);border:1px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:12px 14px;font-size:12px;color:var(--amber)}
.success-box{background:var(--green-soft);border:1px solid rgba(16,185,129,.2);border-radius:var(--radius-sm);padding:12px 14px;font-size:12px;color:var(--green)}
.action-plan-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
</style>
</head>
<body>
<div id="app">
<nav id="sidebar">
  <div class="sidebar-logo"><div class="logo-text">TPRM</div><div class="logo-sub">Risk Management Platform</div></div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item" data-page="dashboard" onclick="nav('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Dashboard</div>
    <div class="nav-item" data-page="terceros" onclick="nav('terceros')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Maestro de Terceros</div>
    <div class="nav-item" data-page="homologaciones" onclick="nav('homologaciones')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>Homologaciones</div>
    <div class="nav-item" data-page="planes" onclick="nav('planes')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Planes de Acci√≥n</div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Configuraci√≥n</div>
    <div class="nav-item" data-page="usuarios" onclick="nav('usuarios')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Usuarios y Roles</div>
    <div class="nav-item" data-page="ambitos" onclick="nav('ambitos')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>√Åmbitos de Riesgo</div>
    <div class="nav-item" data-page="tipos" onclick="nav('tipos')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>Tipos de Tercero</div>
    <div class="nav-item" data-page="cuestionarios" onclick="nav('cuestionarios')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Cuestionarios</div>
    <div class="nav-item" data-page="plazos" onclick="nav('plazos')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Plazos de Renovaci√≥n</div>
  </div>
</nav>
<main id="main">
  <div id="topbar">
    <div class="topbar-title" id="topbar-title">Dashboard</div>
    <div class="topbar-right"><div class="user-badge"><div class="user-avatar">AU</div><span>Admin Usuario</span></div></div>
  </div>
  <div id="content"></div>
</main>
</div>
<div id="modals"></div>
<div id="notifications"></div>
<script>
// ‚ïê‚ïê COUNTRIES ‚ïê‚ïê
const COUNTRIES=["Afganist√°n","Albania","Alemania","Angola","Arabia Saudita","Argelia","Argentina","Armenia","Australia","Austria","Azerbaiy√°n","B√©lgica","Bolivia","Brasil","Bulgaria","Canad√°","Chile","China","Chipre","Colombia","Corea del Norte","Corea del Sur","Costa Rica","Croacia","Cuba","Dinamarca","Ecuador","Egipto","Emiratos √Årabes Unidos","Eslovaquia","Eslovenia","Espa√±a","Estados Unidos","Estonia","Filipinas","Finlandia","Francia","Grecia","Guatemala","Hungr√≠a","India","Indonesia","Irak","Ir√°n","Irlanda","Islandia","Israel","Italia","Jap√≥n","Jordania","Kazajist√°n","Kenia","Kuwait","Letonia","L√≠bano","Lituania","Luxemburgo","Marruecos","M√©xico","Noruega","Nueva Zelanda","Pa√≠ses Bajos","Pakist√°n","Panam√°","Paraguay","Per√∫","Polonia","Portugal","Reino Unido","Rep√∫blica Checa","Ruman√≠a","Rusia","Singapur","Sud√°frica","Suecia","Suiza","Tailandia","Turqu√≠a","Ucrania","Uruguay","Venezuela","Vietnam"];

// ‚ïê‚ïê FIRESTORE REST ‚ïê‚ïê
const FS={
  projectId:'tprm-f4525',apiKey:'AIzaSyDDSXh3FsO6TfrAtx1WhSiIRCSDZHHSZmA',enabled:false,
  _url(col,id){const b=`https://firestore.googleapis.com/v1/projects/${this.projectId}/databases/(default)/documents/${col}`;return id?`${b}/${id}?key=${this.apiKey}`:`${b}?key=${this.apiKey}&pageSize=500`},
  _tv(v){if(v===null||v===undefined)return{nullValue:null};if(typeof v==='boolean')return{booleanValue:v};if(typeof v==='number')return Number.isInteger(v)?{integerValue:String(v)}:{doubleValue:v};if(typeof v==='string')return{stringValue:v};if(Array.isArray(v))return{arrayValue:{values:v.map(x=>this._tv(x))}};if(typeof v==='object')return{mapValue:{fields:this._tf(v)}};return{stringValue:String(v)}},
  _tf(o){const f={};for(const[k,v]of Object.entries(o))f[k]=this._tv(v);return f},
  _fv(v){if('nullValue'in v)return null;if('booleanValue'in v)return v.booleanValue;if('integerValue'in v)return Number(v.integerValue);if('doubleValue'in v)return v.doubleValue;if('stringValue'in v)return v.stringValue;if('arrayValue'in v)return(v.arrayValue.values||[]).map(x=>this._fv(x));if('mapValue'in v)return this._ff(v.mapValue.fields||{});return null},
  _ff(f){const o={};for(const[k,v]of Object.entries(f))o[k]=this._fv(v);return o},
  async set(col,id,obj){if(!this.enabled)return;const r=await fetch(this._url(col,id),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({fields:this._tf(obj)})});if(!r.ok)console.warn('FS set',col,r.status)},
  async del(col,id){if(!this.enabled)return;await fetch(this._url(col,id),{method:'DELETE'})},
  async list(col){const r=await fetch(this._url(col));if(!r.ok)throw new Error(r.status);const j=await r.json();return(j.documents||[]).map(d=>{const o=this._ff(d.fields||{});if(!o.id)o.id=d.name.split('/').pop();return o})},
  async init(){try{const r=await fetch(this._url('terceros')+'&pageSize=1');if(!r.ok)throw new Error(r.status);this.enabled=true;for(const col of['terceros','usuarios','ambitos','tipos','cuestionarios','planes','homologaciones']){try{const docs=await this.list(col);if(docs.length>0)S.data[col]=docs}catch(e){}}console.log('‚úÖ Firestore OK')}catch(e){console.warn('Firestore offline, local mode:',e.message)}}
};

// ‚ïê‚ïê STATE ‚ïê‚ïê
const S={
  page:'dashboard',
  data:{
    terceros:[
      {id:'t1',nombre:'Accenture Spain',denominacion:'Accenture S.L.',grupo:'Accenture PLC',cif:'B82387770',domicilio:'Av. de Bruselas 35',pais:'Espa√±a',representante:'Jos√© Garc√≠a',responsable:'Mar√≠a P√©rez',tipo:'Proveedor Directo',ambitos:['Cyber','Data Protection','IA'],fechaPrimera:'',fechaSiguiente:'2025-03-15',fechaUltima:'2024-03-15',riesgo:'medio',comentarios:'Proveedor estrat√©gico de TI',remediacion:'',remediacionUser:'',remediacionFecha:'',activo:true},
      {id:'t2',nombre:'Deloitte Advisory',denominacion:'Deloitte Advisory S.L.',grupo:'Deloitte Global',cif:'B79835397',domicilio:'Plaza Pablo Ruiz Picasso 1',pais:'Espa√±a',representante:'Ana L√≥pez',responsable:'Carlos Ruiz',tipo:'Proveedor Directo',ambitos:['Compliance','Fiscal','ESG'],fechaPrimera:'2021-06-01',fechaSiguiente:'2024-06-01',fechaUltima:'2023-06-01',riesgo:'bajo',comentarios:'',remediacion:'',remediacionUser:'',remediacionFecha:'',activo:true},
      {id:'t3',nombre:'Amazon Web Services',denominacion:'AWS EMEA SARL',grupo:'Amazon Inc',cif:'B67890123',domicilio:'38 Av JF Kennedy, Luxemburgo',pais:'Luxemburgo',representante:'Peter Schmidt',responsable:'Laura Torres',tipo:'Proveedor Directo',ambitos:['Cyber','Data Protection'],fechaPrimera:'2023-01-10',fechaSiguiente:'2025-01-10',fechaUltima:'2024-01-10',riesgo:'alto',comentarios:'Datos cr√≠ticos',remediacion:'Auditor√≠a Q2 2025',remediacionUser:'laura.torres@empresa.com',remediacionFecha:'2025-06-30',activo:true},
      {id:'t4',nombre:'Carrefour Espa√±a',denominacion:'Carrefour Espa√±a S.A.',grupo:'Carrefour Group',cif:'A28375103',domicilio:'C/ Campezo 16',pais:'Espa√±a',representante:'Philippe Dumont',responsable:'Ignacio Sanz',tipo:'Cliente',ambitos:['EUDR','ESG'],fechaPrimera:'',fechaSiguiente:'',fechaUltima:'',riesgo:'sin valorar',comentarios:'',remediacion:'',remediacionUser:'',remediacionFecha:'',activo:true},
    ],
    usuarios:[
      {id:'u1',nombre:'Admin Usuario',email:'admin@empresa.com',roles:['admin'],activo:true},
      {id:'u2',nombre:'Mar√≠a P√©rez',email:'maria.perez@empresa.com',roles:['usuario','aprobador'],activo:true},
      {id:'u3',nombre:'Carlos Ruiz',email:'carlos.ruiz@empresa.com',roles:['supervisor'],activo:true},
      {id:'u4',nombre:'Laura Torres',email:'laura.torres@empresa.com',roles:['usuario'],activo:true},
    ],
    ambitos:[
      {id:'a1',nombre:'Cyber',descripcion:'Riesgos de ciberseguridad',responsable:'Mar√≠a P√©rez',color:'#3b82f6',cuestionarios:[]},
      {id:'a2',nombre:'Compliance',descripcion:'Cumplimiento normativo',responsable:'Carlos Ruiz',color:'#8b5cf6',cuestionarios:[]},
      {id:'a3',nombre:'EUDR',descripcion:'EU Deforestation Regulation',responsable:'Laura Torres',color:'#10b981',cuestionarios:[]},
      {id:'a4',nombre:'Data Protection',descripcion:'Protecci√≥n de datos RGPD',responsable:'Mar√≠a P√©rez',color:'#f59e0b',cuestionarios:[]},
      {id:'a5',nombre:'IA',descripcion:'Inteligencia Artificial Act',responsable:'Admin Usuario',color:'#06b6d4',cuestionarios:[]},
      {id:'a6',nombre:'Fiscal',descripcion:'Riesgos fiscales',responsable:'Carlos Ruiz',color:'#ef4444',cuestionarios:[]},
      {id:'a7',nombre:'ESG',descripcion:'Environmental Social Governance',responsable:'Laura Torres',color:'#84cc16',cuestionarios:[]},
    ],
    tipos:[
      {id:'tp1',nivel1:'Proveedor',nivel2:'Proveedor Directo',nivel3:'',terceros:['t1','t2','t3']},
      {id:'tp2',nivel1:'Proveedor',nivel2:'Proveedor Indirecto',nivel3:'',terceros:[]},
      {id:'tp3',nivel1:'Cliente',nivel2:'',nivel3:'',terceros:['t4']},
    ],
    cuestionarios:[
      {id:'cg1',nombre:'Cuestionario General (Base)',tipo:'general',ambito:'',ambito_id:'',aplicaTodos:true,paises:[],ambitosAplicables:[],nivelesRiesgo:[],tiposProveedor:[],
        preguntas:[
          {id:'q1',texto:'¬øCu√°ntos a√±os lleva la organizaci√≥n en funcionamiento?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'M√°s de 10 a√±os',valor:3,flag:false},{texto:'Entre 5 y 10 a√±os',valor:2,flag:false},{texto:'Menos de 5 a√±os',valor:1,flag:false}]},
          {id:'q2',texto:'¬øDispone de c√≥digo de conducta publicado?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'S√≠, publicado y actualizado',valor:3,flag:false},{texto:'S√≠, pero desactualizado',valor:1,flag:false},{texto:'No',valor:0,flag:true}]},
          {id:'q3',texto:'¬øHa sido objeto de sanciones regulatorias en los √∫ltimos 3 a√±os?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'No',valor:3,flag:false},{texto:'Sanciones menores resueltas',valor:1,flag:false},{texto:'Sanciones graves en curso',valor:0,flag:true}]},
        ],
        nivelRiesgoBajo:{min:0,max:3},nivelRiesgoMedio:{min:4,max:6},nivelRiesgoAlto:{min:7,max:99},umbralMaterial:2,bloqueoRedFlag:true,aprobadores:{alto:'Carlos Ruiz',medio:'Mar√≠a P√©rez',bajo:''},creado:'2024-01-01',modificado:'2024-01-01'},
      {id:'cs1',nombre:'Scope Check',tipo:'scope_check',ambito:'',ambito_id:'',aplicaTodos:true,paises:[],ambitosAplicables:[],nivelesRiesgo:[],tiposProveedor:[],
        preguntas:[
          {id:'s1',texto:'¬øEl valor anual estimado supera los 100.000‚Ç¨?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}]},
          {id:'s2',texto:'¬øEl tercero accede a datos personales de clientes?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}]},
          {id:'s3',texto:'¬øForma parte de la cadena de suministro cr√≠tica?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}]},
        ],
        nivelRiesgoBajo:{min:0,max:1},nivelRiesgoMedio:{min:2,max:3},nivelRiesgoAlto:{min:4,max:99},umbralMaterial:2,bloqueoRedFlag:false,aprobadores:{alto:'',medio:'',bajo:''},creado:'2024-01-01',modificado:'2024-01-01'},
      {id:'cr1',nombre:'Risk Scoring General',tipo:'risk_scoring',ambito:'',ambito_id:'',aplicaTodos:true,paises:[],ambitosAplicables:[],nivelesRiesgo:[],tiposProveedor:[],
        preguntas:[
          {id:'r1',texto:'¬øEn qu√© pa√≠s est√° domiciliado el tercero?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'Pa√≠s UE / OCDE de bajo riesgo',valor:1,flag:false},{texto:'Pa√≠s de riesgo medio',valor:2,flag:false},{texto:'Pa√≠s de alto riesgo o sancionado',valor:3,flag:true}]},
          {id:'r2',texto:'¬øQu√© nivel de acceso tendr√° a sistemas internos?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'Sin acceso directo',valor:0,flag:false},{texto:'Acceso limitado y controlado',valor:1,flag:false},{texto:'Acceso amplio a sistemas cr√≠ticos',valor:3,flag:true}]},
          {id:'r3',texto:'¬øExisten antecedentes de incidentes o sanciones?',tipo:'select_unico',obligatoria:true,soloCompleta:false,opciones:[{texto:'No se conocen',valor:0,flag:false},{texto:'Incidentes menores resueltos',valor:1,flag:false},{texto:'Sanciones o incidentes graves',valor:3,flag:true}]},
        ],
        nivelRiesgoBajo:{min:0,max:2},nivelRiesgoMedio:{min:3,max:5},nivelRiesgoAlto:{min:6,max:99},umbralMaterial:2,bloqueoRedFlag:true,aprobadores:{alto:'Carlos Ruiz',medio:'',bajo:''},creado:'2024-01-01',modificado:'2024-01-01'},
    ],
    homologaciones:[],
    planes:[
      {id:'p1',terceroId:'t3',terceroNombre:'Amazon Web Services',titulo:'Auditor√≠a de seguridad Q2 2025',descripcion:'Auditor√≠a completa de controles',responsable:'laura.torres@empresa.com',fechaLimite:'2025-06-30',estado:'en_progreso',prioridad:'alta',creado:'2024-12-01'},
      {id:'p2',terceroId:'t1',terceroNombre:'Accenture Spain',titulo:'Revisi√≥n RGPD contractual',descripcion:'Actualizar cl√°usulas RGPD',responsable:'maria.perez@empresa.com',fechaLimite:'2025-04-30',estado:'pendiente',prioridad:'media',creado:'2024-11-15'},
    ],
    plazos:{alto:12,medio:24,bajo:36}
  }
};

// ‚ïê‚ïê UTILS ‚ïê‚ïê
const notify=(msg,type='success')=>{const n=document.createElement('div');n.className=`notif notif-${type}`;n.textContent=msg;document.getElementById('notifications').appendChild(n);setTimeout(()=>n.remove(),3500)};
const genId=()=>Date.now().toString(36)+Math.random().toString(36).substr(2);
const fmtDate=d=>d?new Date(d).toLocaleDateString('es-ES'):'‚Äî';
const daysUntil=d=>d?Math.ceil((new Date(d)-new Date())/86400000):null;
const addMonths=(date,m)=>{const d=new Date(date);d.setMonth(d.getMonth()+m);return d.toISOString().split('T')[0]};
const riskBadge=r=>({'sin valorar':'<span class="badge risk-sin">Sin valorar</span>','en proceso':'<span class="badge risk-proceso">En proceso</span>','alto':'<span class="badge badge-red">Alto</span>','medio':'<span class="badge badge-amber">Medio</span>','bajo':'<span class="badge badge-green">Bajo</span>'}[r]||'<span class="badge badge-gray">‚Äî</span>');
const homBadge=f=>({pendiente:'<span class="hom-status hom-pendiente">Sin iniciar</span>',fuera_scope:'<span class="hom-status hom-fuera">Fuera de scope</span>',scope_check:'<span class="hom-status hom-scope">üîç Scope Check</span>',risk_scoring:'<span class="hom-status hom-scoring">üìä Risk Scoring</span>',due_diligence:'<span class="hom-status hom-dd">üìã Due Diligence</span>',aprobacion:'<span class="hom-status hom-aprobacion">‚è≥ Aprobaci√≥n</span>',completada:'<span class="hom-status hom-completada">‚úÖ Homologado</span>'}[f]||'<span class="hom-status hom-pendiente">‚Äî</span>');
const I={
  plus:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>',
  x:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  check:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  drag:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="1" fill="currentColor"/><circle cx="15" cy="7" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="17" r="1" fill="currentColor"/><circle cx="15" cy="17" r="1" fill="currentColor"/></svg>',
  play:'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
};
function closeModal(){document.querySelector('.modal-backdrop')?.remove()}
function openModal(html){closeModal();const bd=document.createElement('div');bd.className='modal-backdrop';bd.innerHTML=html;bd.addEventListener('click',e=>{if(e.target===bd)closeModal()});document.getElementById('modals').appendChild(bd)}
async function saveItem(col,item){S.data[col]=S.data[col]||[];const i=S.data[col].findIndex(x=>x.id===item.id);if(i>=0)S.data[col][i]=item;else S.data[col].push(item);if(FS.enabled)FS.set(col,item.id,item).catch(e=>console.warn(e))}
async function delItem(col,id){S.data[col]=S.data[col].filter(x=>x.id!==id);if(FS.enabled)FS.del(col,id).catch(e=>console.warn(e))}
function renderChips(items,sel,grp){return items.map(it=>`<span class="chip" data-sel="${sel.includes(it.value)?'1':'0'}" data-value="${it.value}" data-group="${grp}" onclick="this.dataset.sel=this.dataset.sel==='1'?'0':'1'">${it.color?`<span class="chip-dot" style="background:${it.color}"></span>`:''}${it.label}</span>`).join('')}
function getChips(grp){return[...document.querySelectorAll(`.chip[data-group="${grp}"][data-sel="1"]`)].map(e=>e.dataset.value)}

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
const PAGE_TITLES={dashboard:'Dashboard',terceros:'Maestro de Terceros',homologaciones:'Homologaciones',planes:'Planes de Acci√≥n',usuarios:'Usuarios y Roles',ambitos:'√Åmbitos de Riesgo',tipos:'Tipos de Tercero',cuestionarios:'Cuestionarios',plazos:'Plazos de Renovaci√≥n'};
function nav(page){
  S.page=page;
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.toggle('active',el.dataset.page===page));
  document.getElementById('topbar-title').textContent=PAGE_TITLES[page]||page;
  ({dashboard:renderDashboard,terceros:renderTerceros,homologaciones:renderHomologaciones,planes:renderPlanes,usuarios:renderUsuarios,ambitos:renderAmbitos,tipos:renderTipos,cuestionarios:renderCuestionarios,plazos:renderPlazos})[page]?.()
}

// ‚ïê‚ïê HOMOLOGATION LOGIC ‚ïê‚ïê
function getActiveHom(tid){return S.data.homologaciones.find(h=>h.terceroId===tid&&!['completada','fuera_scope'].includes(h.fase))}
function getLastHom(tid){return S.data.homologaciones.filter(h=>h.terceroId===tid).sort((a,b)=>new Date(b.fechaInicio)-new Date(a.fechaInicio))[0]}
function calcScore(preguntas,respuestas){let score=0,hasFlag=false;(preguntas||[]).forEach(p=>{const r=respuestas[p.id];if(r!==undefined){const op=(p.opciones||[]).find(o=>o.texto===r);if(op){score+=op.valor||0;if(op.flag)hasFlag=true}}});return{score,hasFlag}}
function getRiskLevel(cq,score,hasFlag){if(hasFlag&&cq.bloqueoRedFlag)return'alto';if(score<=cq.nivelRiesgoBajo.max)return'bajo';if(score<=cq.nivelRiesgoMedio.max)return'medio';return'alto'}
function isMaterial(cq,score){return score>=(cq.umbralMaterial||2)}
function getDDCuestionarios(tercero,nivel){
  const gen=S.data.cuestionarios.find(c=>c.tipo==='general');
  const byAmbito=S.data.cuestionarios.filter(c=>c.tipo==='due_diligence'&&(tercero.ambitos||[]).includes(c.ambito));
  return gen?[gen,...byAmbito]:byAmbito
}
function filterQForLevel(preguntas,nivel){return nivel==='alto'?preguntas:(preguntas||[]).filter(p=>!p.soloCompleta)}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê
function renderDashboard(){
  const t=S.data.terceros,total=t.length;
  const altos=t.filter(x=>x.riesgo==='alto').length,medios=t.filter(x=>x.riesgo==='medio').length,bajos=t.filter(x=>x.riesgo==='bajo').length,sinVal=t.filter(x=>x.riesgo==='sin valorar'||x.riesgo==='en proceso').length;
  const homs=S.data.homologaciones,enCurso=homs.filter(h=>!['completada','fuera_scope'].includes(h.fase)).length,completadas=homs.filter(h=>h.fase==='completada').length,fueraScope=homs.filter(h=>h.fase==='fuera_scope').length;
  const planes=S.data.planes||[];
  const upcoming=t.filter(x=>{const d=daysUntil(x.fechaSiguiente);return d!==null&&d<=90&&d>0}).sort((a,b)=>new Date(a.fechaSiguiente)-new Date(b.fechaSiguiente));
  const amb={};t.forEach(ter=>(ter.ambitos||[]).forEach(a=>{amb[a]=(amb[a]||0)+1}));
  document.getElementById('content').innerHTML=`
    <div class="stats-grid">
      ${[['Total Terceros',total,'var(--accent)','en maestro'],['Riesgo Alto',altos,'var(--red)',`${total?Math.round(altos/total*100):0}% del total`],['Riesgo Medio',medios,'var(--amber)',`${total?Math.round(medios/total*100):0}% del total`],['Riesgo Bajo',bajos,'var(--green)',`${total?Math.round(bajos/total*100):0}% del total`],['En Proceso',enCurso,'var(--purple)','homologaciones activas'],['Homologados',completadas,'var(--cyan)','este ciclo'],['Fuera de Scope',fueraScope,'var(--text3)','no requieren proceso']].map(([l,v,c,s])=>`<div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="color:${c}">${v}</div><div class="stat-sub">${s}</div></div>`).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <div class="card"><div class="card-title">Distribuci√≥n por Nivel de Riesgo</div><div class="chart-bar">
        ${[['Alto',altos,'#ef4444'],['Medio',medios,'#f59e0b'],['Bajo',bajos,'#10b981'],['Sin Valorar',sinVal,'#5a6278']].map(([l,v,c])=>`<div class="chart-bar-row"><div class="chart-bar-label">${l}</div><div class="chart-bar-track"><div class="chart-bar-fill" style="width:${total?v/total*100:0}%;background:${c}">${v>0?v:''}</div></div><div class="chart-bar-val">${v}</div></div>`).join('')}
      </div></div>
      <div class="card"><div class="card-title">Homologaciones por Fase</div><div class="chart-bar">
        ${[['Scope Check',homs.filter(h=>h.fase==='scope_check').length,'#06b6d4'],['Risk Scoring',homs.filter(h=>h.fase==='risk_scoring').length,'#f59e0b'],['Due Diligence',homs.filter(h=>h.fase==='due_diligence').length,'#8b5cf6'],['Aprobaci√≥n',homs.filter(h=>h.fase==='aprobacion').length,'#3b82f6'],['Completadas',completadas,'#10b981']].map(([l,v,c])=>`<div class="chart-bar-row"><div class="chart-bar-label">${l}</div><div class="chart-bar-track"><div class="chart-bar-fill" style="width:${Math.max(homs.length,1)?v/Math.max(homs.length,1)*100:0}%;background:${c}">${v>0?v:''}</div></div><div class="chart-bar-val">${v}</div></div>`).join('')}
      </div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card"><div class="card-title">Pr√≥ximas Renovaciones <span class="badge badge-amber" style="margin-left:6px">${upcoming.length}</span></div>
        ${upcoming.length?`<table><thead><tr><th>Tercero</th><th>Fecha</th><th>D√≠as</th><th>Riesgo</th></tr></thead><tbody>${upcoming.slice(0,5).map(ter=>{const d=daysUntil(ter.fechaSiguiente);return`<tr><td style="color:var(--text);font-weight:500">${ter.nombre}</td><td>${fmtDate(ter.fechaSiguiente)}</td><td><span class="badge ${d<=30?'badge-red':'badge-amber'}">${d}d</span></td><td>${riskBadge(ter.riesgo)}</td></tr>`}).join('')}</tbody></table>`:'<p style="color:var(--text3);font-size:12px">Sin renovaciones pr√≥ximas en 90 d√≠as.</p>'}
      </div>
      <div class="card"><div class="card-title">Planes Activos</div>
        ${planes.filter(p=>p.estado!=='completado').slice(0,4).map(p=>{const d=daysUntil(p.fechaLimite);return`<div class="action-plan-card" style="padding:12px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;gap:12px"><div><div style="font-size:13px;font-weight:500;color:var(--text)">${p.titulo}</div><div style="font-size:11px;color:var(--text3);margin-top:3px">${p.terceroNombre}</div></div><span class="badge ${p.prioridad==='alta'?'badge-red':p.prioridad==='media'?'badge-amber':'badge-green'}">${p.prioridad}</span></div><div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text3)"><span>üë§ ${p.responsable}</span>${d!==null?`<span style="color:${d<0?'var(--red)':d<=14?'var(--amber)':'var(--text3)'}">üìÖ ${d<0?'Vencido':d===0?'Hoy':d+'d'}</span>`:''}</div></div>`}).join('')||'<p style="color:var(--text3);font-size:12px">Sin planes activos.</p>'}
      </div>
    </div>`;
}
      <div style="color:var(--text3);cursor:grab;padding:4px;margin-top:2px">${I.drag}</div>
      <div class="qnum">${idx+1}</div>
      <div style="flex:1">
        <input class="form-input" placeholder="Texto de la pregunta..." value="${(p.texto||'').replace(/"/g,'&quot;')}" oninput="W.preguntas[${idx}].texto=this.value" style="margin-bottom:8px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="form-select" style="width:auto" onchange="wChTipo(${idx},this.value)">
            <option value="abierta" ${p.tipo==='abierta'?'selected':''}>Respuesta abierta</option>
            <option value="select_unico" ${p.tipo==='select_unico'?'selected':''}>Selecci√≥n √∫nica</option>
            <option value="select_multiple" ${p.tipo==='select_multiple'?'selected':''}>Selecci√≥n m√∫ltiple</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer"><input type="checkbox" ${p.obligatoria?'checked':''} onchange="W.preguntas[${idx}].obligatoria=this.checked"> Obligatoria</label>
          ${W.tipo==='due_diligence'?`<span class="only-full-btn ${p.soloCompleta?'on':''}" onclick="W.preguntas[${idx}].soloCompleta=!W.preguntas[${idx}].soloCompleta;wRefQ()" title="Solo aparece en Due Diligence completa (riesgo alto)">Solo Completa</span>`:''}
        </div>
      </div>
      <button class="btn btn-danger btn-icon btn-sm" onclick="wRmQ(${idx})">${I.trash}</button>
    </div>
    ${p.tipo!=='abierta'?`
      <div style="padding-left:44px">
        <div style="display:flex;font-size:11px;color:var(--text3);gap:8px;padding:0 4px;margin-bottom:6px"><span style="flex:1">Opci√≥n</span><span style="width:64px;text-align:center">Valor</span><span style="width:28px;text-align:center">üö©</span><span style="width:28px"></span></div>
        ${(p.opciones||[]).map((op,oi)=>`<div class="option-row">
          <input class="opt-input" value="${(op.texto||'').replace(/"/g,'&quot;')}" placeholder="Texto opci√≥n..." oninput="W.preguntas[${idx}].opciones[${oi}].texto=this.value">
          <input class="opt-score" type="number" step="0.5" value="${op.valor??0}" title="Puntuaci√≥n" oninput="W.preguntas[${idx}].opciones[${oi}].valor=parseFloat(this.value)||0">
          <div class="flag-btn ${op.flag?'on':''}" onclick="W.preguntas[${idx}].opciones[${oi}].flag=!W.preguntas[${idx}].opciones[${oi}].flag;wRefQ()">üö©</div>
          <button class="btn btn-ghost btn-icon" style="width:28px;height:28px;padding:0" onclick="wRmOp(${idx},${oi})">${I.x}</button>
        </div>`).join('')}
        <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="wAddOp(${idx})">${I.plus} A√±adir opci√≥n</button>
      </div>`:'<div style="padding-left:44px;font-size:12px;color:var(--text3);font-style:italic;margin-top:4px">Campo de texto libre</div>'}
  </div>`
}

function wRefQ(){document.getElementById('wqlist').innerHTML=W.preguntas.map((p,i)=>wQCard(p,i)).join('')}
function wAddQ(){W.preguntas.push({id:genId(),texto:'',tipo:'select_unico',obligatoria:false,soloCompleta:false,opciones:[{texto:'',valor:0,flag:false}]});wRefQ()}
function wRmQ(idx){W.preguntas.splice(idx,1);wRefQ()}
function wChTipo(idx,tipo){W.preguntas[idx].tipo=tipo;if(tipo!=='abierta'&&!W.preguntas[idx].opciones?.length)W.preguntas[idx].opciones=[{texto:'',valor:0,flag:false}];wRefQ()}
function wAddOp(idx){(W.preguntas[idx].opciones=W.preguntas[idx].opciones||[]).push({texto:'',valor:0,flag:false});wRefQ()}
function wRmOp(idx,oi){W.preguntas[idx].opciones.splice(oi,1);wRefQ()}

function wCollect(){
  if(W.step===1){
    W.nombre=document.getElementById('wn')?.value||W.nombre;
    const wa=document.getElementById('wa');if(wa){W.ambito_id=wa.value;const o=wa.options[wa.selectedIndex];W.ambito=o&&wa.value?o.text:''}
    const wu=document.getElementById('w-umb');if(wu)W.umbralMaterial=parseInt(wu.value)||0;
    if(!W.aplicaTodos){W.nivelesRiesgo=getChips('wniv');W.tiposProveedor=getChips('wtp')}
  }
  if(W.step===3){
    ['bajo','medio','alto'].forEach(k=>{const K=k[0].toUpperCase()+k.slice(1);const mn=document.getElementById(`r-${k}-min`);const mx=document.getElementById(`r-${k}-max`);if(mn)W[`nivelRiesgo${K}`].min=parseFloat(mn.value)||0;if(mx)W[`nivelRiesgo${K}`].max=parseFloat(mx.value)||0});
    const rf=document.getElementById('wrf');if(rf)W.bloqueoRedFlag=rf.checked;
    const u2=document.getElementById('w-umb2');if(u2)W.umbralMaterial=parseInt(u2.value)||0;
  }
  if(W.step===4){['alto','medio','bajo'].forEach(n=>{const el=document.getElementById(`wapr-${n}`);if(el)W.aprobadores[n]=el.value})}
}

function wValidate(){
  if(W.step===1){if(!W.nombre.trim()){notify('Nombre obligatorio','error');return false}if(W.tipo==='due_diligence'&&!W.ambito_id){notify('Selecciona un √°mbito','error');return false}}
  return true;
}
function wNav(dir){wCollect();if(dir>0&&!wValidate())return;W.step=Math.max(1,Math.min(4,W.step+dir));renderWM()}

async function wSave(){
  wCollect();
  const item={id:W.id||genId(),nombre:W.nombre,tipo:W.tipo,ambito:W.ambito,ambito_id:W.ambito_id,aplicaTodos:W.aplicaTodos,paises:W.paises,ambitosAplicables:W.ambitosAplicables,nivelesRiesgo:W.nivelesRiesgo,tiposProveedor:W.tiposProveedor,preguntas:W.preguntas,nivelRiesgoBajo:W.nivelRiesgoBajo,nivelRiesgoMedio:W.nivelRiesgoMedio,nivelRiesgoAlto:W.nivelRiesgoAlto,umbralMaterial:W.umbralMaterial,bloqueoRedFlag:W.bloqueoRedFlag,aprobadores:W.aprobadores,creado:W.creado,modificado:new Date().toISOString().split('T')[0]};
  await saveItem('cuestionarios',item);
  if(item.tipo==='due_diligence'){const amb=S.data.ambitos.find(a=>a.id===item.ambito_id);if(amb&&!(amb.cuestionarios||[]).includes(item.id)){amb.cuestionarios=[...(amb.cuestionarios||[]),item.id];await saveItem('ambitos',amb)}}
  notify('Cuestionario guardado');closeModal();pgCuestionarios();
}

// ‚îÄ‚îÄ PLAZOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pgPlazos(){
  const p=S.data.plazos_config||{alto:12,medio:24,bajo:36};
  document.getElementById('content').innerHTML=`
    <div class="section-header"><div><div class="section-title">Plazos de Renovaci√≥n</div><div class="section-sub">Meses hasta la siguiente homologaci√≥n seg√∫n resultado</div></div></div>
    <div class="info-box" style="margin-bottom:20px">‚ÑπÔ∏è Al completar una homologaci√≥n, el sistema calcula autom√°ticamente la fecha de siguiente renovaci√≥n sumando estos meses a la fecha de cierre.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px">
      ${[['alto','üî¥ Riesgo Alto','var(--red)','alto'],['medio','üü° Riesgo Medio','var(--amber)','medio'],['bajo','üü¢ Riesgo Bajo','var(--green)','bajo'],['fuera_scope','‚ö™ Fuera de Scope','var(--text3)','fuera_scope']].map(([k,l,c,key])=>`
        <div class="card" style="border-left:3px solid ${c}">
          <div style="color:${c};font-weight:700;font-family:'Syne',sans-serif;margin-bottom:16px">${l}</div>
          <div class="form-group"><label class="form-label">Meses hasta renovaci√≥n</label>
            <input class="form-input" type="number" min="1" max="120" id="pl-${key}" value="${p[key]||0}" style="max-width:120px">
            ${key==='fuera_scope'?'<div class="form-note">0 = sin renovaci√≥n peri√≥dica</div>':''}
          </div>
          <div style="font-size:12px;color:var(--text3);margin-top:8px">Equivale a <strong style="color:var(--text2)">${((p[key]||0)/12).toFixed(1)}</strong> a√±os</div>
        </div>`).join('')}
    </div>
    <div style="margin-top:24px;display:flex;justify-content:flex-end">
      <button class="btn btn-primary" onclick="savePlazos()">${I.check} Guardar Plazos</button>
    </div>`;
}

async function savePlazos(){
  const item={id:'plazos',alto:parseInt(document.getElementById('pl-alto').value)||12,medio:parseInt(document.getElementById('pl-medio').value)||24,bajo:parseInt(document.getElementById('pl-bajo').value)||36,fuera_scope:parseInt(document.getElementById('pl-fuera_scope').value)||0};
  S.data.plazos_config=item;
  if(FS.enabled)FS.set('plazos_config','plazos',item).catch(e=>console.warn(e));
  notify('Plazos guardados');pgPlazos();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FS.init().then(()=>nav('dashboard'));
</script>
</body>
</html>
