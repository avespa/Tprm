<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPRM ¬∑ Gesti√≥n de Riesgos de Terceros</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #181c24;
    --surface3: #1e2330;
    --border: #252a36;
    --border2: #2e3545;
    --accent: #3b82f6;
    --accent2: #6366f1;
    --accent-glow: rgba(59,130,246,0.15);
    --text: #e8eaf0;
    --text2: #8b92a5;
    --text3: #5a6278;
    --red: #ef4444;
    --red-soft: rgba(239,68,68,0.12);
    --amber: #f59e0b;
    --amber-soft: rgba(245,158,11,0.12);
    --green: #10b981;
    --green-soft: rgba(16,185,129,0.12);
    --purple: #8b5cf6;
    --purple-soft: rgba(139,92,246,0.12);
    --cyan: #06b6d4;
    --sidebar-w: 240px;
    --header-h: 60px;
    --radius: 10px;
    --radius-sm: 6px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  #app { display: flex; height: 100vh; overflow: hidden; }

  #sidebar {
    width: var(--sidebar-w); flex-shrink: 0;
    background: var(--surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow-y: auto; z-index: 100;
  }
  .sidebar-logo { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); }
  .sidebar-logo .logo-text {
    font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .sidebar-logo .logo-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; margin-top: 2px; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-section-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); padding: 0 8px; margin-bottom: 6px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; border-radius: var(--radius-sm);
    cursor: pointer; color: var(--text2); font-size: 13px;
    transition: all 0.15s; margin-bottom: 2px; user-select: none;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent-glow); color: var(--accent); font-weight: 500; }
  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #topbar {
    height: var(--header-h); flex-shrink: 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; border-bottom: 1px solid var(--border); background: var(--surface);
  }
  .topbar-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--surface2); border-radius: 20px; font-size: 12px; cursor: pointer; }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white; flex-shrink: 0;
  }
  #content { flex: 1; overflow-y: auto; padding: 24px; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500; cursor: pointer;
    border: none; transition: all 0.15s; font-family: inherit; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #2563eb; box-shadow: 0 0 20px rgba(59,130,246,0.3); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
  .btn-secondary:hover { background: var(--surface3); }
  .btn-danger { background: var(--red-soft); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
  .btn-danger:hover { background: rgba(239,68,68,0.2); }
  .btn-ghost { background: transparent; color: var(--text2); border: none; }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: var(--radius-sm); }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 16px; }

  .badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; }
  .badge-red { background: var(--red-soft); color: var(--red); }
  .badge-amber { background: var(--amber-soft); color: var(--amber); }
  .badge-green { background: var(--green-soft); color: var(--green); }
  .badge-blue { background: var(--accent-glow); color: var(--accent); }
  .badge-purple { background: var(--purple-soft); color: var(--purple); }
  .badge-gray { background: var(--surface3); color: var(--text2); }

  .hom-status { display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500; }
  .hom-pendiente { background:var(--surface3);color:var(--text3); }
  .hom-fuera { background:var(--surface3);color:var(--text3); }
  .hom-scope { background:rgba(6,182,212,.12);color:#06b6d4; }
  .hom-scoring { background:var(--amber-soft);color:var(--amber); }
  .hom-dd { background:rgba(139,92,246,.12);color:#8b5cf6; }
  .hom-aprobacion { background:var(--accent-glow);color:var(--accent); }
  .hom-completada { background:var(--green-soft);color:var(--green); }

  .btn-success { background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,.2); }
  .btn-success:hover { background:rgba(16,185,129,.2); }

  /* API LOOKUP */
  .api-lookup-box { background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius);padding:16px;margin-top:8px; }
  .api-result-card { background:var(--surface3);border-radius:var(--radius-sm);padding:12px 14px;margin-top:10px;font-size:12px; }
  .api-result-hit { background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-result-clean { background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-result-partial { background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:10px 12px;margin-top:8px;font-size:12px; }
  .api-spinning { display:inline-block;animation:spin .8s linear infinite; }
  @keyframes spin { from{transform:rotate(0deg)}to{transform:rotate(360deg)} }
  .api-provider-card { border:1px solid var(--border2);border-radius:var(--radius);padding:14px;cursor:pointer;transition:all .15s; }
  .api-provider-card:hover { border-color:var(--accent);background:var(--accent-glow); }
  .api-provider-card.selected { border-color:var(--accent);background:var(--accent-glow); }

  /* IMPORT ZONE */
  .import-zone { border:2px dashed var(--border2);border-radius:var(--radius);padding:32px 24px;text-align:center;cursor:pointer;transition:all .2s;position:relative; }
  .import-zone:hover, .import-zone.drag-over { border-color:var(--accent);background:var(--accent-glow); }
  .import-zone input[type=file] { position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%; }
  .import-zone-icon { font-size:36px;margin-bottom:10px;display:block; }

  .ai-proposal-bar { background:linear-gradient(90deg,rgba(99,102,241,.15),rgba(59,130,246,.15));border:1px solid rgba(99,102,241,.3);border-radius:var(--radius);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px; }
  .ai-proposal-badge { background:linear-gradient(135deg,#6366f1,#3b82f6);color:white;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:.5px;flex-shrink:0; }

  .proposal-section-header { background:var(--surface3);border-radius:var(--radius-sm);padding:8px 14px;margin:12px 0 8px;font-size:12px;font-weight:600;color:var(--accent);display:flex;align-items:center;gap:6px; }

  .analyzing-overlay { text-align:center;padding:48px 24px; }
  .analyzing-spinner { width:48px;height:48px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px; }

  /* FORMS */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
  .form-input, .form-select, .form-textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); color: var(--text);
    padding: 8px 12px; font-size: 13px; font-family: inherit;
    outline: none; transition: border-color 0.15s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-input:disabled { opacity: 0.4; cursor: not-allowed; }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-select option { background: var(--surface2); }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .form-note { font-size: 11px; color: var(--text3); margin-top: 4px; }

  /* TOGGLE ‚Äî pure CSS, no JS needed for visual */
  .toggle { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--surface3); border-radius: 20px; transition: 0.2s; }
  .toggle-slider::before { content: ''; position: absolute; width: 14px; height: 14px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: 0.2s; }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  /* CHIP SELECTOR ‚Äî rewritten to use pure data attributes, no classList toggling issues */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid var(--border2); cursor: pointer;
    font-size: 12px; color: var(--text2); transition: all 0.15s;
    user-select: none; background: var(--surface2);
  }
  .chip:hover { border-color: var(--accent); color: var(--text); }
  .chip[data-sel="1"] { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
  .chip-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text3); padding: 10px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 12px 12px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text2); vertical-align: middle; }
  tr:hover td { background: var(--surface2); }
  tr:last-child td { border-bottom: none; }

  /* MODAL */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px); z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.15s ease;
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); width: 90%; max-width: 700px;
    max-height: 90vh; display: flex; flex-direction: column;
    animation: slideUp 0.2s ease;
  }
  .modal-lg { max-width: 900px; }
  .modal-xl { max-width: 1100px; }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; gap: 16px; }
  .modal-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; align-items: center; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* TABS */
  .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 10px 16px; cursor: pointer; color: var(--text2); font-size: 13px; border-bottom: 2px solid transparent; transition: all 0.15s; margin-bottom: -1px; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }

  /* SEARCH */
  .search-bar { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 8px 12px; color: var(--text2); }
  .search-bar input { background: none; border: none; outline: none; color: var(--text); font-size: 13px; flex: 1; font-family: inherit; }
  .search-bar input::placeholder { color: var(--text3); }

  .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; }
  .stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--text3); margin-top: 6px; }

  /* RISK BADGES */
  .risk-tag-sin { background: var(--surface3); color: var(--text3); }
  .risk-tag-proceso { background: var(--accent-glow); color: var(--accent); }
  .risk-tag-alto { background: var(--red-soft); color: var(--red); }
  .risk-tag-medio { background: var(--amber-soft); color: var(--amber); }
  .risk-tag-bajo { background: var(--green-soft); color: var(--green); }

  /* CHART BARS */
  .chart-bar { display: flex; flex-direction: column; gap: 10px; }
  .chart-bar-row { display: flex; align-items: center; gap: 10px; }
  .chart-bar-label { font-size: 12px; color: var(--text2); width: 100px; flex-shrink: 0; text-align: right; }
  .chart-bar-track { flex: 1; height: 20px; background: var(--surface3); border-radius: 4px; overflow: hidden; }
  .chart-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; font-size: 11px; color: white; font-weight: 600; min-width: 4px; }
  .chart-bar-val { font-size: 12px; color: var(--text2); width: 24px; text-align: right; }

  /* QUESTION BUILDER */
  .question-card { background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .question-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent-glow); color: var(--accent); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .option-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .option-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; color: var(--text); font-size: 12px; font-family: inherit; outline: none; }
  .option-input:focus { border-color: var(--accent); }
  .option-score { width: 64px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--amber); font-size: 12px; font-family: inherit; outline: none; text-align: center; }
  .flag-btn { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); background: var(--surface); font-size: 13px; transition: all 0.15s; flex-shrink: 0; }
  .flag-btn.on { background: var(--red-soft); border-color: rgba(239,68,68,0.3); }

  /* WIZARD STEPS */
  .wizard-steps { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
  .wizard-step { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text3); }
  .wizard-step.active { color: var(--accent); font-weight: 600; }
  .wizard-step.done { color: var(--green); }
  .step-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .wizard-step .step-dot { background: var(--surface3); color: var(--text3); }
  .wizard-step.active .step-dot { background: var(--accent); color: white; }
  .wizard-step.done .step-dot { background: var(--green); color: white; }
  .step-sep { color: var(--border2); font-size: 14px; }

  /* COUNTRY TAG INPUT */
  .tag-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 6px 10px; min-height: 42px; cursor: text; }
  .tag-input-wrap:focus-within { border-color: var(--accent); }
  .tag-pill { display: flex; align-items: center; gap: 4px; background: var(--accent-glow); border: 1px solid var(--accent); color: var(--accent); border-radius: 20px; padding: 2px 8px; font-size: 12px; }
  .tag-pill button { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 14px; line-height: 1; padding: 0; opacity: 0.7; }
  .tag-pill button:hover { opacity: 1; }
  .tag-input-field { background: none; border: none; outline: none; color: var(--text); font-size: 13px; font-family: inherit; min-width: 120px; flex: 1; }
  .tag-dropdown { position: absolute; z-index: 200; background: var(--surface); border: 1px solid var(--border2); border-radius: var(--radius-sm); max-height: 220px; overflow-y: auto; width: 100%; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .tag-option { padding: 8px 12px; cursor: pointer; font-size: 13px; color: var(--text2); }
  .tag-option:hover { background: var(--surface2); color: var(--text); }
  .tag-option.highlighted { background: var(--accent-glow); color: var(--accent); }
  .tag-wrap-pos { position: relative; }

  /* NOTIFICATION */
  .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 12px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 500; animation: slideRight 0.3s ease; max-width: 340px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .notification-success { background: var(--green); color: white; }
  .notification-error { background: var(--red); color: white; }
  @keyframes slideRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .section-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
  .section-sub { font-size: 13px; color: var(--text3); margin-top: 2px; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; display: block; margin: 0 auto 16px; }
  .action-plan-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .info-box { background: var(--accent-glow); border: 1px solid rgba(59,130,246,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--accent); }
  .warn-box { background: var(--amber-soft); border: 1px solid rgba(245,158,11,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--amber); }
</style>
</head>
<body>
<div id="app">
  <nav id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">TPRM</div>
      <div class="logo-sub">Risk Management Platform</div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Principal</div>
      <div class="nav-item" data-page="dashboard" onclick="navigate('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="nav-item" data-page="terceros" onclick="navigate('terceros')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Maestro de Terceros
      </div>
      <div class="nav-item" data-page="homologaciones" onclick="navigate('homologaciones')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Homologaciones
      </div>
      <div class="nav-item" data-page="planes" onclick="navigate('planes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Planes de Acci√≥n
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Configuraci√≥n</div>
      <div class="nav-item" data-page="usuarios" onclick="navigate('usuarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Usuarios y Roles
      </div>
      <div class="nav-item" data-page="ambitos" onclick="navigate('ambitos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
        √Åmbitos de Riesgo
      </div>
      <div class="nav-item" data-page="tipos" onclick="navigate('tipos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Tipos de Tercero
      </div>
      <div class="nav-item" data-page="cuestionarios" onclick="navigate('cuestionarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Cuestionarios
      </div>
      <div class="nav-item" data-page="plazos" onclick="navigate('plazos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Plazos de Renovaci√≥n
      </div>
    </div>

  </nav>

  <main id="main">
    <div id="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <div class="user-badge">
          <div class="user-avatar">AU</div>
          <span>Admin Usuario</span>
        </div>
      </div>
    </div>
    <div id="content"></div>
  </main>
</div>

<div id="modals"></div>
<div id="notifications"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COUNTRIES LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COUNTRIES = [
  "Afganist√°n","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia",
  "Australia","Austria","Azerbaiy√°n","Bahamas","Banglad√©s","Barbados","Bar√©in","B√©lgica","Belice","Ben√≠n","Bielorrusia",
  "Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","Brun√©i","Bulgaria","Burkina Faso","Burundi","But√°n","Cabo Verde",
  "Camboya","Camer√∫n","Canad√°","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Congo","Corea del Norte",
  "Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador",
  "Emiratos √Årabes Unidos","Eritrea","Eslovaquia","Eslovenia","Espa√±a","Estados Unidos","Estonia","Etiop√≠a","Fiyi",
  "Filipinas","Finlandia","Francia","Gab√≥n","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea",
  "Guinea Ecuatorial","Guinea-Bis√°u","Guyana","Hait√≠","Honduras","Hungr√≠a","India","Indonesia","Irak","Ir√°n","Irlanda",
  "Islandia","Islas Marshall","Islas Salom√≥n","Israel","Italia","Jamaica","Jap√≥n","Jordania","Kazajist√°n","Kenia",
  "Kirguist√°n","Kiribati","Kuwait","Laos","Lesoto","Letonia","L√≠bano","Liberia","Libia","Liechtenstein","Lituania",
  "Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","Mali","Malta","Marruecos","Mauricio","Mauritania","M√©xico",
  "Micronesia","Moldavia","M√≥naco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","N√≠ger",
  "Nigeria","Noruega","Nueva Zelanda","Om√°n","Pa√≠ses Bajos","Pakist√°n","Palaos","Palestina","Panam√°","Pap√∫a Nueva Guinea",
  "Paraguay","Per√∫","Polonia","Portugal","Reino Unido","Rep√∫blica Centroafricana","Rep√∫blica Checa","Rep√∫blica Dominicana",
  "Ruanda","Ruman√≠a","Rusia","Samoa","San Crist√≥bal y Nieves","San Marino","San Vicente y las Granadinas","Santa Luc√≠a",
  "Santo Tom√© y Pr√≠ncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka",
  "Suazilandia","Sud√°frica","Sud√°n","Sud√°n del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","Tayikist√°n",
  "Timor Oriental","Togo","Tonga","Trinidad y Tobago","T√∫nez","Turkmenist√°n","Turqu√≠a","Tuvalu","Ucrania","Uganda",
  "Uruguay","Uzbekist√°n","Vanuatu","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue"
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  currentPage: 'dashboard',
  data: {
    terceros: [
      { id:'t1', nombre:'Accenture Spain', denominacion:'Accenture S.L.', grupo:'Accenture PLC', cif:'B82387770', domicilio:'Av. de Bruselas 35, Alcobendas', pais:'Espa√±a', representante:'Jos√© Garc√≠a', responsable:'Mar√≠a P√©rez', tipo:'Proveedor Directo', ambitos:['Cyber','Data Protection','IA'], fechaPrimera:'2022-03-15', fechaSiguiente:'2025-03-15', fechaUltima:'2024-03-15', riesgo:'medio', comentarios:'Proveedor estrat√©gico de TI', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t2', nombre:'Deloitte Advisory', denominacion:'Deloitte Advisory S.L.', grupo:'Deloitte Global', cif:'B79835397', domicilio:'Plaza Pablo Ruiz Picasso 1, Madrid', pais:'Espa√±a', representante:'Ana L√≥pez', responsable:'Carlos Ruiz', tipo:'Proveedor Directo', ambitos:['Compliance','Fiscal','ESG'], fechaPrimera:'2021-06-01', fechaSiguiente:'2024-06-01', fechaUltima:'2023-06-01', riesgo:'bajo', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t3', nombre:'Amazon Web Services', denominacion:'Amazon Web Services EMEA SARL', grupo:'Amazon Inc', cif:'B67890123', domicilio:'38 Av JF Kennedy, Luxemburgo', pais:'Luxemburgo', representante:'Peter Schmidt', responsable:'Laura Torres', tipo:'Proveedor Directo', ambitos:['Cyber','Data Protection'], fechaPrimera:'2023-01-10', fechaSiguiente:'2025-01-10', fechaUltima:'2024-01-10', riesgo:'alto', comentarios:'Procesamiento datos cr√≠ticos', remediacion:'Realizar auditor√≠a de seguridad Q2 2025', remediacionUser:'laura.torres@empresa.com', remediacionFecha:'2025-06-30', activo:true },
      { id:'t4', nombre:'Carrefour Espa√±a', denominacion:'Carrefour Espa√±a S.A.', grupo:'Carrefour Group', cif:'A28375103', domicilio:'C/ Campezo 16, Madrid', pais:'Espa√±a', representante:'Philippe Dumont', responsable:'Ignacio Sanz', tipo:'Cliente', ambitos:['EUDR','ESG'], fechaPrimera:'2020-09-01', fechaSiguiente:'2025-09-01', fechaUltima:'2023-09-01', riesgo:'sin valorar', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
    ],
    usuarios: [
      { id:'u1', nombre:'Admin Usuario', email:'admin@empresa.com', roles:['admin'], activo:true },
      { id:'u2', nombre:'Mar√≠a P√©rez', email:'maria.perez@empresa.com', roles:['usuario','aprobador'], activo:true },
      { id:'u3', nombre:'Carlos Ruiz', email:'carlos.ruiz@empresa.com', roles:['supervisor'], activo:true },
      { id:'u4', nombre:'Laura Torres', email:'laura.torres@empresa.com', roles:['usuario'], activo:true },
    ],
    ambitos: [
      { id:'a1', nombre:'Cyber', descripcion:'Riesgos de ciberseguridad', responsable:'Mar√≠a P√©rez', color:'#3b82f6', cuestionarios:['c1'] },
      { id:'a2', nombre:'Compliance', descripcion:'Cumplimiento normativo', responsable:'Carlos Ruiz', color:'#8b5cf6', cuestionarios:[] },
      { id:'a3', nombre:'EUDR', descripcion:'EU Deforestation Regulation', responsable:'Laura Torres', color:'#10b981', cuestionarios:[] },
      { id:'a4', nombre:'Data Protection', descripcion:'Protecci√≥n de datos RGPD', responsable:'Mar√≠a P√©rez', color:'#f59e0b', cuestionarios:[] },
      { id:'a5', nombre:'IA', descripcion:'Inteligencia Artificial Act', responsable:'Admin Usuario', color:'#06b6d4', cuestionarios:[] },
      { id:'a6', nombre:'Fiscal', descripcion:'Riesgos fiscales y tributarios', responsable:'Carlos Ruiz', color:'#ef4444', cuestionarios:[] },
      { id:'a7', nombre:'ESG', descripcion:'Environmental, Social & Governance', responsable:'Laura Torres', color:'#84cc16', cuestionarios:[] },
    ],
    tipos: [
      { id:'tp1', nivel1:'Proveedor', nivel2:'Proveedor Directo', nivel3:'', terceros:['t1','t2','t3'] },
      { id:'tp2', nivel1:'Proveedor', nivel2:'Proveedor Indirecto', nivel3:'', terceros:[] },
      { id:'tp3', nivel1:'Cliente', nivel2:'', nivel3:'', terceros:['t4'] },
    ],
    cuestionarios: [
      {
        id:'cg1', nombre:'Cuestionario General (Base)', tipo:'general', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'q1', texto:'¬øCu√°ntos a√±os lleva la organizaci√≥n en funcionamiento?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'M√°s de 10 a√±os',valor:3,flag:false},{texto:'Entre 5 y 10 a√±os',valor:2,flag:false},{texto:'Menos de 5 a√±os',valor:1,flag:false}] },
          { id:'q2', texto:'¬øDispone de un c√≥digo de conducta publicado y actualizado?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠, publicado y actualizado',valor:3,flag:false},{texto:'S√≠, pero no actualizado',valor:1,flag:false},{texto:'No',valor:0,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'Mar√≠a P√©rez',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cs1', nombre:'Scope Check', tipo:'scope_check', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'s1', texto:'¬øEl valor anual de la relaci√≥n supera los 100.000‚Ç¨?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s2', texto:'¬øEl tercero tiene acceso a datos personales de clientes?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s3', texto:'¬øEl tercero forma parte de la cadena de suministro cr√≠tica?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:1}, nivelRiesgoMedio:{min:2,max:3}, nivelRiesgoAlto:{min:4,max:99},
        umbralMaterial:2, bloqueoRedFlag:false, aprobadores:{alto:'',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cr1', nombre:'Risk Scoring General', tipo:'risk_scoring', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'r1', texto:'¬øEn qu√© regi√≥n est√° domiciliado el tercero?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'UE / OCDE (bajo riesgo)',valor:1,flag:false},{texto:'Pa√≠s de riesgo medio',valor:2,flag:false},{texto:'Pa√≠s de alto riesgo o sancionado',valor:3,flag:true}] },
          { id:'r2', texto:'¬øQu√© nivel de acceso tendr√° a sistemas internos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sin acceso',valor:0,flag:false},{texto:'Acceso limitado / controlado',valor:1,flag:false},{texto:'Acceso amplio a sistemas cr√≠ticos',valor:3,flag:true}] },
          { id:'r3', texto:'¬øExisten antecedentes de incidentes o sanciones conocidos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'No se conocen',valor:0,flag:false},{texto:'Incidentes menores resueltos',valor:1,flag:false},{texto:'Sanciones o incidentes graves',valor:3,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:2}, nivelRiesgoMedio:{min:3,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'c1', nombre:'Cuestionario Cyber', tipo:'due_diligence', ambito:'Cyber', ambito_id:'a1',
        aplicaTodos:true, paises:[], ambitosAplicables:['Cyber'], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'cq1', texto:'¬øDispone de pol√≠tica de ciberseguridad documentada?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'S√≠, documentada y actualizada',valor:3,flag:false},{texto:'S√≠, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}] },
          { id:'cq2', texto:'¬øRealiza auditor√≠as de seguridad peri√≥dicas?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Anualmente o m√°s frecuente',valor:3,flag:false},{texto:'Cada 2-3 a√±os',valor:2,flag:false},{texto:'Nunca o no sabe',valor:0,flag:true}] },
          { id:'cq3', texto:'¬øCuenta con seguro de ciberriesgo?', tipo:'select_unico', obligatoria:true, soloCompleta:true, opciones:[{texto:'S√≠, con cobertura adecuada',valor:3,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'Mar√≠a P√©rez',bajo:''},
        creado:'2024-01-15', modificado:'2024-03-10'
      }
    ],
    homologaciones: [],
    plazos: { alto:12, medio:24, bajo:36 },
    planes: [
      { id:'p1', terceroId:'t3', terceroNombre:'Amazon Web Services', titulo:'Auditor√≠a de seguridad Q2 2025', descripcion:'Realizar auditor√≠a completa de controles de seguridad', responsable:'laura.torres@empresa.com', fechaLimite:'2025-06-30', estado:'en_progreso', prioridad:'alta', creado:'2024-12-01' },
      { id:'p2', terceroId:'t1', terceroNombre:'Accenture Spain', titulo:'Revisi√≥n RGPD contractual', descripcion:'Actualizar cl√°usulas de protecci√≥n de datos en contrato', responsable:'maria.perez@empresa.com', fechaLimite:'2025-04-30', estado:'pendiente', prioridad:'media', creado:'2024-11-15' },
    ]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const notify = (msg, type='success') => {
  const n = document.createElement('div');
  n.className = `notification notification-${type}`;
  n.textContent = msg;
  document.getElementById('notifications').appendChild(n);
  setTimeout(() => n.remove(), 3500);
};

const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const fmtDate = d => d ? new Date(d).toLocaleDateString('es-ES') : '‚Äî';
const daysUntil = d => d ? Math.ceil((new Date(d) - new Date()) / 86400000) : null;

const riskBadge = r => ({
  'sin valorar': '<span class="badge risk-tag-sin">Sin valorar</span>',
  'en proceso':  '<span class="badge risk-tag-proceso">En proceso</span>',
  'alto':        '<span class="badge badge-red">Alto</span>',
  'medio':       '<span class="badge badge-amber">Medio</span>',
  'bajo':        '<span class="badge badge-green">Bajo</span>',
}[r] || '<span class="badge badge-gray">‚Äî</span>');

const SVG = {
  plus:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>',
  x:     '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  check: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  drag:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="1" fill="currentColor"/><circle cx="15" cy="7" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="17" r="1" fill="currentColor"/><circle cx="15" cy="17" r="1" fill="currentColor"/></svg>',
  play:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/></svg>',
  check: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API PROVIDERS ‚Äî configuraci√≥n de integraciones externas
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_PROVIDERS = {

  // ‚îÄ‚îÄ sanctions.network ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 100% gratuito, sin API key, sin registro.
  // Cubre: OFAC SDN (USA) + UN Security Council + EU Financial Sanctions File
  // B√∫squeda fuzzy por similitud de nombre (trigramas PostgreSQL)
  // Docs: https://sanctions.network
  sanctionsnetwork: {
    nombre: 'Sanctions Network',
    descripcion: 'OFAC + ONU + UE ‚Äî gratuito, sin registro, sin l√≠mites',
    icono: 'üõ°Ô∏è',
    color: '#ef4444',
    docsUrl: 'https://sanctions.network',
    requiresKey: false,
    fuentes: ['OFAC SDN (USA)', 'UN Security Council', 'EU Financial Sanctions'],
    autoSelectRule: (result) => {
      if (!result.hits) return { opcionIdx: 0, justificacion: 'Sin coincidencias en OFAC, ONU ni UE' };
      const maxScore = result.topHit?.similarityScore || 0;
      if (maxScore >= 0.85) return { opcionIdx: 2, justificacion: `Coincidencia fuerte ‚Äî score ${(maxScore*100).toFixed(0)}% en ${result.topHit?.source?.toUpperCase()}` };
      return { opcionIdx: 1, justificacion: `${result.hits} coincidencia(s) parcial(es) ‚Äî score m√°x. ${(maxScore*100).toFixed(0)}%` };
    },
    defaultOpciones: [
      { texto: 'Sin coincidencias (OFAC + ONU + UE)', valor: 3, flag: false },
      { texto: 'Coincidencia parcial ‚Äî requiere verificaci√≥n manual', valor: 1, flag: false },
      { texto: 'Coincidencia fuerte en lista de sanciones', valor: 0, flag: true }
    ]
  },

  // ‚îÄ‚îÄ OpenCorporates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Gratuito con l√≠mite de ~10 req/d√≠a sin key.
  // Datos registrales de empresas en +140 pa√≠ses.
  opencorporates: {
    nombre: 'OpenCorporates',
    descripcion: 'Datos registrales de empresas en +140 pa√≠ses',
    icono: 'üè¢',
    color: '#3b82f6',
    docsUrl: 'https://api.opencorporates.com/',
    requiresKey: false,
    fuentes: ['Registros mercantiles de +140 pa√≠ses'],
    autoSelectRule: (result) => {
      if (!result.hits) return { opcionIdx: 0, justificacion: 'Sin datos registrales encontrados' };
      return { opcionIdx: 1, justificacion: `${result.hits} empresa(s) en registros ‚Äî ${result.topHit?.pais?.toUpperCase()||''}` };
    },
    defaultOpciones: [
      { texto: 'Sin datos registrales encontrados', valor: 1, flag: false },
      { texto: 'Empresa verificada en registros p√∫blicos', valor: 3, flag: false }
    ]
  },

  // ‚îÄ‚îÄ OpenSanctions (de pago, evaluaci√≥n gratuita 30 d√≠as) ‚îÄ‚îÄ‚îÄ‚îÄ
  opensanctions: {
    nombre: 'OpenSanctions',
    descripcion: '+100 fuentes de sanciones ‚Äî requiere API key (trial 30 d√≠as)',
    icono: 'üîë',
    color: '#f59e0b',
    docsUrl: 'https://www.opensanctions.org/docs/api/',
    requiresKey: true,
    fuentes: ['OFAC', 'UE', 'ONU', 'Interpol', '+100 fuentes m√°s'],
    autoSelectRule: (result) => {
      if (result.score >= 0.85) return { opcionIdx: 2, justificacion: `Coincidencia fuerte ‚Äî score ${result.score.toFixed(2)}` };
      if (result.score >= 0.6)  return { opcionIdx: 1, justificacion: `Coincidencia parcial ‚Äî score ${result.score.toFixed(2)}` };
      return { opcionIdx: 0, justificacion: `Sin coincidencias (score ${result.score?.toFixed(2)||'0.00'})` };
    },
    defaultOpciones: [
      { texto: 'Sin coincidencias en listas de sanciones', valor: 3, flag: false },
      { texto: 'Coincidencia parcial ‚Äî requiere verificaci√≥n', valor: 1, flag: false },
      { texto: 'Coincidencia fuerte en listas de sanciones', valor: 0, flag: true }
    ]
  },

  // ‚îÄ‚îÄ API Personalizada ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  custom: {
    nombre: 'API Personalizada',
    descripcion: 'Conecta cualquier API REST propia o de terceros',
    icono: '‚öôÔ∏è',
    color: '#8b5cf6',
    docsUrl: '',
    requiresKey: false,
    fuentes: ['Tu fuente personalizada'],
    autoSelectRule: () => ({ opcionIdx: 0, justificacion: 'Resultado manual' }),
    defaultOpciones: [
      { texto: 'Resultado satisfactorio', valor: 3, flag: false },
      { texto: 'Resultado no satisfactorio', valor: 0, flag: true }
    ]
  }
};

// API keys store (en producci√≥n esto vivir√≠a en backend)
const API_KEYS = {};

function closeModal() { document.querySelector('.modal-backdrop')?.remove(); }
function openModal(html) {
  closeModal();
  const bd = document.createElement('div');
  bd.className = 'modal-backdrop';
  bd.innerHTML = html;
  bd.addEventListener('click', e => { if (e.target === bd) closeModal(); });
  document.getElementById('modals').appendChild(bd);
}

async function saveItem(col, item) {
  state.data[col] = state.data[col] || [];
  const idx = state.data[col].findIndex(x => x.id === item.id);
  if (idx >= 0) state.data[col][idx] = item; else state.data[col].push(item);
  if (FS.enabled) FS.set(col, item.id, item).catch(e => console.warn('FS save:', e));
}
async function deleteItem(col, id) {
  state.data[col] = state.data[col].filter(x => x.id !== id);
  if (FS.enabled) FS.delete(col, id).catch(e => console.warn('FS delete:', e));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHIP SELECTOR ‚Äî pure data-attribute approach, no classList bug
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// chipGroup(containerId, items, selectedValues, onChange)
// items = [{value, label, color?}]
// onChange(newSelectedArray)
function renderChipGroup(items, selected, name) {
  return items.map(item => {
    const isSel = selected.includes(item.value) ? '1' : '0';
    const dot = item.color ? `<span class="chip-dot" style="background:${item.color}"></span>` : '';
    return `<span class="chip" data-sel="${isSel}" data-value="${item.value}" data-group="${name}" onclick="toggleChip(this)">${dot}${item.label}</span>`;
  }).join('');
}

function toggleChip(el) {
  el.dataset.sel = el.dataset.sel === '1' ? '0' : '1';
}

function getChipValues(groupName) {
  return [...document.querySelectorAll(`.chip[data-group="${groupName}"][data-sel="1"]`)].map(el => el.dataset.value);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pageTitles = { dashboard:'Dashboard', terceros:'Maestro de Terceros', homologaciones:'Homologaciones', planes:'Planes de Acci√≥n', usuarios:'Usuarios y Roles', ambitos:'√Åmbitos de Riesgo', tipos:'Tipos de Tercero', cuestionarios:'Cuestionarios', plazos:'Plazos de Renovaci√≥n' };

function navigate(page) {
  state.currentPage = page;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.page === page));
  document.getElementById('topbar-title').textContent = pageTitles[page] || page;
  ({ dashboard:renderDashboard, terceros:renderTerceros, homologaciones:renderHomologaciones, planes:renderPlanes, usuarios:renderUsuarios, ambitos:renderAmbitos, tipos:renderTipos, cuestionarios:renderCuestionarios, plazos:renderPlazos })[page]?.();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIRESTORE REST API ‚Äî hardcoded, auto-init, zero dependencies
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FS = {
  projectId: 'tprm-f4525',
  apiKey:    'AIzaSyDDSXh3FsO6TfrAtx1WhSiIRCSDZHHSZmA',
  enabled:   false,

  _url(col, id) {
    const base = `https://firestore.googleapis.com/v1/projects/${this.projectId}/databases/(default)/documents/${col}`;
    return id ? `${base}/${id}?key=${this.apiKey}` : `${base}?key=${this.apiKey}&pageSize=500`;
  },

  // JS ‚Üí Firestore value
  _toVal(v) {
    if (v === null || v === undefined) return { nullValue: null };
    if (typeof v === 'boolean')  return { booleanValue: v };
    if (typeof v === 'number')   return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
    if (typeof v === 'string')   return { stringValue: v };
    if (Array.isArray(v))        return { arrayValue: { values: v.map(x => this._toVal(x)) } };
    if (typeof v === 'object')   return { mapValue: { fields: this._toFields(v) } };
    return { stringValue: String(v) };
  },
  _toFields(obj) {
    const f = {};
    for (const [k, v] of Object.entries(obj)) f[k] = this._toVal(v);
    return f;
  },

  // Firestore value ‚Üí JS
  _fromVal(v) {
    if ('nullValue'    in v) return null;
    if ('booleanValue' in v) return v.booleanValue;
    if ('integerValue' in v) return Number(v.integerValue);
    if ('doubleValue'  in v) return v.doubleValue;
    if ('stringValue'  in v) return v.stringValue;
    if ('arrayValue'   in v) return (v.arrayValue.values || []).map(x => this._fromVal(x));
    if ('mapValue'     in v) return this._fromFields(v.mapValue.fields || {});
    return null;
  },
  _fromFields(fields) {
    const obj = {};
    for (const [k, v] of Object.entries(fields)) obj[k] = this._fromVal(v);
    return obj;
  },

  async set(col, id, obj) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fields: this._toFields(obj) })
    });
    if (!r.ok) console.warn('FS set error', col, id, r.status);
  },

  async delete(col, id) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), { method: 'DELETE' });
    if (!r.ok) console.warn('FS delete error', col, id, r.status);
  },

  async list(col) {
    const r = await fetch(this._url(col));
    if (!r.ok) throw new Error(`FS list ${col}: ${r.status}`);
    const json = await r.json();
    return (json.documents || []).map(doc => {
      const obj = this._fromFields(doc.fields || {});
      if (!obj.id) obj.id = doc.name.split('/').pop();
      return obj;
    });
  },

  async init() {
    try {
      // Test with a lightweight request
      const r = await fetch(this._url('terceros') + '&pageSize=1');
      if (!r.ok) throw new Error(r.status);
      this.enabled = true;
      // Sync all collections ‚Äî only replace if Firestore has data
      const cols = ['terceros','usuarios','ambitos','tipos','cuestionarios','planes'];
      for (const col of cols) {
        try {
          const docs = await this.list(col);
          if (docs.length > 0) state.data[col] = docs;
        } catch(e) { console.warn('Sync', col, e); }
      }
      console.log('‚úÖ Firestore connected & synced');
    } catch(e) {
      console.warn('Firestore unavailable, running local:', e.message);
    }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const t = state.data.terceros;
  const total = t.length;
  const altos = t.filter(x => x.riesgo==='alto').length;
  const medios = t.filter(x => x.riesgo==='medio').length;
  const bajos = t.filter(x => x.riesgo==='bajo').length;
  const sinVal = t.filter(x => x.riesgo==='sin valorar' || x.riesgo==='en proceso').length;
  const planes = state.data.planes || [];
  const planesActivos = planes.filter(p => p.estado!=='completado').length;
  const upcoming = t.filter(x => { const d=daysUntil(x.fechaSiguiente); return d!==null && d<=90 && d>0; }).sort((a,b)=>new Date(a.fechaSiguiente)-new Date(b.fechaSiguiente));
  const ambitoCounts = {};
  t.forEach(ter => (ter.ambitos||[]).forEach(a => { ambitoCounts[a]=(ambitoCounts[a]||0)+1; }));

  document.getElementById('content').innerHTML = `
    <div class="stats-grid">
      ${[['Total Terceros',total,'var(--accent)','en maestro'],['Riesgo Alto',altos,'var(--red)',`${total?Math.round(altos/total*100):0}% del total`],['Riesgo Medio',medios,'var(--amber)',`${total?Math.round(medios/total*100):0}% del total`],['Riesgo Bajo',bajos,'var(--green)',`${total?Math.round(bajos/total*100):0}% del total`],['Sin Valorar',sinVal,'var(--text3)','pendientes'],['Planes Activos',planesActivos,'var(--purple)','de remediaci√≥n']].map(([l,v,c,s])=>`
        <div class="stat-card">
          <div class="stat-label">${l}</div>
          <div class="stat-value" style="color:${c}">${v}</div>
          <div class="stat-sub">${s}</div>
        </div>
      `).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div class="card">
        <div class="card-title">Distribuci√≥n por Nivel de Riesgo</div>
        <div class="chart-bar">
          ${[['Alto',altos,'#ef4444'],['Medio',medios,'#f59e0b'],['Bajo',bajos,'#10b981'],['Sin Valorar',sinVal,'#5a6278']].map(([l,v,c])=>`
            <div class="chart-bar-row">
              <div class="chart-bar-label">${l}</div>
              <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${total?v/total*100:0}%;background:${c}">${v>0?v:''}</div></div>
              <div class="chart-bar-val">${v}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-title">Distribuci√≥n por √Åmbito</div>
        <div class="chart-bar">
          ${Object.entries(ambitoCounts).slice(0,7).map(([amb,cnt])=>{
            const a = state.data.ambitos.find(x=>x.nombre===amb);
            return `<div class="chart-bar-row">
              <div class="chart-bar-label">${amb}</div>
              <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${total?cnt/total*100:0}%;background:${a?.color||'#3b82f6'}">${cnt>0?cnt:''}</div></div>
              <div class="chart-bar-val">${cnt}</div>
            </div>`;
          }).join('') || '<p style="color:var(--text3);font-size:12px">Sin datos</p>'}
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="card">
        <div class="card-title">Pr√≥ximas Homologaciones <span class="badge badge-amber" style="margin-left:6px">${upcoming.length}</span></div>
        ${upcoming.length ? `<table>
          <thead><tr><th>Tercero</th><th>Fecha</th><th>D√≠as</th><th>Riesgo</th></tr></thead>
          <tbody>${upcoming.slice(0,5).map(ter=>{
            const d=daysUntil(ter.fechaSiguiente);
            return `<tr>
              <td style="color:var(--text);font-weight:500">${ter.nombre}</td>
              <td>${fmtDate(ter.fechaSiguiente)}</td>
              <td><span class="badge ${d<=30?'badge-red':'badge-amber'}">${d}d</span></td>
              <td>${riskBadge(ter.riesgo)}</td>
            </tr>`;
          }).join('')}</tbody>
        </table>` : '<p style="color:var(--text3);font-size:12px">Sin homologaciones pr√≥ximas en 90 d√≠as.</p>'}
      </div>
      <div class="card">
        <div class="card-title">Planes de Acci√≥n Activos</div>
        ${planes.filter(p=>p.estado!=='completado').slice(0,4).map(p=>{
          const d=daysUntil(p.fechaLimite);
          return `<div class="action-plan-card" style="padding:12px;margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;gap:12px;">
              <div><div style="font-size:13px;font-weight:500;color:var(--text)">${p.titulo}</div><div style="font-size:11px;color:var(--text3);margin-top:3px">${p.terceroNombre}</div></div>
              <span class="badge ${p.prioridad==='alta'?'badge-red':p.prioridad==='media'?'badge-amber':'badge-green'}">${p.prioridad}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text3)">
              <span>üë§ ${p.responsable}</span>
              ${d!==null?`<span style="color:${d<0?'var(--red)':d<=14?'var(--amber)':'var(--text3)'}">üìÖ ${d<0?'Vencido':d===0?'Hoy':d+'d'}</span>`:''}
            </div>
          </div>`;
        }).join('') || '<p style="color:var(--text3);font-size:12px">Sin planes activos.</p>'}
      </div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TERCEROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let terFilter = { search:'', riesgo:'', ambito:'', pais:'', tipo:'' };
let terSort = { col:'nombre', dir:'asc' };

function terSortBy(col) {
  if (terSort.col === col) terSort.dir = terSort.dir === 'asc' ? 'desc' : 'asc';
  else { terSort.col = col; terSort.dir = 'asc'; }
  renderTerceros();
}

function renderTerceros() {
  // ‚îÄ‚îÄ filter ‚îÄ‚îÄ
  let terceros = state.data.terceros.filter(t => {
    const s = terFilter.search.toLowerCase();
    if (s && !t.nombre.toLowerCase().includes(s) && !(t.cif||'').toLowerCase().includes(s)) return false;
    if (terFilter.riesgo && t.riesgo !== terFilter.riesgo) return false;
    if (terFilter.ambito && !(t.ambitos||[]).includes(terFilter.ambito)) return false;
    if (terFilter.pais && t.pais !== terFilter.pais) return false;
    if (terFilter.tipo && t.tipo !== terFilter.tipo) return false;
    return true;
  });

  // ‚îÄ‚îÄ sort ‚îÄ‚îÄ
  const col = terSort.col, dir = terSort.dir === 'asc' ? 1 : -1;
  const getVal = (t) => {
    if (col === 'nombre') return (t.nombre||'').toLowerCase();
    if (col === 'cif') return (t.cif||'').toLowerCase();
    if (col === 'pais') return (t.pais||'').toLowerCase();
    if (col === 'tipo') return (t.tipo||'').toLowerCase();
    if (col === 'responsable') return (t.responsable||'').toLowerCase();
    if (col === 'riesgo') return ['alto','medio','bajo','en proceso','sin valorar'].indexOf(t.riesgo||'sin valorar');
    if (col === 'fechaSiguiente') return t.fechaSiguiente || 'zzz';
    return '';
  };
  terceros = [...terceros].sort((a,b) => {
    const va = getVal(a), vb = getVal(b);
    return va < vb ? -dir : va > vb ? dir : 0;
  });

  const paises = [...new Set(state.data.terceros.map(t=>t.pais).filter(Boolean))].sort();
  const tipos = [...new Set(state.data.terceros.map(t=>t.tipo).filter(Boolean))].sort();

  // ‚îÄ‚îÄ sort icon helper ‚îÄ‚îÄ
  const si = (c) => {
    if (terSort.col !== c) return `<span style="opacity:.25;margin-left:4px">‚áÖ</span>`;
    return `<span style="margin-left:4px;color:var(--accent)">${terSort.dir==='asc'?'‚Üë':'‚Üì'}</span>`;
  };
  const th = (c, label) => `<th style="cursor:pointer;user-select:none;white-space:nowrap" onclick="terSortBy('${c}')">${label}${si(c)}</th>`;

  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Maestro de Terceros</div><div class="section-sub">${terceros.length} de ${state.data.terceros.length} terceros</div></div>
      <button class="btn btn-primary" onclick="showTerceroModal(null)">${SVG.plus} Dar de Alta Tercero</button>
    </div>
    <div class="toolbar" style="flex-wrap:wrap;gap:8px">
      <div class="search-bar" style="flex:1;min-width:180px;max-width:280px">${SVG.search}<input placeholder="Nombre o CIF..." oninput="terFilter.search=this.value;renderTerceros()" value="${terFilter.search}"></div>
      <select class="form-select" style="width:auto" onchange="terFilter.tipo=this.value;renderTerceros()">
        <option value="">Todos los tipos</option>
        ${tipos.map(tp=>`<option value="${tp}" ${terFilter.tipo===tp?'selected':''}>${tp}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.riesgo=this.value;renderTerceros()">
        <option value="">Todos los riesgos</option>
        ${['sin valorar','en proceso','alto','medio','bajo'].map(r=>`<option value="${r}" ${terFilter.riesgo===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.ambito=this.value;renderTerceros()">
        <option value="">Todos los √°mbitos</option>
        ${state.data.ambitos.map(a=>`<option value="${a.nombre}" ${terFilter.ambito===a.nombre?'selected':''}>${a.nombre}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.pais=this.value;renderTerceros()">
        <option value="">Todos los pa√≠ses</option>
        ${paises.map(p=>`<option value="${p}" ${terFilter.pais===p?'selected':''}>${p}</option>`).join('')}
      </select>
      ${(terFilter.search||terFilter.tipo||terFilter.riesgo||terFilter.ambito||terFilter.pais) ? `<button class="btn btn-ghost btn-sm" onclick="terFilter={search:'',riesgo:'',ambito:'',pais:'',tipo:''};renderTerceros()">‚úï Limpiar filtros</button>` : ''}
    </div>
    <div class="card" style="padding:0;">
      <div class="table-wrap">
        <table>
          <thead><tr>
            ${th('nombre','Nombre')}
            ${th('cif','CIF')}
            ${th('pais','Pa√≠s')}
            ${th('tipo','Tipo')}
            <th>√Åmbitos</th>
            ${th('responsable','Responsable')}
            ${th('fechaSiguiente','Sig. Homologaci√≥n')}
            ${th('riesgo','Riesgo')}
            <th>Estado Hom.</th>
            <th>Acciones</th>
          </tr></thead>
          <tbody>
            ${terceros.length ? terceros.map(t => {
              const d = daysUntil(t.fechaSiguiente);
              const urgent = d !== null && d <= 30 && d > 0;
              return `<tr>
                <td><div style="color:var(--text);font-weight:500">${t.nombre}</div><div style="font-size:11px;color:var(--text3)">${t.denominacion||''}</div></td>
                <td><code style="font-size:11px">${t.cif||'‚Äî'}</code></td>
                <td>${t.pais||'‚Äî'}</td>
                <td><span class="badge badge-blue">${t.tipo||'‚Äî'}</span></td>
                <td><div style="display:flex;flex-wrap:wrap;gap:3px">${(t.ambitos||[]).slice(0,3).map(a=>{
                  const am=state.data.ambitos.find(x=>x.nombre===a);
                  return `<span class="badge" style="background:${(am?.color||'#888')+'22'};color:${am?.color||'#888'}">${a}</span>`;
                }).join('')}${(t.ambitos||[]).length>3?`<span class="badge badge-gray">+${t.ambitos.length-3}</span>`:''}</div></td>
                <td style="color:var(--text)">${t.responsable||'‚Äî'}</td>
                <td><span ${urgent?'style="color:var(--amber)"':''}>${fmtDate(t.fechaSiguiente)}</span>${urgent?`<span class="badge badge-amber" style="margin-left:4px">${d}d</span>`:''}</td>
                <td>${riskBadge(t.riesgo)}</td>
                <td>${homBadge(getActiveHom(t.id)?.fase || getLastHom(t.id)?.fase || 'pendiente')}</td>
                <td>
                  <div style="display:flex;gap:4px;">
                    <button class="btn btn-success btn-sm" onclick="iniciarHom('${t.id}')" title="${getActiveHom(t.id)?'Continuar homologaci√≥n':'Iniciar homologaci√≥n'}">${SVG.play} ${getActiveHom(t.id)?'Continuar':'Homologar'}</button>
                    <button class="btn btn-ghost btn-icon btn-sm" title="Editar" onclick="showTerceroModal('${t.id}')">${SVG.edit}</button>
                    <button class="btn btn-danger btn-icon btn-sm" title="Eliminar" onclick="deleteTercero('${t.id}')">${SVG.trash}</button>
                  </div>
                </td>
              </tr>`;
            }).join('') : `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text3)">Sin resultados</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

async function deleteTercero(id) {
  if (!confirm('¬øEliminar este tercero?')) return;
  await deleteItem('terceros', id);
  notify('Tercero eliminado');
  renderTerceros();
}

// ‚îÄ‚îÄ TERCERO MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTerceroModal(id) {
  const t = id ? state.data.terceros.find(x=>x.id===id) : null;
  const isNew = !t;

  openModal(`
    <div class="modal modal-xl">
      <div class="modal-header">
        <div class="modal-title">${isNew ? 'Dar de Alta Tercero' : 'Editar Tercero: ' + t.nombre}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="tabs" id="t-tabs">
          <div class="tab active" onclick="switchTab('datos')">Datos Generales</div>
          <div class="tab" onclick="switchTab('riesgo')">Riesgo & Comentarios</div>
          <div class="tab" onclick="switchTab('remediacion')">Plan de Remediaci√≥n</div>
          ${!isNew ? `<div class="tab" onclick="switchTab('fechas')">Homologaci√≥n</div>` : ''}
        </div>

        <!-- TAB: DATOS -->
        <div id="ttab-datos">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="t-nombre" value="${t?.nombre||''}" placeholder="Nombre comercial"></div>
            <div class="form-group"><label class="form-label">Denominaci√≥n Social *</label><input class="form-input" id="t-denominacion" value="${t?.denominacion||''}" placeholder="Raz√≥n social"></div>
            <div class="form-group"><label class="form-label">Grupo Empresarial</label><input class="form-input" id="t-grupo" value="${t?.grupo||''}" placeholder="Grupo al que pertenece"></div>
            <div class="form-group"><label class="form-label">CIF / NIF</label><input class="form-input" id="t-cif" value="${t?.cif||''}" placeholder="B12345678"></div>
            <div class="form-group"><label class="form-label">Domicilio Fiscal</label><input class="form-input" id="t-domicilio" value="${t?.domicilio||''}" placeholder="Direcci√≥n fiscal"></div>
            <div class="form-group"><label class="form-label">Pa√≠s</label><input class="form-input" id="t-pais" value="${t?.pais||''}" placeholder="Espa√±a" list="countries-list"><datalist id="countries-list">${COUNTRIES.map(c=>`<option value="${c}">`).join('')}</datalist></div>
            <div class="form-group"><label class="form-label">Nombre Representante</label><input class="form-input" id="t-representante" value="${t?.representante||''}" placeholder="Nombre y apellidos"></div>
            <div class="form-group"><label class="form-label">Responsable en la Compa√±√≠a</label>
              <select class="form-select" id="t-responsable">
                <option value="">Seleccionar...</option>
                ${state.data.usuarios.map(u=>`<option value="${u.nombre}" ${t?.responsable===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de Tercero</label>
            <select class="form-select" id="t-tipo" style="max-width:300px">
              <option value="">Seleccionar...</option>
              ${(state.data.tipos||[]).map(tp => {
                const label = [tp.nivel1, tp.nivel2, tp.nivel3].filter(Boolean).join(' ‚Ä∫ ');
                const val = tp.nivel2 || tp.nivel1 || '';
                return `<option value="${val}" ${t?.tipo===val?'selected':''}>${label}</option>`;
              }).join('')}
              ${!(state.data.tipos||[]).length ? `
                <option value="Proveedor Directo" ${t?.tipo==='Proveedor Directo'?'selected':''}>Proveedor Directo</option>
                <option value="Proveedor Indirecto" ${t?.tipo==='Proveedor Indirecto'?'selected':''}>Proveedor Indirecto</option>
                <option value="Cliente" ${t?.tipo==='Cliente'?'selected':''}>Cliente</option>
              ` : ''}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">√Åmbitos de Riesgo Aplicables</label>
            <div class="chip-group">
              ${renderChipGroup(state.data.ambitos.map(a=>({value:a.nombre,label:a.nombre,color:a.color})), t?.ambitos||[], 'ter-ambitos')}
            </div>
          </div>
          ${isNew ? `
            <div class="info-box" style="margin-top:12px">
              ‚ÑπÔ∏è Las fechas de homologaci√≥n se registrar√°n una vez se complete el cuestionario de evaluaci√≥n del tercero.
            </div>
          ` : ''}
        </div>

        <!-- TAB: RIESGO -->
        <div id="ttab-riesgo" style="display:none">
          <div class="form-group">
            <label class="form-label">Nivel de Riesgo</label>
            <select class="form-select" id="t-riesgo" style="max-width:280px">
              <option value="sin valorar" ${(t?.riesgo||'sin valorar')==='sin valorar'?'selected':''}>Sin valorar</option>
              <option value="en proceso" ${t?.riesgo==='en proceso'?'selected':''}>En proceso</option>
              <option value="alto" ${t?.riesgo==='alto'?'selected':''}>Alto</option>
              <option value="medio" ${t?.riesgo==='medio'?'selected':''}>Medio</option>
              <option value="bajo" ${t?.riesgo==='bajo'?'selected':''}>Bajo</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Comentarios</label>
            <textarea class="form-textarea" id="t-comentarios" rows="6" placeholder="Notas, observaciones, contexto...">${t?.comentarios||''}</textarea>
          </div>
        </div>

        <!-- TAB: REMEDIACION -->
        <div id="ttab-remediacion" style="display:none">
          <div class="form-group">
            <label class="form-label">Plan de Remediaci√≥n</label>
            <textarea class="form-textarea" id="t-remediacion" rows="6" placeholder="Describe las acciones de remediaci√≥n necesarias...">${t?.remediacion||''}</textarea>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Asignado a</label>
              <select class="form-select" id="t-remediacionUser">
                <option value="">Sin asignar</option>
                ${state.data.usuarios.map(u=>`<option value="${u.email}" ${t?.remediacionUser===u.email?'selected':''}>${u.nombre}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha L√≠mite</label>
              <input class="form-input" id="t-remediacionFecha" type="date" value="${t?.remediacionFecha||''}">
            </div>
          </div>
        </div>

        <!-- TAB: FECHAS (solo edici√≥n) -->
        ${!isNew ? `
          <div id="ttab-fechas" style="display:none">
            <div class="warn-box" style="margin-bottom:16px">
              ‚ö†Ô∏è Las fechas de homologaci√≥n deben actualizarse √∫nicamente tras completar el proceso de evaluaci√≥n mediante cuestionario.
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Fecha Primera Homologaci√≥n</label>
                <input class="form-input" id="t-fechaPrimera" type="date" value="${t?.fechaPrimera||''}">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha √öltima Homologaci√≥n</label>
                <input class="form-input" id="t-fechaUltima" type="date" value="${t?.fechaUltima||''}">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Siguiente Homologaci√≥n</label>
                <input class="form-input" id="t-fechaSiguiente" type="date" value="${t?.fechaSiguiente||''}">
              </div>
            </div>
          </div>
        ` : ''}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveTercero('${id||''}')">${SVG.check} ${isNew ? 'Dar de Alta' : 'Guardar Cambios'}</button>
      </div>
    </div>
  `);
}

function switchTab(name) {
  ['datos','riesgo','remediacion','fechas'].forEach(t => {
    const el = document.getElementById('ttab-'+t); if (el) el.style.display = t===name?'block':'none';
  });
  document.querySelectorAll('#t-tabs .tab').forEach((el,i) => {
    const names = ['datos','riesgo','remediacion','fechas'];
    el.classList.toggle('active', names[i]===name);
  });
}

async function saveTercero(id) {
  const nombre = document.getElementById('t-nombre')?.value?.trim();
  if (!nombre) { notify('El nombre es obligatorio', 'error'); return; }

  const ambitos = getChipValues('ter-ambitos');

  const existing = id ? state.data.terceros.find(x=>x.id===id) : null;
  const item = {
    id: id || genId(),
    nombre,
    denominacion: document.getElementById('t-denominacion')?.value||'',
    grupo:        document.getElementById('t-grupo')?.value||'',
    cif:          document.getElementById('t-cif')?.value||'',
    domicilio:    document.getElementById('t-domicilio')?.value||'',
    pais:         document.getElementById('t-pais')?.value||'',
    representante:document.getElementById('t-representante')?.value||'',
    responsable:  document.getElementById('t-responsable')?.value||'',
    tipo:         document.getElementById('t-tipo')?.value||'',
    ambitos,
    // Fechas: solo en edici√≥n (tab fechas); en creaci√≥n se quedan vac√≠as
    fechaPrimera:  document.getElementById('t-fechaPrimera')?.value  || existing?.fechaPrimera  || '',
    fechaUltima:   document.getElementById('t-fechaUltima')?.value   || existing?.fechaUltima   || '',
    fechaSiguiente:document.getElementById('t-fechaSiguiente')?.value|| existing?.fechaSiguiente|| '',
    riesgo:        document.getElementById('t-riesgo')?.value || existing?.riesgo || 'sin valorar',
    comentarios:   document.getElementById('t-comentarios')?.value||'',
    remediacion:   document.getElementById('t-remediacion')?.value||'',
    remediacionUser:document.getElementById('t-remediacionUser')?.value||'',
    remediacionFecha:document.getElementById('t-remediacionFecha')?.value||'',
    activo: true,
  };
  await saveItem('terceros', item);
  notify(id ? 'Tercero actualizado correctamente' : 'Tercero dado de alta correctamente');
  closeModal();
  renderTerceros();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLANES DE ACCI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPlanes() {
  const planes = state.data.planes || [];
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Planes de Acci√≥n</div><div class="section-sub">${planes.length} planes registrados</div></div>
      <button class="btn btn-primary" onclick="showPlanModal(null)">${SVG.plus} Nuevo Plan</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
      ${[['pendiente','Pendiente','var(--amber)'],['en_progreso','En Progreso','var(--accent)'],['completado','Completado','var(--green)']].map(([s,l,c])=>`
        <div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="color:${c}">${planes.filter(p=>p.estado===s).length}</div></div>
      `).join('')}
    </div>
    ${['pendiente','en_progreso','completado'].map(estado => {
      const group = planes.filter(p=>p.estado===estado);
      if (!group.length) return '';
      const labels = {pendiente:'Pendiente',en_progreso:'En Progreso',completado:'Completado'};
      const colors = {pendiente:'var(--amber)',en_progreso:'var(--accent)',completado:'var(--green)'};
      return `<div style="margin-bottom:24px;">
        <div style="font-size:11px;font-weight:700;color:${colors[estado]};text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">${labels[estado]} ¬∑ ${group.length}</div>
        ${group.map(p => {
          const d = daysUntil(p.fechaLimite);
          return `<div class="action-plan-card">
            <div style="display:flex;justify-content:space-between;gap:16px">
              <div style="flex:1">
                <div style="color:var(--text);font-weight:500;margin-bottom:3px">${p.titulo}</div>
                <div style="font-size:12px;color:var(--text3)">${p.terceroNombre}</div>
                ${p.descripcion?`<div style="font-size:12px;color:var(--text2);margin-top:6px">${p.descripcion}</div>`:''}
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
                <span class="badge ${p.prioridad==='alta'?'badge-red':p.prioridad==='media'?'badge-amber':'badge-green'}">${p.prioridad}</span>
                ${d!==null?`<span style="font-size:11px;color:${d<0?'var(--red)':d<=7?'var(--amber)':'var(--text3)'}">üìÖ ${d<0?'Vencido '+Math.abs(d)+'d':d===0?'Hoy':d+' d√≠as'}</span>`:''}
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
              <span style="font-size:12px;color:var(--text3)">üë§ ${p.responsable||'Sin asignar'}</span>
              <div style="display:flex;gap:6px">
                <button class="btn btn-secondary btn-sm" onclick="showPlanModal('${p.id}')">${SVG.edit} Editar</button>
                ${estado!=='completado'?`<button class="btn btn-ghost btn-sm" onclick="completePlan('${p.id}')">${SVG.check} Completar</button>`:''}
                <button class="btn btn-danger btn-icon btn-sm" onclick="deletePlan('${p.id}')">${SVG.trash}</button>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }).join('')}
    ${!planes.length?`<div class="empty-state"><p>No hay planes de acci√≥n registrados.</p></div>`:''}
  `;
}

async function completePlan(id) {
  const p = state.data.planes.find(x=>x.id===id); if(!p) return;
  p.estado = 'completado'; await saveItem('planes', p); notify('Plan completado'); renderPlanes();
}
async function deletePlan(id) {
  if (!confirm('¬øEliminar este plan?')) return;
  await deleteItem('planes', id); notify('Plan eliminado'); renderPlanes();
}

function showPlanModal(id) {
  const p = id ? state.data.planes.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">${p?'Editar Plan':'Nuevo Plan de Acci√≥n'}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Tercero</label>
          <select class="form-select" id="p-tercero">
            <option value="">Seleccionar...</option>
            ${state.data.terceros.map(t=>`<option value="${t.id}" data-nombre="${t.nombre}" ${p?.terceroId===t.id?'selected':''}>${t.nombre}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">T√≠tulo *</label><input class="form-input" id="p-titulo" value="${p?.titulo||''}" placeholder="T√≠tulo del plan"></div>
        <div class="form-group"><label class="form-label">Descripci√≥n</label><textarea class="form-textarea" id="p-descripcion">${p?.descripcion||''}</textarea></div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Responsable</label>
            <select class="form-select" id="p-responsable">
              <option value="">Sin asignar</option>
              ${state.data.usuarios.map(u=>`<option value="${u.email}" ${p?.responsable===u.email?'selected':''}>${u.nombre}</option>`).join('')}
            </select>
          </div>
          <div class="form-group"><label class="form-label">Fecha L√≠mite</label><input class="form-input" id="p-fechaLimite" type="date" value="${p?.fechaLimite||''}"></div>
          <div class="form-group"><label class="form-label">Prioridad</label>
            <select class="form-select" id="p-prioridad">
              <option value="alta" ${(p?.prioridad||'alta')==='alta'?'selected':''}>Alta</option>
              <option value="media" ${p?.prioridad==='media'?'selected':''}>Media</option>
              <option value="baja" ${p?.prioridad==='baja'?'selected':''}>Baja</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Estado</label>
            <select class="form-select" id="p-estado">
              <option value="pendiente" ${(p?.estado||'pendiente')==='pendiente'?'selected':''}>Pendiente</option>
              <option value="en_progreso" ${p?.estado==='en_progreso'?'selected':''}>En Progreso</option>
              <option value="completado" ${p?.estado==='completado'?'selected':''}>Completado</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="savePlan('${id||''}')">${SVG.check} Guardar</button>
      </div>
    </div>
  `);
}

async function savePlan(id) {
  const titulo = document.getElementById('p-titulo').value.trim();
  if (!titulo) { notify('El t√≠tulo es obligatorio', 'error'); return; }
  const sel = document.getElementById('p-tercero');
  const item = {
    id: id||genId(), titulo,
    terceroId: sel.value,
    terceroNombre: sel.options[sel.selectedIndex]?.dataset.nombre||'',
    descripcion: document.getElementById('p-descripcion').value,
    responsable: document.getElementById('p-responsable').value,
    fechaLimite: document.getElementById('p-fechaLimite').value,
    prioridad:   document.getElementById('p-prioridad').value,
    estado:      document.getElementById('p-estado').value,
    creado: id?(state.data.planes.find(p=>p.id===id)?.creado||new Date().toISOString().split('T')[0]):new Date().toISOString().split('T')[0],
  };
  await saveItem('planes', item);
  notify(id?'Plan actualizado':'Plan creado');
  closeModal(); renderPlanes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USUARIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROL_COLORS = { admin:'badge-red', usuario:'badge-blue', aprobador:'badge-amber', supervisor:'badge-purple' };
const ROLES_LIST = ['admin','usuario','aprobador','supervisor'];

function renderUsuarios() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Usuarios y Roles</div><div class="section-sub">${state.data.usuarios.length} usuarios</div></div>
      <button class="btn btn-primary" onclick="showUsuarioModal(null)">${SVG.plus} Nuevo Usuario</button>
    </div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table>
        <thead><tr><th>Nombre</th><th>Email</th><th>Roles</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody>
          ${state.data.usuarios.map(u=>`<tr>
            <td><div style="display:flex;align-items:center;gap:10px">
              <div class="user-avatar" style="width:32px;height:32px;font-size:12px">${u.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div>
              <span style="color:var(--text);font-weight:500">${u.nombre}</span>
            </div></td>
            <td>${u.email}</td>
            <td><div style="display:flex;gap:4px;flex-wrap:wrap">${(u.roles||[]).map(r=>`<span class="badge ${ROL_COLORS[r]||'badge-gray'}">${r.charAt(0).toUpperCase()+r.slice(1)}</span>`).join('')}</div></td>
            <td><span class="badge ${u.activo?'badge-green':'badge-gray'}">${u.activo?'Activo':'Inactivo'}</span></td>
            <td><div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showUsuarioModal('${u.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteUsuario('${u.id}')">${SVG.trash}</button>
            </div></td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-title">Descripci√≥n de Roles</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        ${[['Admin','admin','Acceso completo. Configura todos los m√≥dulos.'],['Usuario','usuario','Puede consultar terceros y rellenar cuestionarios.'],['Aprobador','aprobador','Valida resultados de cuestionarios y planes.'],['Supervisor','supervisor','Visibilidad global de todos los terceros y planes.']].map(([l,k,d])=>`
          <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border)">
            <span class="badge ${ROL_COLORS[k]}">${l}</span>
            <div style="font-size:12px;color:var(--text2);margin-top:8px">${d}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

async function deleteUsuario(id) {
  if (!confirm('¬øEliminar este usuario?')) return;
  await deleteItem('usuarios', id); notify('Usuario eliminado'); renderUsuarios();
}

function showUsuarioModal(id) {
  const u = id ? state.data.usuarios.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">${u?'Editar Usuario':'Nuevo Usuario'}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre completo *</label><input class="form-input" id="u-nombre" value="${u?.nombre||''}" placeholder="Nombre Apellidos"></div>
        <div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="u-email" type="email" value="${u?.email||''}" placeholder="usuario@empresa.com"></div>
        <div class="form-group">
          <label class="form-label">Roles (puede seleccionar varios)</label>
          <div class="chip-group">
            ${renderChipGroup(ROLES_LIST.map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1)})), u?.roles||[], 'usr-roles')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <div style="display:flex;align-items:center;gap:10px">
            <label class="toggle"><input type="checkbox" id="u-activo" ${u?.activo!==false?'checked':''}><span class="toggle-slider"></span></label>
            <span style="font-size:13px;color:var(--text2)">Usuario activo</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveUsuario('${id||''}')">${SVG.check} Guardar</button>
      </div>
    </div>
  `);
}

async function saveUsuario(id) {
  const nombre = document.getElementById('u-nombre').value.trim();
  const email  = document.getElementById('u-email').value.trim();
  if (!nombre||!email) { notify('Nombre y email son obligatorios', 'error'); return; }
  const roles = getChipValues('usr-roles');
  const item = { id:id||genId(), nombre, email, roles, activo:document.getElementById('u-activo').checked };
  await saveItem('usuarios', item);
  notify(id?'Usuario actualizado':'Usuario creado');
  closeModal(); renderUsuarios();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √ÅMBITOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAmbitos() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">√Åmbitos de Riesgo</div><div class="section-sub">${state.data.ambitos.length} √°mbitos</div></div>
      <button class="btn btn-primary" onclick="showAmbitoModal(null)">${SVG.plus} Nuevo √Åmbito</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">
      ${state.data.ambitos.map(a => {
        const cuests = state.data.cuestionarios.filter(c=>c.ambito_id===a.id);
        const tercs  = state.data.terceros.filter(t=>(t.ambitos||[]).includes(a.nombre));
        return `<div class="card" style="border-left:3px solid ${a.color}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
            <div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${a.color}">${a.nombre}</div><div style="font-size:12px;color:var(--text3);margin-top:4px">${a.descripcion||''}</div></div>
            <div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showAmbitoModal('${a.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteAmbito('${a.id}')">${SVG.trash}</button>
            </div>
          </div>
          <div style="border-top:1px solid var(--border);padding-top:12px">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:8px"><span>üë§ Responsable</span><span style="color:var(--text)">${a.responsable||'‚Äî'}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:8px"><span>üìã Cuestionarios</span><span class="badge" style="background:${a.color+'22'};color:${a.color}">${cuests.length}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2)"><span>üè¢ Terceros</span><span class="badge badge-gray">${tercs.length}</span></div>
          </div>
          ${cuests.length?`<div style="margin-top:10px">${cuests.map(c=>`<span class="badge badge-blue" style="margin:2px">${c.nombre}</span>`).join('')}</div>`:''}
        </div>`;
      }).join('')}
    </div>
  `;
}

async function deleteAmbito(id) {
  if (!confirm('¬øEliminar este √°mbito?')) return;
  await deleteItem('ambitos', id); notify('√Åmbito eliminado'); renderAmbitos();
}
function showAmbitoModal(id) {
  const a = id ? state.data.ambitos.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header"><div class="modal-title">${a?'Editar √Åmbito':'Nuevo √Åmbito de Riesgo'}</div><button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="a-nombre" value="${a?.nombre||''}" placeholder="Ej: Cyber, ESG..."></div>
        <div class="form-group"><label class="form-label">Descripci√≥n</label><input class="form-input" id="a-desc" value="${a?.descripcion||''}" placeholder="Breve descripci√≥n"></div>
        <div class="form-group"><label class="form-label">Responsable</label>
          <select class="form-select" id="a-resp"><option value="">Sin responsable</option>
            ${state.data.usuarios.map(u=>`<option value="${u.nombre}" ${a?.responsable===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">Color identificativo</label>
          <div style="display:flex;align-items:center;gap:12px"><input type="color" id="a-color" value="${a?.color||'#3b82f6'}" style="width:48px;height:36px;border:none;background:none;cursor:pointer;border-radius:4px"><span style="font-size:12px;color:var(--text2)">Usado para identificar el √°mbito visualmente</span></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveAmbito('${id||''}')">${SVG.check} Guardar</button></div>
    </div>
  `);
}
async function saveAmbito(id) {
  const nombre = document.getElementById('a-nombre').value.trim();
  if (!nombre) { notify('Nombre obligatorio', 'error'); return; }
  const item = { id:id||genId(), nombre, descripcion:document.getElementById('a-desc').value, responsable:document.getElementById('a-resp').value, color:document.getElementById('a-color').value, cuestionarios:id?(state.data.ambitos.find(a=>a.id===id)?.cuestionarios||[]):[] };
  await saveItem('ambitos', item); notify(id?'√Åmbito actualizado':'√Åmbito creado'); closeModal(); renderAmbitos();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIPOS DE TERCERO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTipos() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Tipos de Tercero</div><div class="section-sub">Jerarqu√≠a de hasta 3 niveles</div></div>
      <button class="btn btn-primary" onclick="showTipoModal(null)">${SVG.plus} Nuevo Tipo</button>
    </div>
    <div class="card" style="padding:0"><div class="table-wrap"><table>
      <thead><tr><th>Nivel 1</th><th>Nivel 2</th><th>Nivel 3</th><th>Terceros Asociados</th><th>Acciones</th></tr></thead>
      <tbody>
        ${state.data.tipos.map(t => {
          const tercs = state.data.terceros.filter(x=>(t.terceros||[]).includes(x.id));
          return `<tr>
            <td style="color:var(--text);font-weight:500">${t.nivel1||'‚Äî'}</td>
            <td>${t.nivel2||'‚Äî'}</td><td>${t.nivel3||'‚Äî'}</td>
            <td><div style="display:flex;flex-wrap:wrap;gap:4px">
              ${tercs.slice(0,3).map(x=>`<span class="badge badge-gray">${x.nombre}</span>`).join('')}
              ${tercs.length>3?`<span class="badge badge-gray">+${tercs.length-3}</span>`:''}
              ${!tercs.length?'<span style="color:var(--text3);font-size:12px">Sin terceros</span>':''}
            </div></td>
            <td><div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showTipoModal('${t.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTipo('${t.id}')">${SVG.trash}</button>
            </div></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div></div>
  `;
}
async function deleteTipo(id) {
  if (!confirm('¬øEliminar este tipo?')) return;
  await deleteItem('tipos', id); notify('Tipo eliminado'); renderTipos();
}
function showTipoModal(id) {
  const t = id ? state.data.tipos.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header"><div class="modal-title">${t?'Editar Tipo':'Nuevo Tipo de Tercero'}</div><button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button></div>
      <div class="modal-body">
        <p style="font-size:12px;color:var(--text3);margin-bottom:16px">Solo el Nivel 1 es obligatorio.</p>
        <div class="form-group"><label class="form-label">Nivel 1 *</label><input class="form-input" id="tp-n1" value="${t?.nivel1||''}" placeholder="Ej: Proveedor, Cliente..."></div>
        <div class="form-group"><label class="form-label">Nivel 2</label><input class="form-input" id="tp-n2" value="${t?.nivel2||''}" placeholder="Ej: Proveedor Directo..."></div>
        <div class="form-group"><label class="form-label">Nivel 3</label><input class="form-input" id="tp-n3" value="${t?.nivel3||''}" placeholder="Ej: Proveedor Cr√≠tico TI..."></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveTipo('${id||''}')">${SVG.check} Guardar</button></div>
    </div>
  `);
}
async function saveTipo(id) {
  const n1 = document.getElementById('tp-n1').value.trim();
  if (!n1) { notify('Nivel 1 obligatorio', 'error'); return; }
  const item = { id:id||genId(), nivel1:n1, nivel2:document.getElementById('tp-n2').value, nivel3:document.getElementById('tp-n3').value, terceros:id?(state.data.tipos.find(t=>t.id===id)?.terceros||[]):[] };
  await saveItem('tipos', item); notify(id?'Tipo actualizado':'Tipo creado'); closeModal(); renderTipos();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUESTIONARIOS ‚Äî WIZARD (estado en objeto JS, no en DOM)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let W = {}; // wizard state

function initWizard(id) {
  const c = id ? state.data.cuestionarios.find(x=>x.id===id) : null;
  W = {
    step: 1,
    id: id||null,
    nombre: c?.nombre||'',
    tipo: c?.tipo||'due_diligence',
    ambito_id: c?.ambito_id||'',
    ambito: c?.ambito||'',
    umbralMaterial: c?.umbralMaterial||2,
    aplicaTodos: c?.aplicaTodos !== false,
    paises: c?.paises ? [...c.paises] : [],
    ambitosAplicables: c?.ambitosAplicables ? [...c.ambitosAplicables] : [],
    nivelesRiesgo: c?.nivelesRiesgo ? [...c.nivelesRiesgo] : [],
    tiposProveedor: c?.tiposProveedor ? [...c.tiposProveedor] : [],
    preguntas: c?.preguntas ? JSON.parse(JSON.stringify(c.preguntas)) : [],
    nivelRiesgoBajo:  c?.nivelRiesgoBajo  || {min:0, max:3},
    nivelRiesgoMedio: c?.nivelRiesgoMedio || {min:4, max:6},
    nivelRiesgoAlto:  c?.nivelRiesgoAlto  || {min:7, max:99},
    bloqueoRedFlag: c?.bloqueoRedFlag !== false,
    aprobadores: c?.aprobadores ? {...c.aprobadores} : {alto:'',medio:'',bajo:''},
    creado: c?.creado || new Date().toISOString().split('T')[0],
  };
}

function renderCuestionarios() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Cuestionarios</div><div class="section-sub">${state.data.cuestionarios.length} cuestionarios</div></div>
      <button class="btn btn-primary" onclick="openWizard(null)">${SVG.plus} Nuevo Cuestionario</button>
    </div>
    ${!state.data.cuestionarios.length ? `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>Sin cuestionarios. Crea el primero.</p></div>` : `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px">
        ${state.data.cuestionarios.map(c => {
          const amb = state.data.ambitos.find(a=>a.id===c.ambito_id);
          const tipoLabel = {general:'üåê General',scope_check:'üîç Scope Check',risk_scoring:'üìä Risk Scoring',due_diligence:'üìã Due Diligence'}[c.tipo]||c.tipo||'Due Diligence';
          const tipoBadge = {general:'background:rgba(6,182,212,.12);color:#06b6d4',scope_check:'background:rgba(139,92,246,.12);color:#8b5cf6',risk_scoring:'background:var(--amber-soft);color:var(--amber)',due_diligence:'background:var(--accent-glow);color:var(--accent)'}[c.tipo]||'background:var(--surface3);color:var(--text2)';
          const scOnly = (c.preguntas||[]).filter(p=>p.soloCompleta).length;
          return `<div class="card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
              <div style="flex:1">
                <span class="badge" style="${tipoBadge};margin-bottom:8px">${tipoLabel}</span>
                <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:6px;margin-top:6px">${c.nombre}</div>
                ${amb?`<span class="badge" style="background:${amb.color+'22'};color:${amb.color}">${amb.nombre}</span>`:''}
              </div>
              <div style="display:flex;gap:4px">
                <button class="btn btn-ghost btn-icon btn-sm" onclick="openWizard('${c.id}')">${SVG.edit}</button>
                <button class="btn btn-danger btn-icon btn-sm" onclick="deleteCuestionario('${c.id}')">${SVG.trash}</button>
              </div>
            </div>
            <div style="border-top:1px solid var(--border);padding-top:12px">
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px"><span>üìù Preguntas</span><span class="badge badge-blue">${(c.preguntas||[]).length}${scOnly?` (${scOnly} solo completa)`:''}</span></div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px"><span>üåç Aplica a todos</span><span class="badge ${c.aplicaTodos?'badge-green':'badge-amber'}">${c.aplicaTodos?'S√≠':'Filtros espec√≠ficos'}</span></div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2)"><span>üìÖ Modificado</span><span>${fmtDate(c.modificado||c.creado)}</span></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    `}
  `;
}

async function deleteCuestionario(id) {
  if (!confirm('¬øEliminar este cuestionario?')) return;
  await deleteItem('cuestionarios', id); notify('Cuestionario eliminado'); renderCuestionarios();
}

function openWizard(id) {
  initWizard(id);
  renderWizardModal();
}

function renderWizardModal() {
  const STEPS = ['Informaci√≥n general','Preguntas','Niveles de riesgo','Aprobadores'];
  openModal(`
    <div class="modal modal-xl">
      <div class="modal-header">
        <div style="flex:1">
          <div class="modal-title">${W.id ? 'Editar Cuestionario' : 'Nuevo Cuestionario'}</div>
          <div class="wizard-steps" style="margin-top:10px">
            ${STEPS.map((s,i) => {
              const cls = i+1 === W.step ? 'active' : i+1 < W.step ? 'done' : '';
              return `<div class="wizard-step ${cls}"><div class="step-dot">${i+1 < W.step ? '‚úì' : i+1}</div>${s}</div>${i<STEPS.length-1?'<span class="step-sep">‚Ä∫</span>':''}`;
            }).join('')}
          </div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body" id="wbody">${renderWStep()}</div>
      <div class="modal-footer">
        <div style="flex:1">
          ${W.step > 1 ? `<button class="btn btn-secondary" onclick="wNav(-1)">‚Üê Anterior</button>` : ''}
        </div>
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        ${W.step < 4
          ? `<button class="btn btn-primary" onclick="wNav(1)">Siguiente ‚Üí</button>`
          : `<button class="btn btn-primary" onclick="wSave()">${SVG.check} Guardar Cuestionario</button>`}
      </div>
    </div>
  `);
}

function renderWStep() {
  if (W.step === 1) {
    return `
      <div class="form-group">
        <label class="form-label">Nombre del Cuestionario *</label>
        <input class="form-input" id="wn" value="${W.nombre}" placeholder="Ej: Cuestionario Cyber B√°sico" oninput="W.nombre=this.value">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo de Cuestionario *</label>
        <select class="form-select" id="wt" onchange="W.tipo=this.value; document.getElementById('wa-row').style.display=this.value==='due_diligence'?'block':'none'; document.getElementById('umb-row').style.display=this.value==='scope_check'?'block':'none'">
          <option value="general" ${W.tipo==='general'?'selected':''}>üåê General ‚Äî Aplica siempre, primero en Due Diligence</option>
          <option value="scope_check" ${W.tipo==='scope_check'?'selected':''}>üîç Scope Check ‚Äî Determina si el tercero es material</option>
          <option value="risk_scoring" ${W.tipo==='risk_scoring'?'selected':''}>üìä Risk Scoring ‚Äî Evaluaci√≥n interna de riesgo inicial</option>
          <option value="due_diligence" ${W.tipo==='due_diligence'?'selected':''}>üìã Due Diligence ‚Äî Por √°mbito de riesgo espec√≠fico</option>
        </select>
        <div style="margin-top:8px;padding:10px;background:var(--surface3);border-radius:var(--radius-sm);font-size:12px;color:var(--text3)">
          <strong style="color:var(--text2)">Scope Check / Risk Scoring / General:</strong> Un √∫nico activo. &nbsp;¬∑&nbsp;
          <strong style="color:var(--text2)">Due Diligence:</strong> Uno por √°mbito. Las preguntas pueden marcarse "Solo Completa" para aparecer solo en DD de riesgo alto.
        </div>
      </div>
      <div id="umb-row" style="display:${W.tipo==='scope_check'?'block':'none'}">
        <div class="form-group">
          <label class="form-label">Umbral de materialidad (puntuaci√≥n m√≠nima para ser material)</label>
          <input class="form-input" type="number" id="wumb" value="${W.umbralMaterial}" style="max-width:120px" oninput="W.umbralMaterial=parseInt(this.value)||0">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Terceros con puntuaci√≥n ‚â• este valor continuar√°n el proceso de homologaci√≥n.</div>
        </div>
      </div>
      <div id="wa-row" style="display:${W.tipo==='due_diligence'?'block':'none'}">
      <div class="form-group">
        <label class="form-label">√Åmbito de Riesgo *</label>
        <select class="form-select" id="wa" onchange="W.ambito_id=this.value; const opt=this.options[this.selectedIndex]; W.ambito=opt?opt.text:''; ">
          <option value="">Seleccionar √°mbito...</option>
          ${state.data.ambitos.map(a=>`<option value="${a.id}" ${W.ambito_id===a.id?'selected':''}>${a.nombre}</option>`).join('')}
        </select>
      </div>
      </div><!-- /wa-row -->
      <hr class="divider">
      <div class="form-group">
        <label class="form-label">Aplicabilidad del cuestionario</label>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
            <input type="radio" name="wapl" value="todos" ${W.aplicaTodos?'checked':''} onchange="W.aplicaTodos=true; document.getElementById('wfiltros').style.display='none'">
            <span style="font-size:13px">Aplicar a <strong>todos</strong> los terceros</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
            <input type="radio" name="wapl" value="filtro" ${!W.aplicaTodos?'checked':''} onchange="W.aplicaTodos=false; document.getElementById('wfiltros').style.display='block'">
            <span style="font-size:13px">Aplicar seg√∫n <strong>filtros espec√≠ficos</strong></span>
          </label>
        </div>
      </div>
      <div id="wfiltros" style="display:${!W.aplicaTodos?'block':'none'};background:var(--surface2);border-radius:var(--radius);padding:16px;border:1px solid var(--border)">
        <div class="form-group">
          <label class="form-label">Por Pa√≠s</label>
          <div class="tag-wrap-pos">
            <div class="tag-input-wrap" id="country-tag-wrap" onclick="document.getElementById('country-input').focus()">
              ${W.paises.map(p=>`<span class="tag-pill">${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">√ó</button></span>`).join('')}
              <input class="tag-input-field" id="country-input" placeholder="${W.paises.length?'':'Escribir pa√≠s...'}" oninput="filterCountries(this.value)" onkeydown="countryKeydown(event)" autocomplete="off">
            </div>
            <div class="tag-dropdown" id="country-dd" style="display:none"></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Por √Åmbito de Riesgo</label>
          <div class="chip-group">${renderChipGroup(state.data.ambitos.map(a=>({value:a.nombre,label:a.nombre,color:a.color})), W.ambitosAplicables, 'wamb')}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Por Nivel de Riesgo</label>
          <div class="chip-group">${renderChipGroup(['alto','medio','bajo','sin valorar'].map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1)})), W.nivelesRiesgo, 'wniv')}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Por Tipo de Proveedor</label>
          <div class="chip-group">${renderChipGroup(['Proveedor Directo','Proveedor Indirecto','Cliente'].map(tp=>({value:tp,label:tp})), W.tiposProveedor, 'wtp')}</div>
        </div>
      </div>
    `;
  }

  if (W.step === 2) {
    const hasProposal = W._importProposal;
    return `
      ${hasProposal ? `
        <div class="ai-proposal-bar">
          <span class="ai-proposal-badge">‚ú® IA</span>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:500">Propuesta generada por Claude ¬∑ ${W.preguntas.length} pregunta(s) extra√≠da(s)</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px">Revisa y edita antes de confirmar. Puedes a√±adir, eliminar o modificar cualquier pregunta.</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="wClearProposal()" title="Descartar propuesta y empezar desde cero">‚úï Descartar</button>
        </div>
      ` : `
        <div class="import-zone" id="import-zone" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="wHandleDrop(event)">
          <input type="file" accept=".xlsx,.xls,.csv,.pdf" onchange="wHandleFile(this.files[0])">
          <span class="import-zone-icon">üìÑ</span>
          <div style="font-size:14px;font-weight:500;color:var(--text);margin-bottom:6px">Arrastra un Excel o PDF aqu√≠</div>
          <div style="font-size:12px;color:var(--text3)">O haz clic para seleccionar ¬∑ Compatible con .xlsx, .xls, .csv, .pdf</div>
          <div style="margin-top:12px;padding:8px 14px;background:var(--accent-glow);border-radius:var(--radius-sm);display:inline-block;font-size:11px;color:var(--accent)">
            ‚ú® Claude analizar√° el documento y propondr√° la estructura del cuestionario
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin:14px 0">
          <hr style="flex:1;border:none;border-top:1px solid var(--border)">
          <span style="font-size:11px;color:var(--text3)">o crea las preguntas manualmente</span>
          <hr style="flex:1;border:none;border-top:1px solid var(--border)">
        </div>
      `}
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span style="font-size:13px;color:var(--text2)">${W.preguntas.length} pregunta(s)</span>
        <button class="btn btn-secondary btn-sm" onclick="wAddQ()">${SVG.plus} A√±adir Pregunta</button>
      </div>
      <div id="wqlist">${W.preguntas.map((p,i)=>renderQCard(p,i)).join('')}</div>
      ${!W.preguntas.length ? `<div class="empty-state" style="padding:30px"><p>Sin preguntas a√∫n. Sube un documento o pulsa "A√±adir Pregunta".</p></div>` : ''}
    `;
  }

  if (W.step === 3) {
    return `
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Configura los rangos de puntuaci√≥n para determinar el nivel de riesgo final, basado en la suma de valores de respuestas.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        ${[['bajo','üü¢ Bajo','var(--green)'],['medio','üü° Medio','var(--amber)'],['alto','üî¥ Alto','var(--red)']].map(([k,l,c])=>`
          <div class="card" style="border-color:${c}">
            <div style="color:${c};font-weight:700;margin-bottom:12px">${l}</div>
            <div class="form-group"><label class="form-label">M√≠nimo</label><input class="form-input" type="number" step="0.5" id="r-${k}-min" value="${W['nivelRiesgo'+k.charAt(0).toUpperCase()+k.slice(1)].min}" oninput="W['nivelRiesgo${k.charAt(0).toUpperCase()+k.slice(1)}'].min=parseFloat(this.value)||0"></div>
            <div class="form-group"><label class="form-label">M√°ximo</label><input class="form-input" type="number" step="0.5" id="r-${k}-max" value="${W['nivelRiesgo'+k.charAt(0).toUpperCase()+k.slice(1)].max}" oninput="W['nivelRiesgo${k.charAt(0).toUpperCase()+k.slice(1)}'].max=parseFloat(this.value)||0"></div>
          </div>
        `).join('')}
      </div>
      <div class="card" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:500;font-size:13px">Bloqueo autom√°tico por Red Flag</div>
            <div style="font-size:12px;color:var(--text3);margin-top:4px">Si alguna respuesta tiene flag activado, el resultado se bloquear√° para revisi√≥n.</div>
          </div>
          <label class="toggle"><input type="checkbox" id="wredflag" ${W.bloqueoRedFlag?'checked':''} onchange="W.bloqueoRedFlag=this.checked"><span class="toggle-slider"></span></label>
        </div>
      </div>
    `;
  }

  if (W.step === 4) {
    const aprobadores = state.data.usuarios.filter(u=>(u.roles||[]).some(r=>r==='aprobador'||r==='admin'));
    return `
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Configura qu√© usuarios deben aprobar los resultados seg√∫n el nivel de riesgo detectado.</p>
      ${[['alto','üî¥ Riesgo Alto','var(--red)'],['medio','üü° Riesgo Medio','var(--amber)'],['bajo','üü¢ Riesgo Bajo','var(--green)']].map(([nivel,label,color])=>`
        <div class="form-group">
          <label class="form-label" style="color:${color}">${label} ‚Äî Aprobador</label>
          <select class="form-select" id="apr-${nivel}" onchange="W.aprobadores['${nivel}']=this.value">
            <option value="">Sin aprobador requerido</option>
            ${aprobadores.map(u=>`<option value="${u.nombre}" ${W.aprobadores[nivel]===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
          </select>
        </div>
      `).join('')}
      <div class="info-box" style="margin-top:16px">‚ÑπÔ∏è Los aprobadores recibir√°n notificaciones cuando un cuestionario alcance su nivel de riesgo asignado.</div>
    `;
  }
}

// Country tag input helpers
let _countryHighlight = -1;
function filterCountries(val) {
  const dd = document.getElementById('country-dd');
  if (!val.trim()) { dd.style.display='none'; return; }
  const matches = COUNTRIES.filter(c => c.toLowerCase().includes(val.toLowerCase()) && !W.paises.includes(c)).slice(0,8);
  if (!matches.length) { dd.style.display='none'; return; }
  _countryHighlight = -1;
  dd.innerHTML = matches.map((c,i)=>`<div class="tag-option" data-idx="${i}" onclick="addPaisWizard('${c}')">${c}</div>`).join('');
  dd.style.display='block';
}
function countryKeydown(e) {
  const dd = document.getElementById('country-dd');
  const opts = dd.querySelectorAll('.tag-option');
  if (e.key==='ArrowDown') { _countryHighlight=Math.min(_countryHighlight+1,opts.length-1); opts.forEach((o,i)=>o.classList.toggle('highlighted',i===_countryHighlight)); e.preventDefault(); }
  else if (e.key==='ArrowUp') { _countryHighlight=Math.max(_countryHighlight-1,0); opts.forEach((o,i)=>o.classList.toggle('highlighted',i===_countryHighlight)); e.preventDefault(); }
  else if (e.key==='Enter') { if (_countryHighlight>=0&&opts[_countryHighlight]) { addPaisWizard(opts[_countryHighlight].textContent); e.preventDefault(); } }
  else if (e.key==='Escape') { dd.style.display='none'; }
}
function addPaisWizard(pais) {
  if (!W.paises.includes(pais)) { W.paises.push(pais); }
  document.getElementById('country-input').value='';
  document.getElementById('country-dd').style.display='none';
  // Re-render tags
  const wrap = document.getElementById('country-tag-wrap');
  if (wrap) {
    // Remove existing pills
    wrap.querySelectorAll('.tag-pill').forEach(p=>p.remove());
    const inp = document.getElementById('country-input');
    W.paises.forEach(p => {
      const pill = document.createElement('span');
      pill.className='tag-pill';
      pill.innerHTML=`${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">√ó</button>`;
      wrap.insertBefore(pill, inp);
    });
  }
}
function removePaisWizard(pais) {
  W.paises = W.paises.filter(p=>p!==pais);
  const wrap = document.getElementById('country-tag-wrap');
  if (wrap) {
    wrap.querySelectorAll('.tag-pill').forEach(p=>p.remove());
    const inp = document.getElementById('country-input');
    W.paises.forEach(p => {
      const pill = document.createElement('span');
      pill.className='tag-pill';
      pill.innerHTML=`${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">√ó</button>`;
      wrap.insertBefore(pill, inp);
    });
  }
}

// Question builder
function renderQCard(p, idx) {
  const isApi = p.tipo === 'api_lookup';
  const prov = isApi && p.apiConfig?.provider ? API_PROVIDERS[p.apiConfig.provider] : null;
  // Section header ‚Äî show if this pregunta has a section different from the previous one
  const prevSeccion = idx > 0 ? (W.preguntas[idx-1]?.seccion || '') : null;
  const thisSeccion = p.seccion || '';
  const showSection = thisSeccion && thisSeccion !== prevSeccion;
  return `${showSection ? `<div class="proposal-section-header">üìÇ ${thisSeccion}</div>` : ''}
  <div class="question-card">
    <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px">
      <div style="color:var(--text3);cursor:grab;padding:4px">${SVG.drag}</div>
      <div class="question-num">${idx+1}</div>
      <div style="flex:1">
        <input class="form-input" placeholder="Texto de la pregunta..." value="${(p.texto||'').replace(/"/g,'&quot;')}" oninput="W.preguntas[${idx}].texto=this.value" style="margin-bottom:6px">
        <input class="form-input" placeholder="Secci√≥n / categor√≠a (opcional)..." value="${(p.seccion||'').replace(/"/g,'&quot;')}" oninput="W.preguntas[${idx}].seccion=this.value" style="margin-bottom:8px;font-size:11px;color:var(--accent);background:var(--surface3)">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="form-select" style="width:auto" onchange="wChangeTipo(${idx},this.value)">
            <option value="abierta" ${p.tipo==='abierta'?'selected':''}>Respuesta abierta</option>
            <option value="select_unico" ${p.tipo==='select_unico'?'selected':''}>Desplegable (√∫nica)</option>
            <option value="select_multiple" ${p.tipo==='select_multiple'?'selected':''}>Desplegable (m√∫ltiple)</option>
            <option value="api_lookup" ${p.tipo==='api_lookup'?'selected':''}>üîå Consulta API externa</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
            <input type="checkbox" ${p.obligatoria?'checked':''} onchange="W.preguntas[${idx}].obligatoria=this.checked"> Obligatoria
          </label>
          ${W.tipo==='due_diligence' ? `<span style="font-size:10px;padding:2px 7px;border-radius:4px;cursor:pointer;border:1px solid ${p.soloCompleta?'#8b5cf6':'var(--border)'};background:${p.soloCompleta?'rgba(139,92,246,.12)':'var(--surface)'};color:${p.soloCompleta?'#8b5cf6':'var(--text3)'}" onclick="W.preguntas[${idx}].soloCompleta=!W.preguntas[${idx}].soloCompleta;wRefreshQ()" title="Solo aparece en DD de riesgo Alto">Solo Completa</span>` : ''}
        </div>
      </div>
      <button class="btn btn-danger btn-icon btn-sm" onclick="wRemoveQ(${idx})">${SVG.trash}</button>
    </div>

    ${isApi ? renderApiQConfig(p, idx) : p.tipo!=='abierta' ? `
      <div style="padding-left:44px">
        <div style="display:flex;font-size:11px;color:var(--text3);gap:8px;padding:0 4px;margin-bottom:6px">
          <span style="flex:1">Opci√≥n</span><span style="width:64px;text-align:center">Valor</span><span style="width:28px;text-align:center">üö©</span><span style="width:28px"></span>
        </div>
        ${(p.opciones||[]).map((op,oi)=>`
          <div class="option-row">
            <input class="option-input" value="${(op.texto||'').replace(/"/g,'&quot;')}" placeholder="Texto de la opci√≥n..." oninput="W.preguntas[${idx}].opciones[${oi}].texto=this.value">
            <input class="option-score" type="number" step="0.5" value="${op.valor??0}" title="Puntuaci√≥n" oninput="W.preguntas[${idx}].opciones[${oi}].valor=parseFloat(this.value)||0">
            <div class="flag-btn ${op.flag?'on':''}" onclick="wToggleFlag(${idx},${oi})" title="${op.flag?'Quitar flag':'Marcar como red flag'}">üö©</div>
            <button class="btn btn-ghost btn-icon" style="width:28px;height:28px;padding:0" onclick="wRemoveOp(${idx},${oi})">${SVG.x}</button>
          </div>
        `).join('')}
        <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="wAddOp(${idx})">${SVG.plus} A√±adir opci√≥n</button>
      </div>
    ` : '<div style="padding-left:44px;font-size:12px;color:var(--text3);font-style:italic;margin-top:4px">Campo de texto libre ‚Äî sin opciones</div>'}
  </div>`;
}

function renderApiQConfig(p, idx) {
  const cfg = p.apiConfig || {};
  const prov = cfg.provider ? API_PROVIDERS[cfg.provider] : null;
  return `<div style="padding-left:44px">
    <!-- Selector de proveedor -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px">
      ${Object.entries(API_PROVIDERS).map(([key, pr]) => `
        <div class="api-provider-card ${cfg.provider===key?'selected':''}" onclick="wSetApiProvider(${idx},'${key}')">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
            <span style="font-size:16px">${pr.icono}</span>
            <span style="font-size:12px;font-weight:600;color:var(--text)">${pr.nombre}</span>
            ${!pr.requiresKey && key!=='custom' ? '<span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.15);color:var(--green);font-weight:600">GRATIS</span>' : ''}
            ${pr.requiresKey ? '<span style="font-size:9px;padding:1px 5px;border-radius:3px;background:var(--amber-soft);color:var(--amber)">KEY</span>' : ''}
          </div>
          <div style="font-size:11px;color:var(--text3);line-height:1.3">${pr.descripcion}</div>
          ${pr.fuentes?.length ? `<div style="font-size:10px;color:var(--text3);margin-top:4px;opacity:.7">${pr.fuentes.slice(0,2).join(' ¬∑ ')}</div>` : ''}
        </div>
      `).join('')}
    </div>

    ${prov ? `
      <!-- Configuraci√≥n del proveedor seleccionado -->
      <div style="background:var(--surface3);border-radius:var(--radius-sm);padding:14px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <span style="font-size:12px;font-weight:600;color:${prov.color}">${prov.icono} ${prov.nombre}</span>
          <div style="display:flex;gap:8px;align-items:center">
            ${!prov.requiresKey && cfg.provider!=='custom' ? '<span style="font-size:10px;padding:2px 7px;border-radius:3px;background:rgba(16,185,129,.15);color:var(--green);font-weight:600">‚úì GRATIS ¬∑ SIN REGISTRO</span>' : ''}
            ${prov.docsUrl ? `<a href="${prov.docsUrl}" target="_blank" style="font-size:11px;color:var(--accent)">Docs ‚Üó</a>` : ''}
          </div>
        </div>
        ${prov.fuentes?.length ? `<div style="font-size:11px;color:var(--text3);margin-bottom:10px">Fuentes: <strong style="color:var(--text2)">${prov.fuentes.join(' ¬∑ ')}</strong></div>` : ''}

        ${prov.requiresKey ? `
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label">API Key</label>
            <input class="form-input" type="password" placeholder="Pega tu API key aqu√≠..."
              value="${cfg.apiKey||''}"
              oninput="W.preguntas[${idx}].apiConfig.apiKey=this.value"
              style="font-family:monospace;font-size:12px">
            <div style="font-size:11px;color:var(--text3);margin-top:4px">‚ö†Ô∏è Fase 1: la key se guarda en el cuestionario. En producci√≥n migrar√° a backend seguro.</div>
          </div>
        ` : ''}

        <div class="form-group" style="margin-bottom:10px">
          <label class="form-label">Campos del tercero a enviar</label>
          <div style="display:flex;flex-direction:column;gap:6px">
            ${[['nombre','Nombre comercial'],['cif','CIF / NIF'],['pais','Pa√≠s'],['denominacion','Denominaci√≥n social']].map(([field, label]) => `
              <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);cursor:pointer">
                <input type="checkbox" ${(cfg.inputFields||['nombre','pais']).includes(field)?'checked':''}
                  onchange="wToggleApiField(${idx},'${field}',this.checked)">
                ${label} <code style="font-size:10px;background:var(--surface);padding:1px 5px;border-radius:3px;color:var(--accent)">${field}</code>
              </label>
            `).join('')}
          </div>
        </div>

        <div class="form-group" style="margin-bottom:0">
          <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer">
            <input type="checkbox" ${cfg.requireConfirmation!==false?'checked':''}
              onchange="W.preguntas[${idx}].apiConfig.requireConfirmation=this.checked">
            <span style="color:var(--text2)">Requiere confirmaci√≥n humana del resultado</span>
          </label>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;padding-left:20px">El gestor debe revisar y confirmar antes de continuar, aunque haya resultado autom√°tico.</div>
        </div>
      </div>

      <!-- Opciones de respuesta (igual que select_unico) -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:12px;color:var(--text2);font-weight:500">Opciones de respuesta (asignadas autom√°ticamente por la API)</span>
          <button class="btn btn-ghost btn-sm" onclick="wResetApiOpciones(${idx})">‚Ü∫ Restaurar por defecto</button>
        </div>
        <div style="display:flex;font-size:11px;color:var(--text3);gap:8px;padding:0 4px;margin-bottom:6px">
          <span style="flex:1">Opci√≥n</span><span style="width:64px;text-align:center">Valor</span><span style="width:28px;text-align:center">üö©</span><span style="width:28px"></span>
        </div>
        ${(p.opciones||[]).map((op,oi)=>`
          <div class="option-row">
            <input class="option-input" value="${(op.texto||'').replace(/"/g,'&quot;')}" placeholder="Texto de la opci√≥n..." oninput="W.preguntas[${idx}].opciones[${oi}].texto=this.value">
            <input class="option-score" type="number" step="0.5" value="${op.valor??0}" oninput="W.preguntas[${idx}].opciones[${oi}].valor=parseFloat(this.value)||0">
            <div class="flag-btn ${op.flag?'on':''}" onclick="wToggleFlag(${idx},${oi})">üö©</div>
            <button class="btn btn-ghost btn-icon" style="width:28px;height:28px;padding:0" onclick="wRemoveOp(${idx},${oi})">${SVG.x}</button>
          </div>
        `).join('')}
        <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="wAddOp(${idx})">${SVG.plus} A√±adir opci√≥n</button>
      </div>
    ` : '<div style="font-size:12px;color:var(--text3);font-style:italic">Selecciona un proveedor de API arriba.</div>'}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT ‚Äî Excel / PDF ‚Üí Claude API ‚Üí Propuesta editable
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function wHandleDrop(e) {
  e.preventDefault();
  document.getElementById('import-zone')?.classList.remove('drag-over');
  const file = e.dataTransfer?.files?.[0];
  if (file) wHandleFile(file);
}

async function wHandleFile(file) {
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  const allowed = ['xlsx','xls','csv','pdf'];
  if (!allowed.includes(ext)) { notify('Formato no soportado. Usa .xlsx, .xls, .csv o .pdf', 'error'); return; }

  // Show analyzing overlay
  document.getElementById('wbody').innerHTML = `
    <div class="analyzing-overlay">
      <div class="analyzing-spinner"></div>
      <div style="font-size:15px;font-weight:500;margin-bottom:8px">Analizando documento‚Ä¶</div>
      <div style="font-size:12px;color:var(--text3)">Claude est√° leyendo el contenido y generando la propuesta de cuestionario</div>
      <div style="margin-top:16px;font-size:11px;color:var(--text3);font-style:italic" id="import-status">Leyendo archivo‚Ä¶</div>
    </div>`;

  try {
    let contentForClaude;
    if (ext === 'pdf') {
      contentForClaude = await readPdfAsBase64(file);
      setImportStatus('Enviando PDF a Claude‚Ä¶');
    } else {
      contentForClaude = await readExcelAsText(file);
      setImportStatus('Enviando contenido a Claude‚Ä¶');
    }

    setImportStatus('Claude analizando estructura del formulario‚Ä¶');
    const propuesta = await analyzeWithClaude(contentForClaude, ext === 'pdf', file.name);

    // Apply proposal to W
    W._importProposal = { fileName: file.name, totalFound: propuesta.length };
    W.preguntas = propuesta;

    // Auto-suggest nombre and tipo if empty
    if (!W.nombre && propuesta._nombre) W.nombre = propuesta._nombre;

    notify(`‚úÖ ${propuesta.length} preguntas extra√≠das de "${file.name}"`);
    wRefreshStep();

  } catch(e) {
    console.error('Import error:', e);
    notify(`Error al analizar: ${e.message}`, 'error');
    wRefreshStep(); // restore step 2
  }
}

function setImportStatus(msg) {
  const el = document.getElementById('import-status');
  if (el) el.textContent = msg;
}

async function readExcelAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        if (!window.XLSX) throw new Error('SheetJS no cargado. Comprueba conexi√≥n a internet.');
        const wb = XLSX.read(e.target.result, { type:'binary' });
        let text = '';
        wb.SheetNames.forEach(name => {
          const ws = wb.Sheets[name];
          // Convert to CSV for readability
          const csv = XLSX.utils.sheet_to_csv(ws, { blankrows:false });
          if (csv.trim()) text += `\n=== Hoja: ${name} ===\n${csv}`;
        });
        resolve(text.trim());
      } catch(err) { reject(err); }
    };
    reader.onerror = () => reject(new Error('No se pudo leer el archivo'));
    reader.readAsBinaryString(file);
  });
}

async function readPdfAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result.split(',')[1]); // base64 only
    reader.onerror = () => reject(new Error('No se pudo leer el PDF'));
    reader.readAsDataURL(file);
  });
}

async function analyzeWithClaude(content, isPdf, fileName) {
  const systemPrompt = `Eres un experto en gesti√≥n de riesgos de terceros (TPRM) y en dise√±o de cuestionarios de due diligence.
Tu tarea es analizar un documento (Excel, formulario impreso o PDF) y extraer todas las preguntas de un cuestionario de evaluaci√≥n de proveedores/terceros.

IMPORTANTE: Responde √öNICAMENTE con un array JSON v√°lido. Sin texto adicional, sin markdown, sin explicaciones.

Cada pregunta del array debe tener exactamente este formato:
{
  "id": "q_[n√∫mero √∫nico]",
  "texto": "Texto completo de la pregunta",
  "seccion": "Nombre de la secci√≥n o categor√≠a (si existe, si no pon '')",
  "tipo": "select_unico" o "abierta",
  "obligatoria": true o false,
  "soloCompleta": false,
  "opciones": [
    { "texto": "Texto de la opci√≥n", "valor": [n√∫mero 0-3], "flag": false }
  ]
}

REGLAS para asignar tipo:
- Si la pregunta tiene opciones de respuesta definidas (S√≠/No, escala, lista) ‚Üí "select_unico"
- Si es una pregunta abierta o de texto libre ‚Üí "abierta" (opciones vac√≠as [])

REGLAS para asignar valor (puntuaci√≥n) a las opciones:
- Respuesta m√°s favorable (cumple completamente, S√≠ con evidencia, pol√≠tica documentada) ‚Üí valor: 3
- Respuesta parcial (cumple parcialmente, En proceso) ‚Üí valor: 2
- Respuesta menos favorable pero sin riesgo cr√≠tico ‚Üí valor: 1
- Respuesta de riesgo alto (No, No existe, Nunca) ‚Üí valor: 0

REGLAS para flag:
- flag: true SOLO en opciones que representan riesgo cr√≠tico o incumplimiento grave (No existe, Nunca, Sin pol√≠tica, etc.)
- El resto: flag: false

REGLAS para obligatoria:
- Si en el documento aparece como obligatoria o tiene asterisco ‚Üí true
- Si no hay indicaci√≥n ‚Üí true por defecto

Si encuentras secciones o categor√≠as en el documento, incl√∫yelas en el campo "seccion".
Si hay preguntas de S√≠/No sin puntuaci√≥n definida, usa: S√≠ ‚Üí valor:3, No ‚Üí valor:0 flag:true.
Si hay escalas (1-5, Siempre/A veces/Nunca), map√©alas proporcionalmente a 0-3.
Extrae TODAS las preguntas que encuentres, incluso si el formato es irregular.`;

  // PDFs: Mistral no soporta PDF nativo en browser ‚Üí convertimos a mensaje de texto indic√°ndolo
  // Para Excel/CSV: enviamos el contenido como texto directamente
  const userContent = isPdf
    ? `El usuario ha subido un PDF llamado "${fileName}". No puedo enviarte el PDF directamente, pero extrae preguntas del siguiente texto extra√≠do del PDF:\n\n${content}`
    : `Analiza este contenido de Excel/CSV y extrae todas las preguntas del cuestionario con sus opciones de respuesta. Archivo: ${fileName}\n\n${content.slice(0, 12000)}`;

  const resp = await fetch('https://api.mistral.ai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getMistralKey()}`
    },
    body: JSON.stringify({
      model: 'mistral-large-latest',
      temperature: 0.1,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userContent }
      ]
    })
  });

  if (resp.status === 401) throw new Error('API key de Mistral inv√°lida. Config√∫rala en Ajustes ‚Üí Integraciones.');
  if (!resp.ok) {
    const err = await resp.json().catch(()=>({}));
    throw new Error(err?.message || `Mistral API error ${resp.status}`);
  }

  const data = await resp.json();
  const rawText = data.choices?.[0]?.message?.content?.trim() || '';

  const clean = rawText.replace(/^```json?\s*/,'').replace(/\s*```$/,'').trim();
  let preguntas;
  try {
    preguntas = JSON.parse(clean);
  } catch(e) {
    throw new Error('Mistral devolvi√≥ una respuesta que no se pudo parsear. Intenta con un documento m√°s simple.');
  }

  if (!Array.isArray(preguntas)) throw new Error('La respuesta no es un array de preguntas.');

  return preguntas.map((p) => ({
    id: p.id || genId(),
    texto: p.texto || '',
    seccion: p.seccion || '',
    tipo: p.tipo || 'select_unico',
    obligatoria: p.obligatoria !== false,
    soloCompleta: false,
    opciones: (p.opciones || []).map(o => ({
      texto: o.texto || '',
      valor: typeof o.valor === 'number' ? o.valor : 0,
      flag: !!o.flag
    }))
  }));
}

function getMistralKey() {
  // Busca en config guardada, si no pide al usuario
  const saved = state.data.config?.mistralKey || localStorage.getItem('mistral_api_key') || '';
  if (!saved) {
    const key = prompt('Introduce tu API key de Mistral AI:\n(Cons√≠guela en console.mistral.ai ‚Üí API Keys)');
    if (key) {
      localStorage.setItem('mistral_api_key', key.trim());
      return key.trim();
    }
    throw new Error('Se necesita API key de Mistral para analizar documentos.');
  }
  return saved;
}

function wClearProposal() {
  W._importProposal = null;
  W.preguntas = [];
  wRefreshStep();
}

function wRefreshStep() {
  document.getElementById('wbody').innerHTML = renderWStep();
}

function wRefreshQ() { document.getElementById('wqlist').innerHTML = W.preguntas.map((p,i)=>renderQCard(p,i)).join(''); }
function wAddQ() { W.preguntas.push({id:genId(),texto:'',tipo:'select_unico',obligatoria:false,soloCompleta:false,opciones:[{texto:'',valor:0,flag:false}]}); wRefreshQ(); }
function wRemoveQ(idx) { W.preguntas.splice(idx,1); wRefreshQ(); }
function wAddOp(idx) { W.preguntas[idx].opciones=W.preguntas[idx].opciones||[]; W.preguntas[idx].opciones.push({texto:'',valor:0,flag:false}); wRefreshQ(); }
function wRemoveOp(idx,oi) { W.preguntas[idx].opciones.splice(oi,1); wRefreshQ(); }
function wToggleFlag(idx,oi) { W.preguntas[idx].opciones[oi].flag=!W.preguntas[idx].opciones[oi].flag; wRefreshQ(); }

function wChangeTipo(idx, tipo) {
  W.preguntas[idx].tipo = tipo;
  if (tipo === 'api_lookup') {
    if (!W.preguntas[idx].apiConfig) W.preguntas[idx].apiConfig = { provider:'', apiKey:'', inputFields:['nombre','pais'], requireConfirmation:true };
    if (!W.preguntas[idx].opciones?.length) W.preguntas[idx].opciones = API_PROVIDERS.sanctionsnetwork.defaultOpciones.map(o=>({...o}));
  } else if (tipo !== 'abierta' && !W.preguntas[idx].opciones?.length) {
    W.preguntas[idx].opciones = [{texto:'',valor:0,flag:false}];
  }
  wRefreshQ();
}

function wSetApiProvider(idx, provider) {
  if (!W.preguntas[idx].apiConfig) W.preguntas[idx].apiConfig = {};
  W.preguntas[idx].apiConfig.provider = provider;
  W.preguntas[idx].opciones = API_PROVIDERS[provider].defaultOpciones.map(o=>({...o}));
  wRefreshQ();
}

function wToggleApiField(idx, field, checked) {
  if (!W.preguntas[idx].apiConfig) W.preguntas[idx].apiConfig = {};
  let fields = W.preguntas[idx].apiConfig.inputFields || ['nombre','pais'];
  if (checked) { if (!fields.includes(field)) fields.push(field); }
  else { fields = fields.filter(f => f !== field); }
  W.preguntas[idx].apiConfig.inputFields = fields;
}

function wResetApiOpciones(idx) {
  const prov = W.preguntas[idx].apiConfig?.provider;
  if (prov && API_PROVIDERS[prov]) {
    W.preguntas[idx].opciones = API_PROVIDERS[prov].defaultOpciones.map(o=>({...o}));
    wRefreshQ();
  }
}

function wCollectStep() {
  // Collect current step data into W before navigating
  if (W.step===1) {
    W.nombre = document.getElementById('wn')?.value||W.nombre;
    const wt = document.getElementById('wt'); if (wt) W.tipo = wt.value;
    const wumb = document.getElementById('wumb'); if (wumb) W.umbralMaterial = parseInt(wumb.value)||0;
    const wa = document.getElementById('wa');
    if (wa) { W.ambito_id=wa.value; const sel=wa.options[wa.selectedIndex]; W.ambito=sel&&wa.value?sel.text:''; }
    // collect chips if filters visible
    if (!W.aplicaTodos) {
      W.ambitosAplicables = getChipValues('wamb');
      W.nivelesRiesgo = getChipValues('wniv');
      W.tiposProveedor = getChipValues('wtp');
    }
  }
  if (W.step===3) {
    ['bajo','medio','alto'].forEach(k => {
      const K = k.charAt(0).toUpperCase()+k.slice(1);
      const mn = document.getElementById(`r-${k}-min`); const mx = document.getElementById(`r-${k}-max`);
      if(mn) W[`nivelRiesgo${K}`].min = parseFloat(mn.value)||0;
      if(mx) W[`nivelRiesgo${K}`].max = parseFloat(mx.value)||0;
    });
    const rf = document.getElementById('wredflag'); if(rf) W.bloqueoRedFlag=rf.checked;
  }
  if (W.step===4) {
    ['alto','medio','bajo'].forEach(n => {
      const el = document.getElementById(`apr-${n}`); if(el) W.aprobadores[n]=el.value;
    });
  }
}

function wValidateStep() {
  if (W.step===1) {
    if (!W.nombre.trim()) { notify('El nombre del cuestionario es obligatorio', 'error'); return false; }
    if (W.tipo === 'due_diligence' && !W.ambito_id) { notify('Selecciona un √°mbito de riesgo', 'error'); return false; }
  }
  return true;
}

function wNav(dir) {
  wCollectStep();
  if (dir > 0 && !wValidateStep()) return;
  W.step = Math.max(1, Math.min(4, W.step+dir));
  wRefreshStep();
}

async function wSave() {
  wCollectStep();
  const item = {
    id: W.id||genId(),
    nombre: W.nombre,
    tipo: W.tipo||'due_diligence',
    ambito: W.ambito,
    ambito_id: W.ambito_id,
    umbralMaterial: W.umbralMaterial||2,
    aplicaTodos: W.aplicaTodos,
    paises: W.paises,
    ambitosAplicables: W.ambitosAplicables,
    nivelesRiesgo: W.nivelesRiesgo,
    tiposProveedor: W.tiposProveedor,
    preguntas: W.preguntas,
    nivelRiesgoBajo: W.nivelRiesgoBajo,
    nivelRiesgoMedio: W.nivelRiesgoMedio,
    nivelRiesgoAlto: W.nivelRiesgoAlto,
    bloqueoRedFlag: W.bloqueoRedFlag,
    aprobadores: W.aprobadores,
    creado: W.creado,
    modificado: new Date().toISOString().split('T')[0],
  };
  await saveItem('cuestionarios', item);
  // Link to ambito
  const amb = state.data.ambitos.find(a=>a.id===item.ambito_id);
  if (amb) { amb.cuestionarios=amb.cuestionarios||[]; if(!amb.cuestionarios.includes(item.id)) { amb.cuestionarios.push(item.id); await saveItem('ambitos',amb); } }
  notify('Cuestionario guardado correctamente');
  closeModal(); renderCuestionarios();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOMOLOGACI√ìN ‚Äî helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const addMonths = (date, m) => { const d = new Date(date); d.setMonth(d.getMonth() + m); return d.toISOString().split('T')[0]; };

function homBadge(fase) {
  return ({
    pendiente:   '<span class="hom-status hom-pendiente">Sin iniciar</span>',
    fuera_scope: '<span class="hom-status hom-fuera">Fuera de scope</span>',
    scope_check: '<span class="hom-status hom-scope">üîç Scope Check</span>',
    risk_scoring:'<span class="hom-status hom-scoring">üìä Risk Scoring</span>',
    due_diligence:'<span class="hom-status hom-dd">üìã Due Diligence</span>',
    aprobacion:  '<span class="hom-status hom-aprobacion">‚è≥ Aprobaci√≥n</span>',
    completada:  '<span class="hom-status hom-completada">‚úÖ Homologado</span>',
  }[fase] || '<span class="hom-status hom-pendiente">‚Äî</span>');
}

function getActiveHom(tid) { return state.data.homologaciones.find(h => h.terceroId === tid && !['completada','fuera_scope'].includes(h.fase)); }
function getLastHom(tid) { return state.data.homologaciones.filter(h => h.terceroId === tid).sort((a,b) => new Date(b.fechaInicio)-new Date(a.fechaInicio))[0]; }

function calcScore(preguntas, respuestas) {
  let score = 0, hasFlag = false;
  preguntas.forEach(p => {
    // api_lookup responses are objects {respuesta, _apiResult, ...}
    const rawResp = respuestas[p.id];
    const resp = (rawResp && typeof rawResp === 'object') ? rawResp.respuesta : rawResp;
    if (resp !== undefined && resp !== '') {
      const op = (p.opciones||[]).find(o => o.texto === resp);
      if (op) { score += op.valor||0; if (op.flag) hasFlag = true; }
    }
  });
  return { score, hasFlag };
}

function getRiskLevel(cq, score, hasFlag) {
  if (hasFlag && cq.bloqueoRedFlag) return 'alto';
  if (score <= cq.nivelRiesgoBajo.max) return 'bajo';
  if (score <= cq.nivelRiesgoMedio.max) return 'medio';
  return 'alto';
}

function getDDCuestionarios(tercero) {
  const general = state.data.cuestionarios.find(c => c.tipo === 'general');
  const porAmbito = state.data.cuestionarios.filter(c => c.tipo === 'due_diligence' && (tercero.ambitos||[]).includes(c.ambito));
  return [...(general ? [general] : []), ...porAmbito];
}

function filterByDDLevel(preguntas, nivel) {
  return nivel === 'alto' ? preguntas : preguntas.filter(p => !p.soloCompleta);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOMOLOGACI√ìN ‚Äî wizard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let HW = {};

function iniciarHom(terceroId) {
  const tercero = state.data.terceros.find(t => t.id === terceroId);
  if (!tercero) return;
  let hom = getActiveHom(terceroId);
  if (!hom) {
    hom = {
      id: genId(), terceroId, terceroNombre: tercero.nombre, fase: 'scope_check',
      fechaInicio: new Date().toISOString().split('T')[0], fechaCierre: '',
      scopeCheck:   { respuestas:{}, score:0, resultado:'' },
      riskScoring:  { respuestas:{}, score:0, resultado:'', hasFlag:false },
      dueDiligence: { nivel:'', cuestionariosOrder:[], respuestasPorCuestionario:{}, resultadoPorCuestionario:{}, resultadoFinal:'', cuestionarioActual:0 },
      aprobacion:   { estado:'', aprobadoPor:'', fecha:'', comentario:'' },
      riesgoFinal: '', creadoPor: 'Admin Usuario'
    };
  }
  HW = { hom, tercero };
  renderHW();
}

function renderHW() {
  const h = HW.hom;
  const faseIdx = { scope_check:0, risk_scoring:1, due_diligence:2, aprobacion:3, completada:4 };
  const ci = faseIdx[h.fase] ?? 0;
  const faseNames = ['Scope Check','Risk Scoring','Due Diligence','Aprobaci√≥n','Completada'];
  const fases = ['scope_check','risk_scoring','due_diligence','aprobacion','completada'];
  const steps = fases.map((f,i) => {
    const done = i < ci, active = i === ci;
    const bg = active ? 'var(--accent)' : done ? 'var(--green)' : 'var(--surface3)';
    const col = active ? 'var(--accent)' : done ? 'var(--green)' : 'var(--text3)';
    const wc = active || done ? 'white' : 'var(--text3)';
    return `<div style="display:flex;align-items:center;gap:5px;font-size:11px;color:${col}">
      <div style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;background:${bg};color:${wc}">${done?'‚úì':i+1}</div>
      ${faseNames[i]}${i<4?'<span style="color:var(--border2);margin-left:5px">‚Ä∫</span>':''}
    </div>`;
  }).join('');
  openModal(`<div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <div style="flex:1">
        <div class="modal-title">Homologaci√≥n: ${HW.tercero.nombre}</div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">${steps}</div>
      </div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
    </div>
    <div class="modal-body" id="hw-body">${hwStep()}</div>
    <div class="modal-footer" id="hw-footer">${hwFooter()}</div>
  </div>`);
}

function hwStep() {
  const h = HW.hom, t = HW.tercero;

  if (h.fase === 'scope_check') {
    const cq = state.data.cuestionarios.find(c => c.tipo === 'scope_check');
    if (!cq) return `<div class="warn-box">‚ö†Ô∏è No hay cuestionario de Scope Check configurado. Cr√©alo en la secci√≥n Cuestionarios (tipo: Scope Check).</div>`;
    return `<div class="info-box" style="margin-bottom:16px">üîç <strong>Scope Check</strong> ‚Äî Determina si este tercero requiere homologaci√≥n formal.<br><small style="margin-top:4px;display:block">Umbral de materialidad: puntuaci√≥n ‚â• ${cq.umbralMaterial||2}</small></div>${renderQs(cq, h.scopeCheck.respuestas, 'hw-sc')}`;
  }

  if (h.fase === 'risk_scoring') {
    const cq = state.data.cuestionarios.find(c => c.tipo === 'risk_scoring');
    if (!cq) return `<div class="warn-box">‚ö†Ô∏è No hay cuestionario de Risk Scoring configurado.</div>`;
    return `<div class="success-box" style="margin-bottom:12px">‚úÖ Scope Check completado ‚Äî Tercero <strong>material</strong> (puntuaci√≥n: ${h.scopeCheck.score})</div>
      <div class="info-box" style="margin-bottom:16px">üìä <strong>Risk Scoring</strong> ‚Äî Evaluaci√≥n interna de riesgo inicial.<br><small style="margin-top:4px;display:block">Bajo ‚Üí Homologaci√≥n autom√°tica ¬∑ Medio ‚Üí DD Reducida ¬∑ Alto ‚Üí DD Completa</small></div>
      ${renderQs(cq, h.riskScoring.respuestas, 'hw-rs')}`;
  }

  if (h.fase === 'due_diligence') {
    const dd = h.dueDiligence, cuests = getDDCuestionarios(t);
    if (!cuests.length) return `<div class="warn-box">‚ö†Ô∏è No hay cuestionarios DD configurados para los √°mbitos de este tercero.</div>`;
    const idx = dd.cuestionarioActual||0, cq = cuests[idx];
    const preguntas = filterByDDLevel(cq.preguntas||[], dd.nivel);
    const rsColor = h.riskScoring.resultado==='alto'?'var(--red)':h.riskScoring.resultado==='medio'?'var(--amber)':'var(--green)';
    return `<div style="margin-bottom:16px">
      <div class="${h.riskScoring.resultado==='bajo'?'success-box':'warn-box'}" style="margin-bottom:10px">üìä Risk Scoring: <strong style="color:${rsColor}">${h.riskScoring.resultado?.toUpperCase()}</strong> ‚Üí DD <strong>${dd.nivel==='alto'?'Completa':'Reducida'}</strong></div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div class="info-box" style="flex:1">üìã <strong>${cq.nombre}</strong>${cq.tipo==='general'?'<span class="badge" style="background:rgba(6,182,212,.12);color:#06b6d4;margin-left:8px">General ‚Äî siempre primero</span>':''}${dd.nivel!=='alto'&&(cq.preguntas||[]).some(p=>p.soloCompleta)?'<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px">Versi√≥n reducida</span>':''}</div>
        <span style="font-size:12px;color:var(--text3);flex-shrink:0">${idx+1} / ${cuests.length}</span>
      </div>
    </div>
    ${renderQs({...cq, preguntas}, dd.respuestasPorCuestionario[cq.id]||{}, 'hw-dd')}`;
  }

  if (h.fase === 'aprobacion') {
    const dd = h.dueDiligence, cuests = getDDCuestionarios(t);
    const resColor = dd.resultadoFinal==='alto'?'var(--red)':dd.resultadoFinal==='medio'?'var(--amber)':'var(--green)';
    return `<div class="warn-box" style="margin-bottom:16px">‚è≥ <strong>Pendiente de aprobaci√≥n.</strong> Resultado DD: <strong style="color:${resColor}">${dd.resultadoFinal?.toUpperCase()}</strong></div>
      <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text)">Resumen por cuestionario:</div>
      ${cuests.map(cq => {
        const r = dd.resultadoPorCuestionario[cq.id];
        const cls = r?.resultado==='alto'?'border-color:var(--red);background:rgba(239,68,68,.08)':r?.resultado==='bajo'?'border-color:var(--green);background:rgba(16,185,129,.08)':'border-color:var(--accent);background:var(--accent-glow)';
        return `<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--radius);border:1px solid var(--border);${cls};margin-bottom:8px">
          <div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;background:${r?.resultado==='bajo'?'var(--green)':r?.resultado==='alto'?'var(--red)':'var(--accent)'};color:white;flex-shrink:0">${r?.resultado==='bajo'?'‚úì':r?.resultado==='alto'?'!':'?'}</div>
          <div style="flex:1"><div style="font-weight:500;font-size:13px">${cq.nombre}</div><div style="font-size:12px;color:var(--text2);margin-top:2px">Puntuaci√≥n: ${r?.score??'‚Äî'} ¬∑ Resultado: ${r?.resultado||'‚Äî'}${r?.hasFlag?' üö©':''}</div></div>
          ${riskBadge(r?.resultado||'sin valorar')}
        </div>`;
      }).join('')}
      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <div class="form-group"><label class="form-label">Comentario de aprobaci√≥n (opcional)</label><textarea class="form-textarea" id="apr-com" rows="3" placeholder="Observaciones..."></textarea></div>`;
  }

  if (h.fase === 'completada') {
    const dd = h.dueDiligence;
    const resColor = h.riesgoFinal==='alto'?'var(--red)':h.riesgoFinal==='medio'?'var(--amber)':'var(--green)';
    const ter = state.data.terceros.find(t2 => t2.id === h.terceroId);
    return `<div class="success-box" style="margin-bottom:20px;font-size:14px">‚úÖ <strong>Homologaci√≥n completada.</strong> Nivel de riesgo asignado: <strong style="color:${resColor}">${h.riesgoFinal?.toUpperCase()}</strong></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Fecha inicio</div><div style="font-weight:500;margin-top:4px">${fmtDate(h.fechaInicio)}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Fecha cierre</div><div style="font-weight:500;margin-top:4px">${fmtDate(h.fechaCierre)}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Risk Scoring</div><div style="font-weight:500;margin-top:4px">${h.riskScoring.resultado?.toUpperCase()||'‚Äî'}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Nivel DD</div><div style="font-weight:500;margin-top:4px">${dd.nivel?(dd.nivel==='alto'?'Completa':'Reducida'):'Autom√°tica (Bajo)'}</div></div>
      </div>
      ${ter?.fechaSiguiente?`<div class="info-box">üìÖ Pr√≥xima renovaci√≥n: <strong>${fmtDate(ter.fechaSiguiente)}</strong></div>`:''}`;
  }
  return '';
}

function hwFooter() {
  const h = HW.hom;
  if (h.fase === 'scope_check')  return `<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="hwSubmitScope()">Continuar ‚Üí</button>`;
  if (h.fase === 'risk_scoring') return `<button class="btn btn-secondary" onclick="closeModal()">Guardar y cerrar</button><button class="btn btn-primary" onclick="hwSubmitRisk()">Continuar ‚Üí</button>`;
  if (h.fase === 'due_diligence') {
    const cuests = getDDCuestionarios(HW.tercero), idx = HW.hom.dueDiligence.cuestionarioActual||0;
    const isLast = idx >= cuests.length-1;
    return `<button class="btn btn-secondary" onclick="closeModal()">Guardar y cerrar</button><button class="btn btn-primary" onclick="hwSubmitDD()">${isLast?'Finalizar Due Diligence ‚Üí':'Siguiente cuestionario ‚Üí'}</button>`;
  }
  if (h.fase === 'aprobacion')   return `<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn btn-success" onclick="hwAprobar()">${SVG.check} Aprobar y Homologar</button>`;
  return `<button class="btn btn-primary" onclick="closeModal()">Cerrar</button>`;
}

function renderQs(cq, respuestas, prefix) {
  return (cq.preguntas||[]).map((p, i) => {
    const apiResp = respuestas[p.id];
    const isApi = p.tipo === 'api_lookup';
    const prov = isApi && p.apiConfig?.provider ? API_PROVIDERS[p.apiConfig.provider] : null;
    return `<div class="questionnaire-question" id="qq-${prefix}-${p.id}">
      <div class="question-text">${i+1}. ${p.texto}${p.obligatoria?'<span style="color:var(--red);margin-left:4px">*</span>':''}${isApi?`<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px;font-size:10px">üîå ${prov?.nombre||'API'}</span>`:p.soloCompleta?'<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px;font-size:10px">Solo completa</span>':''}</div>
      ${isApi ? renderApiLookupWidget(p, prefix, apiResp) : p.tipo==='abierta'
        ? `<textarea class="form-textarea" id="${prefix}-${p.id}" rows="2" placeholder="Respuesta libre...">${apiResp||''}</textarea>`
        : `<div style="display:flex;flex-direction:column;gap:8px">${(p.opciones||[]).map(op => {
            const isSel = apiResp === op.texto;
            return `<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid ${isSel?(op.flag?'var(--red)':'var(--accent)'):'var(--border2)'};background:${isSel?(op.flag?'rgba(239,68,68,.08)':'var(--accent-glow)'):'transparent'};cursor:pointer;transition:all .15s" onclick="qSel(this,'${prefix}','${p.id}')">
              <input type="radio" name="${prefix}-${p.id}" value="${op.texto.replace(/"/g,'&quot;')}" ${isSel?'checked':''} style="pointer-events:none;accent-color:var(--accent)">
              <span style="flex:1">${op.texto}</span>
              ${op.valor?`<span style="font-size:11px;color:var(--amber)">${op.valor}pts</span>`:''}
              ${op.flag?`<span style="color:var(--red);margin-left:4px">üö©</span>`:''}
            </label>`;
          }).join('')}</div>`}
    </div>`;
  }).join('');
}

function renderApiLookupWidget(p, prefix, savedResp) {
  const cfg = p.apiConfig || {};
  const prov = cfg.provider ? API_PROVIDERS[cfg.provider] : null;
  if (!prov) return `<div class="api-lookup-box"><span style="color:var(--text3);font-size:12px">Sin proveedor API configurado.</span></div>`;

  const hasResult = savedResp?._apiResult;
  const confirmed = savedResp?._confirmed;
  const autoSel = savedResp?._autoSel;

  return `<div class="api-lookup-box" id="api-box-${prefix}-${p.id}">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:${hasResult?'12px':'0'}">
      <div style="flex:1">
        <div style="font-size:12px;color:var(--text2)">Proveedor: <strong style="color:${prov.color}">${prov.icono} ${prov.nombre}</strong>
          ${!prov.requiresKey ? '<span style="font-size:10px;margin-left:6px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.15);color:var(--green)">GRATIS</span>' : ''}
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Campos: ${(cfg.inputFields||['nombre','pais']).join(', ')}${prov.fuentes?.length ? ` ¬∑ Fuentes: ${prov.fuentes.slice(0,2).join(', ')}` : ''}</div>
      </div>
      <button class="btn btn-secondary btn-sm" id="api-btn-${prefix}-${p.id}"
        onclick="runApiLookup('${prefix}','${p.id}',${JSON.stringify(cfg).replace(/'/g,"&#39;")})"
        ${confirmed?'disabled':''}>
        ${hasResult?'‚Ü∫ Volver a consultar':'üîå Consultar API'}
      </button>
    </div>

    ${hasResult ? `
      <div id="api-result-${prefix}-${p.id}">
        ${renderApiResult(savedResp._apiResult, prov, autoSel)}
      </div>
      <!-- Opciones de respuesta -->
      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <span>${confirmed?'‚úÖ Respuesta confirmada':'Confirma la respuesta:'}</span>
          ${autoSel!==undefined?`<span style="font-size:11px;color:var(--text3)">Autoseleccionada opci√≥n ${autoSel+1}</span>`:''}
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${(p.opciones||[]).map((op,oi) => {
            const isSel = savedResp?.respuesta === op.texto;
            return `<label style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);border:1px solid ${isSel?(op.flag?'var(--red)':'var(--accent)'):'var(--border2)'};background:${isSel?(op.flag?'rgba(239,68,68,.08)':'var(--accent-glow)'):'transparent'};cursor:${confirmed?'not-allowed':'pointer'};opacity:${confirmed?'0.8':'1'};transition:all .15s"
              onclick="${confirmed?'':'qSelApi(this,\''+prefix+'\',\''+p.id+'\')'}">
              <input type="radio" name="${prefix}-${p.id}" value="${op.texto.replace(/"/g,'&quot;')}" ${isSel?'checked':''} style="pointer-events:none;accent-color:var(--accent)" ${confirmed?'disabled':''}>
              <span style="flex:1">${op.texto}</span>
              ${op.valor?`<span style="font-size:11px;color:var(--amber)">${op.valor}pts</span>`:''}
              ${op.flag?`<span style="color:var(--red);margin-left:4px">üö©</span>`:''}
              ${oi===autoSel?'<span style="font-size:10px;background:rgba(139,92,246,.15);color:#8b5cf6;padding:1px 6px;border-radius:3px">Auto</span>':''}
            </label>`;
          }).join('')}
        </div>
        ${!confirmed && savedResp?.respuesta ? `
          <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%" onclick="confirmApiResp('${prefix}','${p.id}')">
            ‚úÖ Confirmar esta respuesta
          </button>
        ` : ''}
        ${confirmed ? `<div style="font-size:11px;color:var(--green);margin-top:8px">‚úÖ Confirmado ‚Äî respuesta bloqueada para auditor√≠a</div>` : ''}
      </div>
    ` : `<div style="font-size:11px;color:var(--text3);margin-top:8px">Pulsa "Consultar API" para obtener el resultado autom√°tico y luego confirmar.</div>`}
  </div>`;
}

function renderApiResult(result, prov, autoSel) {
  if (!result) return '';
  const hasHit = result.hits > 0;
  const score = result.topHit?.similarityScore ?? result.topHit?.score ?? result.score ?? 0;
  const cls = hasHit ? (autoSel >= 2 ? 'api-result-hit' : 'api-result-partial') : 'api-result-clean';
  const icon = hasHit ? (autoSel >= 2 ? 'üö®' : '‚ö†Ô∏è') : '‚úÖ';
  const scoreColor = score >= 0.85 ? 'var(--red)' : score >= 0.6 ? 'var(--amber)' : 'var(--green)';

  return `<div class="${cls}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:6px">${icon} ${hasHit ? `${result.hits} coincidencia(s) encontrada(s)` : 'Sin coincidencias'}</div>

        ${result.fuentes?.length ? `
          <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">
            ${result.fuentes.map(f => `<span style="font-size:10px;padding:1px 7px;border-radius:3px;background:rgba(0,0,0,.3);color:var(--text2)">${f}</span>`).join('')}
          </div>` : ''}

        ${result.topHit ? `
          <div style="padding:8px 10px;background:rgba(0,0,0,.2);border-radius:var(--radius-sm)">
            <div style="font-weight:500;font-size:13px">${result.topHit.nombre||'‚Äî'}</div>
            ${result.topHit.source ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">üìã ${result.topHit.source}</div>` : ''}
            ${result.topHit.datasets ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Fuentes: ${result.topHit.datasets}</div>` : ''}
            ${result.topHit.entityType && result.topHit.entityType !== '‚Äî' ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Tipo: ${result.topHit.entityType}</div>` : ''}
            ${result.topHit.country && result.topHit.country !== '‚Äî' ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Pa√≠s: ${result.topHit.country}</div>` : ''}
            ${result.topHit.aliases?.length ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Alias: ${result.topHit.aliases.join(', ')}</div>` : ''}
            ${result.topHit.numero ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">N.¬∫ registro: ${result.topHit.numero}</div>` : ''}
            ${result.topHit.estado ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Estado: ${result.topHit.estado}</div>` : ''}
            ${result.topHit.url ? `<a href="${result.topHit.url}" target="_blank" style="color:var(--accent);font-size:11px;margin-top:4px;display:block">Ver ficha completa ‚Üó</a>` : ''}
          </div>
        ` : ''}
      </div>

      <div style="text-align:right;flex-shrink:0">
        <div style="font-size:26px;font-weight:800;font-family:'Syne',sans-serif;color:${scoreColor};line-height:1">${(score*100).toFixed(0)}<span style="font-size:12px;font-weight:400">%</span></div>
        <div style="font-size:10px;color:var(--text3)">similitud</div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--text3);margin-top:8px;border-top:1px solid rgba(255,255,255,.05);padding-top:6px">
      Consultado: ${new Date().toLocaleString('es-ES')} ¬∑ Proveedor: ${prov.nombre}
    </div>
  </div>`;
}

function qSel(labelEl, prefix, qId) {
  const group = labelEl.closest('[style*="flex-direction:column"]');
  group.querySelectorAll('label').forEach(l => {
    const r = l.querySelector('input');
    const isFlag = l.innerHTML.includes('üö©');
    l.style.borderColor = 'var(--border2)';
    l.style.background = 'transparent';
    if (r) r.checked = false;
  });
  const isFlag = labelEl.innerHTML.includes('üö©');
  labelEl.style.borderColor = isFlag ? 'var(--red)' : 'var(--accent)';
  labelEl.style.background = isFlag ? 'rgba(239,68,68,.08)' : 'var(--accent-glow)';
  const inp = labelEl.querySelector('input'); if (inp) inp.checked = true;
}

function qSelApi(labelEl, prefix, qId) {
  // Same as qSel but stores into HW respuestas object too
  qSel(labelEl, prefix, qId);
  const val = labelEl.querySelector('input')?.value;
  if (!val) return;
  // Update HW respuestas for this question
  const hom = HW.hom;
  if (!hom) return;
  const faseMap = { 'hw-sc': 'scopeCheck', 'hw-rs': 'riskScoring', 'hw-dd': 'dueDiligence' };
  const fase = Object.keys(faseMap).find(k => prefix.startsWith(k));
  if (fase === 'hw-dd') {
    const dd = hom.dueDiligence;
    const cuests = getDDCuestionarios(HW.tercero);
    const cq = cuests[dd.cuestionarioActual||0];
    if (!dd.respuestasPorCuestionario[cq.id]) dd.respuestasPorCuestionario[cq.id] = {};
    const existing = dd.respuestasPorCuestionario[cq.id][qId] || {};
    dd.respuestasPorCuestionario[cq.id][qId] = { ...existing, respuesta: val };
  }
}

function confirmApiResp(prefix, qId) {
  // Mark the api response as confirmed
  const hom = HW.hom;
  if (!hom) return;
  const val = document.querySelector(`input[name="${prefix}-${qId}"]:checked`)?.value;
  if (!val) { notify('Selecciona una respuesta antes de confirmar', 'error'); return; }

  // Find and update in HW
  const fase = prefix.startsWith('hw-dd') ? 'dd' : prefix.startsWith('hw-sc') ? 'sc' : 'rs';
  if (fase === 'dd') {
    const dd = hom.dueDiligence;
    const cuests = getDDCuestionarios(HW.tercero);
    const cq = cuests[dd.cuestionarioActual||0];
    if (!dd.respuestasPorCuestionario[cq.id]) dd.respuestasPorCuestionario[cq.id] = {};
    const existing = dd.respuestasPorCuestionario[cq.id][qId] || {};
    dd.respuestasPorCuestionario[cq.id][qId] = { ...existing, respuesta: val, _confirmed: true };
  }

  // Re-render just this widget
  const box = document.getElementById(`api-box-${prefix}-${qId}`);
  const qq = document.getElementById(`qq-${prefix}-${qId}`);
  // Find the question def
  const allCuests = [...state.data.cuestionarios];
  let pregunta = null;
  for (const cq of allCuests) {
    pregunta = (cq.preguntas||[]).find(p => p.id === qId);
    if (pregunta) break;
  }
  if (pregunta && box) {
    // Get current saved resp
    const savedResp = fase === 'dd' ? (hom.dueDiligence.respuestasPorCuestionario[getDDCuestionarios(HW.tercero)[hom.dueDiligence.cuestionarioActual||0].id]?.[qId]) : null;
    box.outerHTML = renderApiLookupWidget(pregunta, prefix, savedResp).replace('<div class="api-lookup-box"', `<div class="api-lookup-box" id="api-box-${prefix}-${qId}"`);
  }
  notify('‚úÖ Respuesta confirmada y bloqueada');
}

async function runApiLookup(prefix, qId, cfg) {
  const btn = document.getElementById(`api-btn-${prefix}-${qId}`);
  const resultDiv = document.getElementById(`api-result-${prefix}-${qId}`);
  const prov = cfg.provider ? API_PROVIDERS[cfg.provider] : null;
  if (!prov) { notify('Sin proveedor configurado', 'error'); return; }

  // Update button to loading state
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="api-spinning">‚ü≥</span> Consultando...'; }

  try {
    const tercero = HW.tercero || {};
    let result;

    if (cfg.provider === 'sanctionsnetwork') {
      result = await callSanctionsNetwork(tercero, cfg);
    } else if (cfg.provider === 'opencorporates') {
      result = await callOpenCorporates(tercero, cfg);
    } else if (cfg.provider === 'opensanctions') {
      result = await callOpenSanctions(tercero, cfg);
    } else {
      throw new Error('Proveedor no implementado');
    }

    // Auto-select option
    const autoSel = prov.autoSelectRule(result);
    const autoOpIdx = autoSel.opcionIdx;

    // Find the question to get its pregunta definition
    const allPreguntas = state.data.cuestionarios.flatMap(c => c.preguntas||[]);
    const pregunta = allPreguntas.find(p => p.id === qId);
    const autoOpTexto = pregunta?.opciones?.[autoOpIdx]?.texto || '';

    // Store in HW respuestas
    const savedData = { respuesta: autoOpTexto, _apiResult: result, _autoSel: autoOpIdx, _confirmed: false, _justificacion: autoSel.justificacion };
    storeTempApiResp(prefix, qId, savedData);

    // Re-render the question widget
    const qq = document.getElementById(`qq-${prefix}-${qId}`);
    if (qq && pregunta) {
      qq.innerHTML = `<div class="question-text">${pregunta.texto}${pregunta.obligatoria?'<span style="color:var(--red);margin-left:4px">*</span>':''}<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px;font-size:10px">üîå ${prov.nombre}</span></div>` + renderApiLookupWidget(pregunta, prefix, savedData);
      // Auto-check the radio
      const radio = qq.querySelector(`input[name="${prefix}-${qId}"][value="${autoOpTexto.replace(/"/g,'&quot;')}"]`);
      if (radio) radio.checked = true;
    }

    notify(`‚úÖ ${prov.nombre}: ${autoSel.justificacion}`);
  } catch(e) {
    console.error('API lookup error:', e);
    if (btn) { btn.disabled = false; btn.innerHTML = '‚Ü∫ Reintentar'; }
    notify(`Error consultando ${prov.nombre}: ${e.message}`, 'error');
  }
}

function storeTempApiResp(prefix, qId, data) {
  // Store temporarily in HW so collectQs can pick it up
  if (!HW._apiResps) HW._apiResps = {};
  HW._apiResps[`${prefix}-${qId}`] = data;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  API CALL IMPLEMENTATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function callSanctionsNetwork(tercero, cfg) {
  // sanctions.network ‚Äî completamente gratuito, sin key, sin registro
  // Cubre: OFAC SDN + UN Security Council + EU Financial Sanctions File
  // B√∫squeda fuzzy por similitud trigrama en nombres
  // Base URL: https://api.sanctions.network
  const nombre = encodeURIComponent(tercero.nombre || '');
  const url = `https://api.sanctions.network/rpc/search_sanctions?name=${nombre}&limit=10`;

  let resp;
  try {
    resp = await fetch(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
  } catch(e) {
    // CORS bloqueado ‚Äî ocurre cuando se sirve desde file:// o ciertos entornos
    throw new Error('CORS bloqueado. Sirve la app desde un servidor HTTP (npx serve .) para usar esta API.');
  }

  if (!resp.ok) {
    throw new Error(`sanctions.network devolvi√≥ ${resp.status}. Comprueba conexi√≥n.`);
  }

  const data = await resp.json();
  // Respuesta: array de objetos con campos: names[], source, entity_type, addresses[], etc.
  // "source" puede ser: "ofac", "unsc", "eu"
  const hits = Array.isArray(data) ? data : [];

  // Calcular similitud aproximada comparando nombre buscado con nombres encontrados
  const nombreLower = (tercero.nombre || '').toLowerCase();
  const scored = hits.map(h => {
    const allNames = (h.names || []).map(n => n.toLowerCase());
    const bestMatch = allNames.reduce((best, n) => {
      const sim = stringSimilarity(nombreLower, n);
      return sim > best ? sim : best;
    }, 0);
    return { ...h, similarityScore: bestMatch };
  }).sort((a, b) => b.similarityScore - a.similarityScore);

  const topHit = scored[0];
  const sourceLabel = { ofac: 'OFAC (USA)', unsc: 'ONU ‚Äî Security Council', eu: 'UE ‚Äî Financial Sanctions' };

  return {
    hits: hits.length,
    score: topHit?.similarityScore || 0,
    fuentes: [...new Set(hits.map(h => sourceLabel[h.source] || h.source))],
    topHit: topHit ? {
      nombre: topHit.names?.[0] || '‚Äî',
      source: sourceLabel[topHit.source] || topHit.source,
      similarityScore: topHit.similarityScore,
      entityType: topHit.entity_type || '‚Äî',
      country: (topHit.addresses || [])[0]?.country || '‚Äî',
      aliases: (topHit.names || []).slice(1, 4),
      url: `https://sanctions.network/#${encodeURIComponent(topHit.names?.[0] || '')}`
    } : null,
    raw: data
  };
}

async function callOpenCorporates(tercero, cfg) {
  // OpenCorporates ‚Äî datos registrales p√∫blicos, ~10 req/d√≠a sin key
  const nombre = encodeURIComponent(tercero.nombre || '');
  const pais = tercero.pais ? `&jurisdiction_code=${tercero.pais.slice(0,2).toLowerCase()}` : '';
  const url = `https://api.opencorporates.com/v0.4/companies/search?q=${nombre}&format=json${pais}`;

  let resp;
  try {
    resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
  } catch(e) {
    throw new Error('CORS bloqueado. Sirve la app desde un servidor HTTP.');
  }

  if (resp.status === 429) throw new Error('L√≠mite de OpenCorporates alcanzado. Espera unos minutos o usa una API key.');
  if (!resp.ok) throw new Error(`OpenCorporates devolvi√≥ ${resp.status}`);

  const data = await resp.json();
  const companies = (data?.results?.companies || []).map(c => c.company);
  const best = companies[0];

  return {
    hits: companies.length,
    score: best ? stringSimilarity((tercero.nombre||'').toLowerCase(), (best.name||'').toLowerCase()) : 0,
    topHit: best ? {
      nombre: best.name,
      pais: best.jurisdiction_code?.toUpperCase(),
      numero: best.company_number,
      estado: best.current_status,
      tipo: best.company_type,
      fechaConstitucion: best.incorporation_date,
      url: best.opencorporates_url
    } : null,
    raw: data
  };
}

async function callOpenSanctions(tercero, cfg) {
  // OpenSanctions ‚Äî requiere API key (trial 30 d√≠as gratis en opensanctions.org)
  const apiKey = cfg.apiKey || '';
  if (!apiKey) throw new Error('OpenSanctions requiere API key. Cons√≠guela en opensanctions.org/api (trial 30 d√≠as gratuito).');

  const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': `ApiKey ${apiKey}` };
  const body = JSON.stringify({
    queries: {
      q1: {
        schema: 'Company',
        properties: {
          name: [tercero.nombre || ''],
          country: [tercero.pais ? tercero.pais.slice(0,2).toUpperCase() : ''],
          ...(tercero.cif ? { registrationNumber: [tercero.cif] } : {})
        }
      }
    }
  });

  let resp;
  try {
    resp = await fetch('https://api.opensanctions.org/match/default?algorithm=best&limit=5', { method:'POST', headers, body });
  } catch(e) {
    throw new Error('No se pudo conectar con OpenSanctions. Comprueba la API key y la conexi√≥n.');
  }

  if (resp.status === 401) throw new Error('API key inv√°lida o expirada.');
  if (resp.status === 402) throw new Error('Cr√©ditos OpenSanctions agotados. Revisa tu cuenta.');
  if (!resp.ok) { const err = await resp.text(); throw new Error(`OpenSanctions ${resp.status}: ${err.slice(0,120)}`); }

  const data = await resp.json();
  const results = data?.responses?.q1?.results || [];
  const best = results[0];
  return {
    hits: results.filter(r => r.score >= 0.5).length,
    score: best?.score || 0,
    topHit: best ? {
      nombre: best.caption,
      score: best.score,
      datasets: best.datasets?.join(', '),
      url: `https://www.opensanctions.org/entities/${best.id}/`
    } : null,
    raw: data
  };
}

// Similitud simple de strings (Dice coefficient sobre bigramas)
function stringSimilarity(a, b) {
  if (!a || !b) return 0;
  if (a === b) return 1;
  const getBigrams = s => { const bg = new Set(); for (let i=0;i<s.length-1;i++) bg.add(s.slice(i,i+2)); return bg; };
  const ba = getBigrams(a), bb = getBigrams(b);
  let inter = 0; ba.forEach(g => { if (bb.has(g)) inter++; });
  return (2 * inter) / (ba.size + bb.size) || 0;
}

function collectQs(prefix, preguntas) {
  const resp = {};
  preguntas.forEach(p => {
    if (p.tipo === 'api_lookup') {
      // Check HW temp store first, then existing saved respuestas
      const tempKey = `${prefix}-${p.id}`;
      const tempData = HW._apiResps?.[tempKey];
      if (tempData) {
        // Use the radio selection (may have been changed by user)
        const checked = document.querySelector(`input[name="${prefix}-${p.id}"]:checked`);
        resp[p.id] = { ...(tempData), respuesta: checked?.value || tempData.respuesta };
      } else {
        const checked = document.querySelector(`input[name="${prefix}-${p.id}"]:checked`);
        if (checked) resp[p.id] = { respuesta: checked.value, _confirmed: false };
      }
    } else if (p.tipo === 'abierta') {
      const el = document.getElementById(`${prefix}-${p.id}`); if (el) resp[p.id] = el.value;
    } else {
      const c = document.querySelector(`input[name="${prefix}-${p.id}"]:checked`); if (c) resp[p.id] = c.value;
    }
  });
  return resp;
}

function isAnswered(p, resp) {
  if (resp === undefined || resp === null || resp === '') return false;
  if (p.tipo === 'api_lookup') return !!(resp?.respuesta);
  return true;
}

async function hwSubmitScope() {
  const cq = state.data.cuestionarios.find(c => c.tipo === 'scope_check');
  if (!cq) { notify('Sin cuestionario de Scope Check', 'error'); return; }
  const resp = collectQs('hw-sc', cq.preguntas||[]);
  const missing = (cq.preguntas||[]).filter(p => p.obligatoria && !isAnswered(p, resp[p.id]));
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const unconfirmed = (cq.preguntas||[]).filter(p => p.tipo==='api_lookup' && p.apiConfig?.requireConfirmation && resp[p.id] && !resp[p.id]._confirmed);
  if (unconfirmed.length) { notify(`${unconfirmed.length} consulta(s) API pendiente(s) de confirmar`, 'error'); return; }
  const { score, hasFlag } = calcScore(cq.preguntas||[], resp);
  const material = score >= (cq.umbralMaterial||2);
  HW.hom.scopeCheck = { respuestas:resp, score, resultado: material?'material':'no_material' };
  if (!material) {
    HW.hom.fase = 'fuera_scope'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
    await saveItem('homologaciones', HW.hom);
    notify('Tercero marcado como Fuera de Scope ‚Äî no requiere homologaci√≥n');
    closeModal(); renderTerceros(); return;
  }
  HW.hom.fase = 'risk_scoring';
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwSubmitRisk() {
  const cq = state.data.cuestionarios.find(c => c.tipo === 'risk_scoring');
  if (!cq) { notify('Sin cuestionario de Risk Scoring', 'error'); return; }
  const resp = collectQs('hw-rs', cq.preguntas||[]);
  const missing = (cq.preguntas||[]).filter(p => p.obligatoria && !isAnswered(p, resp[p.id]));
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const unconfirmed = (cq.preguntas||[]).filter(p => p.tipo==='api_lookup' && p.apiConfig?.requireConfirmation && resp[p.id] && !resp[p.id]._confirmed);
  if (unconfirmed.length) { notify(`${unconfirmed.length} consulta(s) API pendiente(s) de confirmar`, 'error'); return; }
  const { score, hasFlag } = calcScore(cq.preguntas||[], resp);
  const nivel = getRiskLevel(cq, score, hasFlag);
  HW.hom.riskScoring = { respuestas:resp, score, resultado:nivel, hasFlag };

  if (nivel === 'bajo' && !hasFlag) {
    HW.hom.riesgoFinal = 'bajo'; HW.hom.fase = 'completada'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
    const plazos = state.data.plazos||{bajo:36};
    const tercero = state.data.terceros.find(t => t.id === HW.hom.terceroId);
    if (tercero) { tercero.riesgo = 'bajo'; tercero.fechaUltima = HW.hom.fechaCierre; if (!tercero.fechaPrimera) tercero.fechaPrimera = HW.hom.fechaCierre; tercero.fechaSiguiente = addMonths(HW.hom.fechaCierre, plazos.bajo||36); await saveItem('terceros', tercero); HW.tercero = tercero; }
    await saveItem('homologaciones', HW.hom);
    notify('‚úÖ Risk Scoring Bajo ‚Äî Homologado autom√°ticamente');
    document.getElementById('hw-body').innerHTML = hwStep();
    document.getElementById('hw-footer').innerHTML = hwFooter(); return;
  }

  const ddNivel = (nivel === 'alto' || hasFlag) ? 'alto' : 'medio';
  const cuests = getDDCuestionarios(HW.tercero);
  HW.hom.dueDiligence = { nivel:ddNivel, cuestionariosOrder:cuests.map(c=>c.id), respuestasPorCuestionario:{}, resultadoPorCuestionario:{}, resultadoFinal:'', cuestionarioActual:0 };
  HW.hom.fase = 'due_diligence';
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwSubmitDD() {
  const dd = HW.hom.dueDiligence, cuests = getDDCuestionarios(HW.tercero);
  const idx = dd.cuestionarioActual||0, cq = cuests[idx];
  const preguntas = filterByDDLevel(cq.preguntas||[], dd.nivel);
  const resp = collectQs('hw-dd', preguntas);
  const missing = preguntas.filter(p => p.obligatoria && !isAnswered(p, resp[p.id]));
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const unconfirmed = preguntas.filter(p => p.tipo==='api_lookup' && p.apiConfig?.requireConfirmation && resp[p.id] && !resp[p.id]._confirmed);
  if (unconfirmed.length) { notify(`${unconfirmed.length} consulta(s) API pendiente(s) de confirmar`, 'error'); return; }
  const { score, hasFlag } = calcScore(preguntas, resp);
  const nivel = getRiskLevel(cq, score, hasFlag);
  dd.respuestasPorCuestionario[cq.id] = resp;
  dd.resultadoPorCuestionario[cq.id] = { score, hasFlag, resultado:nivel };

  if (idx < cuests.length-1) { dd.cuestionarioActual = idx+1; await saveItem('homologaciones', HW.hom); document.getElementById('hw-body').innerHTML = hwStep(); document.getElementById('hw-footer').innerHTML = hwFooter(); return; }

  const results = Object.values(dd.resultadoPorCuestionario);
  dd.resultadoFinal = results.some(r=>r.hasFlag||r.resultado==='alto') ? 'alto' : results.some(r=>r.resultado==='medio') ? 'medio' : 'bajo';

  const cqG = state.data.cuestionarios.find(c => c.tipo === 'general');
  const aprobador = cqG?.aprobadores?.[dd.resultadoFinal]||'';
  if (aprobador) { HW.hom.fase = 'aprobacion'; } else { await hwCompletar(); return; }
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwAprobar() {
  HW.hom.aprobacion = { estado:'aprobado', aprobadoPor:'Admin Usuario', fecha:new Date().toISOString().split('T')[0], comentario:document.getElementById('apr-com')?.value||'' };
  await hwCompletar();
}

async function hwCompletar() {
  const dd = HW.hom.dueDiligence;
  HW.hom.riesgoFinal = dd.resultadoFinal||'bajo'; HW.hom.fase = 'completada'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
  const plazos = state.data.plazos||{alto:12,medio:24,bajo:36};
  const meses = plazos[HW.hom.riesgoFinal]||24;
  const tercero = state.data.terceros.find(t => t.id === HW.hom.terceroId);
  if (tercero) { tercero.riesgo = HW.hom.riesgoFinal; tercero.fechaUltima = HW.hom.fechaCierre; if (!tercero.fechaPrimera) tercero.fechaPrimera = HW.hom.fechaCierre; tercero.fechaSiguiente = addMonths(HW.hom.fechaCierre, meses); await saveItem('terceros', tercero); HW.tercero = tercero; }
  await saveItem('homologaciones', HW.hom);
  notify(`‚úÖ Homologaci√≥n completada ‚Äî Riesgo ${HW.hom.riesgoFinal.toUpperCase()}`);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOMOLOGACIONES ‚Äî list page
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHomologaciones() {
  const homs = state.data.homologaciones;
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Homologaciones</div><div class="section-sub">${homs.length} registros</div></div>
    </div>
    ${!homs.length ? `<div style="text-align:center;padding:80px 20px;color:var(--text3)"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 16px;display:block;opacity:.4"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><p>Sin homologaciones. Inicia una desde el Maestro de Terceros.</p></div>` : `
    <div class="card" style="padding:0">
      <div class="table-wrap"><table>
        <thead><tr><th>Tercero</th><th>Inicio</th><th>Fase</th><th>Scope</th><th>Risk Scoring</th><th>DD Nivel</th><th>Resultado</th><th>Cierre</th><th>Acciones</th></tr></thead>
        <tbody>${homs.sort((a,b)=>new Date(b.fechaInicio)-new Date(a.fechaInicio)).map(h => `<tr>
          <td style="color:var(--text);font-weight:500">${h.terceroNombre}</td>
          <td>${fmtDate(h.fechaInicio)}</td>
          <td>${homBadge(h.fase)}</td>
          <td>${h.scopeCheck?.resultado ? `<span class="badge ${h.scopeCheck.resultado==='material'?'badge-amber':'badge-gray'}">${h.scopeCheck.resultado}</span>` : '‚Äî'}</td>
          <td>${h.riskScoring?.resultado ? riskBadge(h.riskScoring.resultado) : '‚Äî'}</td>
          <td>${h.dueDiligence?.nivel ? `<span class="badge ${h.dueDiligence.nivel==='alto'?'badge-red':'badge-amber'}">${h.dueDiligence.nivel==='alto'?'Completa':'Reducida'}</span>` : '‚Äî'}</td>
          <td>${h.riesgoFinal ? riskBadge(h.riesgoFinal) : '‚Äî'}</td>
          <td>${fmtDate(h.fechaCierre)}</td>
          <td><div style="display:flex;gap:4px">
            ${!['completada','fuera_scope'].includes(h.fase) ? `<button class="btn btn-success btn-sm" onclick="resumeHom('${h.id}')">${SVG.play} Continuar</button>` : ''}
            <button class="btn btn-danger btn-icon btn-sm" onclick="deleteHom('${h.id}')">${SVG.trash}</button>
          </div></td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>`}`;
}

async function deleteHom(id) { if (!confirm('¬øEliminar esta homologaci√≥n?')) return; await deleteItem('homologaciones', id); notify('Eliminada'); renderHomologaciones(); }
function resumeHom(id) { const h = state.data.homologaciones.find(x=>x.id===id); const t = state.data.terceros.find(x=>x.id===h?.terceroId); if (!h||!t) return; HW = {hom:h, tercero:t}; renderHW(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAZOS ‚Äî config page
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPlazos() {
  const p = state.data.plazos||{alto:12,medio:24,bajo:36};
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div><div class="section-title">Plazos de Renovaci√≥n</div><div class="section-sub">Meses hasta la siguiente homologaci√≥n seg√∫n resultado</div></div></div>
    <div class="info-box" style="margin-bottom:20px">‚ÑπÔ∏è Al completar una homologaci√≥n, el sistema calcula autom√°ticamente la fecha de siguiente renovaci√≥n: fecha de cierre + los meses configurados aqu√≠.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px">
      ${[['alto','üî¥ Riesgo Alto','var(--red)'],['medio','üü° Riesgo Medio','var(--amber)'],['bajo','üü¢ Riesgo Bajo','var(--green)']].map(([k,l,c]) => `
        <div class="card" style="border-left:3px solid ${c}">
          <div style="color:${c};font-weight:700;font-family:'Syne',sans-serif;font-size:15px;margin-bottom:16px">${l}</div>
          <div class="form-group"><label class="form-label">Meses hasta renovaci√≥n</label>
            <input class="form-input" type="number" min="1" max="120" id="pl-${k}" value="${p[k]||0}" style="max-width:120px">
          </div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Equivale a <strong style="color:var(--text2)">${((p[k]||0)/12).toFixed(1)} a√±os</strong></div>
        </div>`).join('')}
    </div>
    <div style="margin-top:24px;display:flex;justify-content:flex-end">
      <button class="btn btn-primary" onclick="savePlazos()">${SVG.check} Guardar Plazos</button>
    </div>`;
}

async function savePlazos() {
  state.data.plazos = { alto: parseInt(document.getElementById('pl-alto').value)||12, medio: parseInt(document.getElementById('pl-medio').value)||24, bajo: parseInt(document.getElementById('pl-bajo').value)||36 };
  if (db) { try { await db.collection('config').doc('plazos').set(state.data.plazos); } catch(e){} }
  notify('Plazos guardados'); renderPlazos();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT ‚Äî auto-connect Firestore, then render
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
FS.init().then(() => navigate('dashboard'));
</script>
</body>
</html>
