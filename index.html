<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPRM · Gestión de Riesgos de Terceros</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #181c24;
    --surface3: #1e2330;
    --border: #252a36;
    --border2: #2e3545;
    --accent: #3b82f6;
    --accent2: #6366f1;
    --accent-glow: rgba(59,130,246,0.15);
    --text: #e8eaf0;
    --text2: #8b92a5;
    --text3: #5a6278;
    --red: #ef4444;
    --red-soft: rgba(239,68,68,0.12);
    --amber: #f59e0b;
    --amber-soft: rgba(245,158,11,0.12);
    --green: #10b981;
    --green-soft: rgba(16,185,129,0.12);
    --purple: #8b5cf6;
    --purple-soft: rgba(139,92,246,0.12);
    --cyan: #06b6d4;
    --sidebar-w: 240px;
    --header-h: 60px;
    --radius: 10px;
    --radius-sm: 6px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  #app { display: flex; height: 100vh; overflow: hidden; }

  #sidebar {
    width: var(--sidebar-w); flex-shrink: 0;
    background: var(--surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow-y: auto; z-index: 100;
  }
  .sidebar-logo { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); }
  .sidebar-logo .logo-text {
    font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .sidebar-logo .logo-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; margin-top: 2px; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-section-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); padding: 0 8px; margin-bottom: 6px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; border-radius: var(--radius-sm);
    cursor: pointer; color: var(--text2); font-size: 13px;
    transition: all 0.15s; margin-bottom: 2px; user-select: none;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent-glow); color: var(--accent); font-weight: 500; }
  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #topbar {
    height: var(--header-h); flex-shrink: 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; border-bottom: 1px solid var(--border); background: var(--surface);
  }
  .topbar-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--surface2); border-radius: 20px; font-size: 12px; cursor: pointer; }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white; flex-shrink: 0;
  }
  #content { flex: 1; overflow-y: auto; padding: 24px; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500; cursor: pointer;
    border: none; transition: all 0.15s; font-family: inherit; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #2563eb; box-shadow: 0 0 20px rgba(59,130,246,0.3); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
  .btn-secondary:hover { background: var(--surface3); }
  .btn-danger { background: var(--red-soft); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
  .btn-danger:hover { background: rgba(239,68,68,0.2); }
  .btn-ghost { background: transparent; color: var(--text2); border: none; }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: var(--radius-sm); }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 16px; }

  .badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; }
  .badge-red { background: var(--red-soft); color: var(--red); }
  .badge-amber { background: var(--amber-soft); color: var(--amber); }
  .badge-green { background: var(--green-soft); color: var(--green); }
  .badge-blue { background: var(--accent-glow); color: var(--accent); }
  .badge-purple { background: var(--purple-soft); color: var(--purple); }
  .badge-gray { background: var(--surface3); color: var(--text2); }

  .hom-status { display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500; }
  .hom-pendiente { background:var(--surface3);color:var(--text3); }
  .hom-fuera { background:var(--surface3);color:var(--text3); }
  .hom-scope { background:rgba(6,182,212,.12);color:#06b6d4; }
  .hom-scoring { background:var(--amber-soft);color:var(--amber); }
  .hom-dd { background:rgba(139,92,246,.12);color:#8b5cf6; }
  .hom-aprobacion { background:var(--accent-glow);color:var(--accent); }
  .hom-completada { background:var(--green-soft);color:var(--green); }

  .btn-success { background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,.2); }
  .btn-success:hover { background:rgba(16,185,129,.2); }

  /* FORMS */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
  .form-input, .form-select, .form-textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); color: var(--text);
    padding: 8px 12px; font-size: 13px; font-family: inherit;
    outline: none; transition: border-color 0.15s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-input:disabled { opacity: 0.4; cursor: not-allowed; }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-select option { background: var(--surface2); }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .form-note { font-size: 11px; color: var(--text3); margin-top: 4px; }

  /* TOGGLE — pure CSS, no JS needed for visual */
  .toggle { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--surface3); border-radius: 20px; transition: 0.2s; }
  .toggle-slider::before { content: ''; position: absolute; width: 14px; height: 14px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: 0.2s; }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  /* CHIP SELECTOR — rewritten to use pure data attributes, no classList toggling issues */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid var(--border2); cursor: pointer;
    font-size: 12px; color: var(--text2); transition: all 0.15s;
    user-select: none; background: var(--surface2);
  }
  .chip:hover { border-color: var(--accent); color: var(--text); }
  .chip[data-sel="1"] { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
  .chip-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text3); padding: 10px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 12px 12px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text2); vertical-align: middle; }
  tr:hover td { background: var(--surface2); }
  tr:last-child td { border-bottom: none; }

  /* MODAL */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px); z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.15s ease;
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); width: 90%; max-width: 700px;
    max-height: 90vh; display: flex; flex-direction: column;
    animation: slideUp 0.2s ease;
  }
  .modal-lg { max-width: 900px; }
  .modal-xl { max-width: 1100px; }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; gap: 16px; }
  .modal-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
  .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; align-items: center; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* TABS */
  .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 10px 16px; cursor: pointer; color: var(--text2); font-size: 13px; border-bottom: 2px solid transparent; transition: all 0.15s; margin-bottom: -1px; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }

  /* SEARCH */
  .search-bar { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 8px 12px; color: var(--text2); }
  .search-bar input { background: none; border: none; outline: none; color: var(--text); font-size: 13px; flex: 1; font-family: inherit; }
  .search-bar input::placeholder { color: var(--text3); }

  .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; }
  .stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--text3); margin-top: 6px; }

  /* RISK BADGES */
  .risk-tag-sin { background: var(--surface3); color: var(--text3); }
  .risk-tag-proceso { background: var(--accent-glow); color: var(--accent); }
  .risk-tag-alto { background: var(--red-soft); color: var(--red); }
  .risk-tag-medio { background: var(--amber-soft); color: var(--amber); }
  .risk-tag-bajo { background: var(--green-soft); color: var(--green); }

  /* CHART BARS */
  .chart-bar { display: flex; flex-direction: column; gap: 10px; }
  .chart-bar-row { display: flex; align-items: center; gap: 10px; }
  .chart-bar-label { font-size: 12px; color: var(--text2); width: 100px; flex-shrink: 0; text-align: right; }
  .chart-bar-track { flex: 1; height: 20px; background: var(--surface3); border-radius: 4px; overflow: hidden; }
  .chart-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; font-size: 11px; color: white; font-weight: 600; min-width: 4px; }
  .chart-bar-val { font-size: 12px; color: var(--text2); width: 24px; text-align: right; }

  /* QUESTION BUILDER */
  .question-card { background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .question-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent-glow); color: var(--accent); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .option-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .option-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; color: var(--text); font-size: 12px; font-family: inherit; outline: none; }
  .option-input:focus { border-color: var(--accent); }
  .option-score { width: 64px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--amber); font-size: 12px; font-family: inherit; outline: none; text-align: center; }
  .flag-btn { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); background: var(--surface); font-size: 13px; transition: all 0.15s; flex-shrink: 0; }
  .flag-btn.on { background: var(--red-soft); border-color: rgba(239,68,68,0.3); }

  /* WIZARD STEPS */
  .wizard-steps { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
  .wizard-step { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text3); }
  .wizard-step.active { color: var(--accent); font-weight: 600; }
  .wizard-step.done { color: var(--green); }
  .step-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .wizard-step .step-dot { background: var(--surface3); color: var(--text3); }
  .wizard-step.active .step-dot { background: var(--accent); color: white; }
  .wizard-step.done .step-dot { background: var(--green); color: white; }
  .step-sep { color: var(--border2); font-size: 14px; }

  /* COUNTRY TAG INPUT */
  .tag-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm); padding: 6px 10px; min-height: 42px; cursor: text; }
  .tag-input-wrap:focus-within { border-color: var(--accent); }
  .tag-pill { display: flex; align-items: center; gap: 4px; background: var(--accent-glow); border: 1px solid var(--accent); color: var(--accent); border-radius: 20px; padding: 2px 8px; font-size: 12px; }
  .tag-pill button { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 14px; line-height: 1; padding: 0; opacity: 0.7; }
  .tag-pill button:hover { opacity: 1; }
  .tag-input-field { background: none; border: none; outline: none; color: var(--text); font-size: 13px; font-family: inherit; min-width: 120px; flex: 1; }
  .tag-dropdown { position: absolute; z-index: 200; background: var(--surface); border: 1px solid var(--border2); border-radius: var(--radius-sm); max-height: 220px; overflow-y: auto; width: 100%; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .tag-option { padding: 8px 12px; cursor: pointer; font-size: 13px; color: var(--text2); }
  .tag-option:hover { background: var(--surface2); color: var(--text); }
  .tag-option.highlighted { background: var(--accent-glow); color: var(--accent); }
  .tag-wrap-pos { position: relative; }

  /* NOTIFICATION */
  .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 12px 20px; border-radius: var(--radius); font-size: 13px; font-weight: 500; animation: slideRight 0.3s ease; max-width: 340px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .notification-success { background: var(--green); color: white; }
  .notification-error { background: var(--red); color: white; }
  @keyframes slideRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .section-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
  .section-sub { font-size: 13px; color: var(--text3); margin-top: 2px; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; display: block; margin: 0 auto 16px; }
  .action-plan-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .info-box { background: var(--accent-glow); border: 1px solid rgba(59,130,246,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--accent); }
  .warn-box { background: var(--amber-soft); border: 1px solid rgba(245,158,11,0.2); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 12px; color: var(--amber); }
</style>
</head>
<body>
<div id="app">
  <nav id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">TPRM</div>
      <div class="logo-sub">Risk Management Platform</div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Principal</div>
      <div class="nav-item" data-page="dashboard" onclick="navigate('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="nav-item" data-page="terceros" onclick="navigate('terceros')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Maestro de Terceros
      </div>
      <div class="nav-item" data-page="homologaciones" onclick="navigate('homologaciones')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Homologaciones
      </div>
      <div class="nav-item" data-page="planes" onclick="navigate('planes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Planes de Acción
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Configuración</div>
      <div class="nav-item" data-page="usuarios" onclick="navigate('usuarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Usuarios y Roles
      </div>
      <div class="nav-item" data-page="ambitos" onclick="navigate('ambitos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
        Ámbitos de Riesgo
      </div>
      <div class="nav-item" data-page="tipos" onclick="navigate('tipos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Tipos de Tercero
      </div>
      <div class="nav-item" data-page="cuestionarios" onclick="navigate('cuestionarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Cuestionarios
      </div>
      <div class="nav-item" data-page="plazos" onclick="navigate('plazos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Plazos de Renovación
      </div>
    </div>

  </nav>

  <main id="main">
    <div id="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <div class="user-badge">
          <div class="user-avatar">AU</div>
          <span>Admin Usuario</span>
        </div>
      </div>
    </div>
    <div id="content"></div>
  </main>
</div>

<div id="modals"></div>
<div id="notifications"></div>

<script>
// ══════════════════════════════════════════════════════════════
//  COUNTRIES LIST
// ══════════════════════════════════════════════════════════════
const COUNTRIES = [
  "Afganistán","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia",
  "Australia","Austria","Azerbaiyán","Bahamas","Bangladés","Barbados","Baréin","Bélgica","Belice","Benín","Bielorrusia",
  "Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","Brunéi","Bulgaria","Burkina Faso","Burundi","Bután","Cabo Verde",
  "Camboya","Camerún","Canadá","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Congo","Corea del Norte",
  "Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador",
  "Emiratos Árabes Unidos","Eritrea","Eslovaquia","Eslovenia","España","Estados Unidos","Estonia","Etiopía","Fiyi",
  "Filipinas","Finlandia","Francia","Gabón","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea",
  "Guinea Ecuatorial","Guinea-Bisáu","Guyana","Haití","Honduras","Hungría","India","Indonesia","Irak","Irán","Irlanda",
  "Islandia","Islas Marshall","Islas Salomón","Israel","Italia","Jamaica","Japón","Jordania","Kazajistán","Kenia",
  "Kirguistán","Kiribati","Kuwait","Laos","Lesoto","Letonia","Líbano","Liberia","Libia","Liechtenstein","Lituania",
  "Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","Mali","Malta","Marruecos","Mauricio","Mauritania","México",
  "Micronesia","Moldavia","Mónaco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","Níger",
  "Nigeria","Noruega","Nueva Zelanda","Omán","Países Bajos","Pakistán","Palaos","Palestina","Panamá","Papúa Nueva Guinea",
  "Paraguay","Perú","Polonia","Portugal","Reino Unido","República Centroafricana","República Checa","República Dominicana",
  "Ruanda","Rumanía","Rusia","Samoa","San Cristóbal y Nieves","San Marino","San Vicente y las Granadinas","Santa Lucía",
  "Santo Tomé y Príncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka",
  "Suazilandia","Sudáfrica","Sudán","Sudán del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","Tayikistán",
  "Timor Oriental","Togo","Tonga","Trinidad y Tobago","Túnez","Turkmenistán","Turquía","Tuvalu","Ucrania","Uganda",
  "Uruguay","Uzbekistán","Vanuatu","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue"
];

// ══════════════════════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════════════════════
const state = {
  currentPage: 'dashboard',
  data: {
    terceros: [
      { id:'t1', nombre:'Accenture Spain', denominacion:'Accenture S.L.', grupo:'Accenture PLC', cif:'B82387770', domicilio:'Av. de Bruselas 35, Alcobendas', pais:'España', representante:'José García', responsable:'María Pérez', tipo:'Proveedor Directo', ambitos:['Cyber','Data Protection','IA'], fechaPrimera:'2022-03-15', fechaSiguiente:'2025-03-15', fechaUltima:'2024-03-15', riesgo:'medio', comentarios:'Proveedor estratégico de TI', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t2', nombre:'Deloitte Advisory', denominacion:'Deloitte Advisory S.L.', grupo:'Deloitte Global', cif:'B79835397', domicilio:'Plaza Pablo Ruiz Picasso 1, Madrid', pais:'España', representante:'Ana López', responsable:'Carlos Ruiz', tipo:'Proveedor Directo', ambitos:['Compliance','Fiscal','ESG'], fechaPrimera:'2021-06-01', fechaSiguiente:'2024-06-01', fechaUltima:'2023-06-01', riesgo:'bajo', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
      { id:'t3', nombre:'Amazon Web Services', denominacion:'Amazon Web Services EMEA SARL', grupo:'Amazon Inc', cif:'B67890123', domicilio:'38 Av JF Kennedy, Luxemburgo', pais:'Luxemburgo', representante:'Peter Schmidt', responsable:'Laura Torres', tipo:'Proveedor Directo', ambitos:['Cyber','Data Protection'], fechaPrimera:'2023-01-10', fechaSiguiente:'2025-01-10', fechaUltima:'2024-01-10', riesgo:'alto', comentarios:'Procesamiento datos críticos', remediacion:'Realizar auditoría de seguridad Q2 2025', remediacionUser:'laura.torres@empresa.com', remediacionFecha:'2025-06-30', activo:true },
      { id:'t4', nombre:'Carrefour España', denominacion:'Carrefour España S.A.', grupo:'Carrefour Group', cif:'A28375103', domicilio:'C/ Campezo 16, Madrid', pais:'España', representante:'Philippe Dumont', responsable:'Ignacio Sanz', tipo:'Cliente', ambitos:['EUDR','ESG'], fechaPrimera:'2020-09-01', fechaSiguiente:'2025-09-01', fechaUltima:'2023-09-01', riesgo:'sin valorar', comentarios:'', remediacion:'', remediacionUser:'', remediacionFecha:'', activo:true },
    ],
    usuarios: [
      { id:'u1', nombre:'Admin Usuario', email:'admin@empresa.com', roles:['admin'], activo:true },
      { id:'u2', nombre:'María Pérez', email:'maria.perez@empresa.com', roles:['usuario','aprobador'], activo:true },
      { id:'u3', nombre:'Carlos Ruiz', email:'carlos.ruiz@empresa.com', roles:['supervisor'], activo:true },
      { id:'u4', nombre:'Laura Torres', email:'laura.torres@empresa.com', roles:['usuario'], activo:true },
    ],
    ambitos: [
      { id:'a1', nombre:'Cyber', descripcion:'Riesgos de ciberseguridad', responsable:'María Pérez', color:'#3b82f6', cuestionarios:['c1'] },
      { id:'a2', nombre:'Compliance', descripcion:'Cumplimiento normativo', responsable:'Carlos Ruiz', color:'#8b5cf6', cuestionarios:[] },
      { id:'a3', nombre:'EUDR', descripcion:'EU Deforestation Regulation', responsable:'Laura Torres', color:'#10b981', cuestionarios:[] },
      { id:'a4', nombre:'Data Protection', descripcion:'Protección de datos RGPD', responsable:'María Pérez', color:'#f59e0b', cuestionarios:[] },
      { id:'a5', nombre:'IA', descripcion:'Inteligencia Artificial Act', responsable:'Admin Usuario', color:'#06b6d4', cuestionarios:[] },
      { id:'a6', nombre:'Fiscal', descripcion:'Riesgos fiscales y tributarios', responsable:'Carlos Ruiz', color:'#ef4444', cuestionarios:[] },
      { id:'a7', nombre:'ESG', descripcion:'Environmental, Social & Governance', responsable:'Laura Torres', color:'#84cc16', cuestionarios:[] },
    ],
    tipos: [
      { id:'tp1', nivel1:'Proveedor', nivel2:'Proveedor Directo', nivel3:'', terceros:['t1','t2','t3'] },
      { id:'tp2', nivel1:'Proveedor', nivel2:'Proveedor Indirecto', nivel3:'', terceros:[] },
      { id:'tp3', nivel1:'Cliente', nivel2:'', nivel3:'', terceros:['t4'] },
    ],
    cuestionarios: [
      {
        id:'cg1', nombre:'Cuestionario General (Base)', tipo:'general', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'q1', texto:'¿Cuántos años lleva la organización en funcionamiento?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Más de 10 años',valor:3,flag:false},{texto:'Entre 5 y 10 años',valor:2,flag:false},{texto:'Menos de 5 años',valor:1,flag:false}] },
          { id:'q2', texto:'¿Dispone de un código de conducta publicado y actualizado?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sí, publicado y actualizado',valor:3,flag:false},{texto:'Sí, pero no actualizado',valor:1,flag:false},{texto:'No',valor:0,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'María Pérez',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cs1', nombre:'Scope Check', tipo:'scope_check', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'s1', texto:'¿El valor anual de la relación supera los 100.000€?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sí',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s2', texto:'¿El tercero tiene acceso a datos personales de clientes?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sí',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
          { id:'s3', texto:'¿El tercero forma parte de la cadena de suministro crítica?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sí',valor:2,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:1}, nivelRiesgoMedio:{min:2,max:3}, nivelRiesgoAlto:{min:4,max:99},
        umbralMaterial:2, bloqueoRedFlag:false, aprobadores:{alto:'',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'cr1', nombre:'Risk Scoring General', tipo:'risk_scoring', ambito:'', ambito_id:'',
        aplicaTodos:true, paises:[], ambitosAplicables:[], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'r1', texto:'¿En qué región está domiciliado el tercero?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'UE / OCDE (bajo riesgo)',valor:1,flag:false},{texto:'País de riesgo medio',valor:2,flag:false},{texto:'País de alto riesgo o sancionado',valor:3,flag:true}] },
          { id:'r2', texto:'¿Qué nivel de acceso tendrá a sistemas internos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sin acceso',valor:0,flag:false},{texto:'Acceso limitado / controlado',valor:1,flag:false},{texto:'Acceso amplio a sistemas críticos',valor:3,flag:true}] },
          { id:'r3', texto:'¿Existen antecedentes de incidentes o sanciones conocidos?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'No se conocen',valor:0,flag:false},{texto:'Incidentes menores resueltos',valor:1,flag:false},{texto:'Sanciones o incidentes graves',valor:3,flag:true}] },
        ],
        nivelRiesgoBajo:{min:0,max:2}, nivelRiesgoMedio:{min:3,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'',bajo:''},
        creado:'2024-01-01', modificado:'2024-01-01'
      },
      {
        id:'c1', nombre:'Cuestionario Cyber', tipo:'due_diligence', ambito:'Cyber', ambito_id:'a1',
        aplicaTodos:true, paises:[], ambitosAplicables:['Cyber'], nivelesRiesgo:[], tiposProveedor:[],
        preguntas:[
          { id:'cq1', texto:'¿Dispone de política de ciberseguridad documentada?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Sí, documentada y actualizada',valor:3,flag:false},{texto:'Sí, pero no actualizada',valor:2,flag:false},{texto:'No existe',valor:0,flag:true}] },
          { id:'cq2', texto:'¿Realiza auditorías de seguridad periódicas?', tipo:'select_unico', obligatoria:true, soloCompleta:false, opciones:[{texto:'Anualmente o más frecuente',valor:3,flag:false},{texto:'Cada 2-3 años',valor:2,flag:false},{texto:'Nunca o no sabe',valor:0,flag:true}] },
          { id:'cq3', texto:'¿Cuenta con seguro de ciberriesgo?', tipo:'select_unico', obligatoria:true, soloCompleta:true, opciones:[{texto:'Sí, con cobertura adecuada',valor:3,flag:false},{texto:'No',valor:0,flag:false}] },
        ],
        nivelRiesgoBajo:{min:0,max:3}, nivelRiesgoMedio:{min:4,max:5}, nivelRiesgoAlto:{min:6,max:99},
        umbralMaterial:0, bloqueoRedFlag:true, aprobadores:{alto:'Carlos Ruiz',medio:'María Pérez',bajo:''},
        creado:'2024-01-15', modificado:'2024-03-10'
      }
    ],
    homologaciones: [],
    plazos: { alto:12, medio:24, bajo:36 },
    planes: [
      { id:'p1', terceroId:'t3', terceroNombre:'Amazon Web Services', titulo:'Auditoría de seguridad Q2 2025', descripcion:'Realizar auditoría completa de controles de seguridad', responsable:'laura.torres@empresa.com', fechaLimite:'2025-06-30', estado:'en_progreso', prioridad:'alta', creado:'2024-12-01' },
      { id:'p2', terceroId:'t1', terceroNombre:'Accenture Spain', titulo:'Revisión RGPD contractual', descripcion:'Actualizar cláusulas de protección de datos en contrato', responsable:'maria.perez@empresa.com', fechaLimite:'2025-04-30', estado:'pendiente', prioridad:'media', creado:'2024-11-15' },
    ]
  }
};

// ══════════════════════════════════════════════════════════════
//  UTILS
// ══════════════════════════════════════════════════════════════
const notify = (msg, type='success') => {
  const n = document.createElement('div');
  n.className = `notification notification-${type}`;
  n.textContent = msg;
  document.getElementById('notifications').appendChild(n);
  setTimeout(() => n.remove(), 3500);
};

const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const fmtDate = d => d ? new Date(d).toLocaleDateString('es-ES') : '—';
const daysUntil = d => d ? Math.ceil((new Date(d) - new Date()) / 86400000) : null;

const riskBadge = r => ({
  'sin valorar': '<span class="badge risk-tag-sin">Sin valorar</span>',
  'en proceso':  '<span class="badge risk-tag-proceso">En proceso</span>',
  'alto':        '<span class="badge badge-red">Alto</span>',
  'medio':       '<span class="badge badge-amber">Medio</span>',
  'bajo':        '<span class="badge badge-green">Bajo</span>',
}[r] || '<span class="badge badge-gray">—</span>');

const SVG = {
  plus:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>',
  x:     '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  check: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  drag:  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="1" fill="currentColor"/><circle cx="15" cy="7" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="17" r="1" fill="currentColor"/><circle cx="15" cy="17" r="1" fill="currentColor"/></svg>',
  play:  '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/></svg>',
  check: '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
};

function closeModal() { document.querySelector('.modal-backdrop')?.remove(); }
function openModal(html) {
  closeModal();
  const bd = document.createElement('div');
  bd.className = 'modal-backdrop';
  bd.innerHTML = html;
  bd.addEventListener('click', e => { if (e.target === bd) closeModal(); });
  document.getElementById('modals').appendChild(bd);
}

async function saveItem(col, item) {
  state.data[col] = state.data[col] || [];
  const idx = state.data[col].findIndex(x => x.id === item.id);
  if (idx >= 0) state.data[col][idx] = item; else state.data[col].push(item);
  if (FS.enabled) FS.set(col, item.id, item).catch(e => console.warn('FS save:', e));
}
async function deleteItem(col, id) {
  state.data[col] = state.data[col].filter(x => x.id !== id);
  if (FS.enabled) FS.delete(col, id).catch(e => console.warn('FS delete:', e));
}

// ══════════════════════════════════════════════════════════════
//  CHIP SELECTOR — pure data-attribute approach, no classList bug
// ══════════════════════════════════════════════════════════════
// chipGroup(containerId, items, selectedValues, onChange)
// items = [{value, label, color?}]
// onChange(newSelectedArray)
function renderChipGroup(items, selected, name) {
  return items.map(item => {
    const isSel = selected.includes(item.value) ? '1' : '0';
    const dot = item.color ? `<span class="chip-dot" style="background:${item.color}"></span>` : '';
    return `<span class="chip" data-sel="${isSel}" data-value="${item.value}" data-group="${name}" onclick="toggleChip(this)">${dot}${item.label}</span>`;
  }).join('');
}

function toggleChip(el) {
  el.dataset.sel = el.dataset.sel === '1' ? '0' : '1';
}

function getChipValues(groupName) {
  return [...document.querySelectorAll(`.chip[data-group="${groupName}"][data-sel="1"]`)].map(el => el.dataset.value);
}

// ══════════════════════════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════════════════════════
const pageTitles = { dashboard:'Dashboard', terceros:'Maestro de Terceros', homologaciones:'Homologaciones', planes:'Planes de Acción', usuarios:'Usuarios y Roles', ambitos:'Ámbitos de Riesgo', tipos:'Tipos de Tercero', cuestionarios:'Cuestionarios', plazos:'Plazos de Renovación' };

function navigate(page) {
  state.currentPage = page;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.page === page));
  document.getElementById('topbar-title').textContent = pageTitles[page] || page;
  ({ dashboard:renderDashboard, terceros:renderTerceros, homologaciones:renderHomologaciones, planes:renderPlanes, usuarios:renderUsuarios, ambitos:renderAmbitos, tipos:renderTipos, cuestionarios:renderCuestionarios, plazos:renderPlazos })[page]?.();
}

// ══════════════════════════════════════════════════════════════
//  FIRESTORE REST API — hardcoded, auto-init, zero dependencies
// ══════════════════════════════════════════════════════════════
const FS = {
  projectId: 'tprm-f4525',
  apiKey:    'AIzaSyDDSXh3FsO6TfrAtx1WhSiIRCSDZHHSZmA',
  enabled:   false,

  _url(col, id) {
    const base = `https://firestore.googleapis.com/v1/projects/${this.projectId}/databases/(default)/documents/${col}`;
    return id ? `${base}/${id}?key=${this.apiKey}` : `${base}?key=${this.apiKey}&pageSize=500`;
  },

  // JS → Firestore value
  _toVal(v) {
    if (v === null || v === undefined) return { nullValue: null };
    if (typeof v === 'boolean')  return { booleanValue: v };
    if (typeof v === 'number')   return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
    if (typeof v === 'string')   return { stringValue: v };
    if (Array.isArray(v))        return { arrayValue: { values: v.map(x => this._toVal(x)) } };
    if (typeof v === 'object')   return { mapValue: { fields: this._toFields(v) } };
    return { stringValue: String(v) };
  },
  _toFields(obj) {
    const f = {};
    for (const [k, v] of Object.entries(obj)) f[k] = this._toVal(v);
    return f;
  },

  // Firestore value → JS
  _fromVal(v) {
    if ('nullValue'    in v) return null;
    if ('booleanValue' in v) return v.booleanValue;
    if ('integerValue' in v) return Number(v.integerValue);
    if ('doubleValue'  in v) return v.doubleValue;
    if ('stringValue'  in v) return v.stringValue;
    if ('arrayValue'   in v) return (v.arrayValue.values || []).map(x => this._fromVal(x));
    if ('mapValue'     in v) return this._fromFields(v.mapValue.fields || {});
    return null;
  },
  _fromFields(fields) {
    const obj = {};
    for (const [k, v] of Object.entries(fields)) obj[k] = this._fromVal(v);
    return obj;
  },

  async set(col, id, obj) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fields: this._toFields(obj) })
    });
    if (!r.ok) console.warn('FS set error', col, id, r.status);
  },

  async delete(col, id) {
    if (!this.enabled) return;
    const r = await fetch(this._url(col, id), { method: 'DELETE' });
    if (!r.ok) console.warn('FS delete error', col, id, r.status);
  },

  async list(col) {
    const r = await fetch(this._url(col));
    if (!r.ok) throw new Error(`FS list ${col}: ${r.status}`);
    const json = await r.json();
    return (json.documents || []).map(doc => {
      const obj = this._fromFields(doc.fields || {});
      if (!obj.id) obj.id = doc.name.split('/').pop();
      return obj;
    });
  },

  async init() {
    try {
      // Test with a lightweight request
      const r = await fetch(this._url('terceros') + '&pageSize=1');
      if (!r.ok) throw new Error(r.status);
      this.enabled = true;
      // Sync all collections — only replace if Firestore has data
      const cols = ['terceros','usuarios','ambitos','tipos','cuestionarios','planes'];
      for (const col of cols) {
        try {
          const docs = await this.list(col);
          if (docs.length > 0) state.data[col] = docs;
        } catch(e) { console.warn('Sync', col, e); }
      }
      console.log('✅ Firestore connected & synced');
    } catch(e) {
      console.warn('Firestore unavailable, running local:', e.message);
    }
  }
};

// ══════════════════════════════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════════════════════════════
function renderDashboard() {
  const t = state.data.terceros;
  const total = t.length;
  const altos = t.filter(x => x.riesgo==='alto').length;
  const medios = t.filter(x => x.riesgo==='medio').length;
  const bajos = t.filter(x => x.riesgo==='bajo').length;
  const sinVal = t.filter(x => x.riesgo==='sin valorar' || x.riesgo==='en proceso').length;
  const planes = state.data.planes || [];
  const planesActivos = planes.filter(p => p.estado!=='completado').length;
  const upcoming = t.filter(x => { const d=daysUntil(x.fechaSiguiente); return d!==null && d<=90 && d>0; }).sort((a,b)=>new Date(a.fechaSiguiente)-new Date(b.fechaSiguiente));
  const ambitoCounts = {};
  t.forEach(ter => (ter.ambitos||[]).forEach(a => { ambitoCounts[a]=(ambitoCounts[a]||0)+1; }));

  document.getElementById('content').innerHTML = `
    <div class="stats-grid">
      ${[['Total Terceros',total,'var(--accent)','en maestro'],['Riesgo Alto',altos,'var(--red)',`${total?Math.round(altos/total*100):0}% del total`],['Riesgo Medio',medios,'var(--amber)',`${total?Math.round(medios/total*100):0}% del total`],['Riesgo Bajo',bajos,'var(--green)',`${total?Math.round(bajos/total*100):0}% del total`],['Sin Valorar',sinVal,'var(--text3)','pendientes'],['Planes Activos',planesActivos,'var(--purple)','de remediación']].map(([l,v,c,s])=>`
        <div class="stat-card">
          <div class="stat-label">${l}</div>
          <div class="stat-value" style="color:${c}">${v}</div>
          <div class="stat-sub">${s}</div>
        </div>
      `).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div class="card">
        <div class="card-title">Distribución por Nivel de Riesgo</div>
        <div class="chart-bar">
          ${[['Alto',altos,'#ef4444'],['Medio',medios,'#f59e0b'],['Bajo',bajos,'#10b981'],['Sin Valorar',sinVal,'#5a6278']].map(([l,v,c])=>`
            <div class="chart-bar-row">
              <div class="chart-bar-label">${l}</div>
              <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${total?v/total*100:0}%;background:${c}">${v>0?v:''}</div></div>
              <div class="chart-bar-val">${v}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-title">Distribución por Ámbito</div>
        <div class="chart-bar">
          ${Object.entries(ambitoCounts).slice(0,7).map(([amb,cnt])=>{
            const a = state.data.ambitos.find(x=>x.nombre===amb);
            return `<div class="chart-bar-row">
              <div class="chart-bar-label">${amb}</div>
              <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${total?cnt/total*100:0}%;background:${a?.color||'#3b82f6'}">${cnt>0?cnt:''}</div></div>
              <div class="chart-bar-val">${cnt}</div>
            </div>`;
          }).join('') || '<p style="color:var(--text3);font-size:12px">Sin datos</p>'}
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="card">
        <div class="card-title">Próximas Homologaciones <span class="badge badge-amber" style="margin-left:6px">${upcoming.length}</span></div>
        ${upcoming.length ? `<table>
          <thead><tr><th>Tercero</th><th>Fecha</th><th>Días</th><th>Riesgo</th></tr></thead>
          <tbody>${upcoming.slice(0,5).map(ter=>{
            const d=daysUntil(ter.fechaSiguiente);
            return `<tr>
              <td style="color:var(--text);font-weight:500">${ter.nombre}</td>
              <td>${fmtDate(ter.fechaSiguiente)}</td>
              <td><span class="badge ${d<=30?'badge-red':'badge-amber'}">${d}d</span></td>
              <td>${riskBadge(ter.riesgo)}</td>
            </tr>`;
          }).join('')}</tbody>
        </table>` : '<p style="color:var(--text3);font-size:12px">Sin homologaciones próximas en 90 días.</p>'}
      </div>
      <div class="card">
        <div class="card-title">Planes de Acción Activos</div>
        ${planes.filter(p=>p.estado!=='completado').slice(0,4).map(p=>{
          const d=daysUntil(p.fechaLimite);
          return `<div class="action-plan-card" style="padding:12px;margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;gap:12px;">
              <div><div style="font-size:13px;font-weight:500;color:var(--text)">${p.titulo}</div><div style="font-size:11px;color:var(--text3);margin-top:3px">${p.terceroNombre}</div></div>
              <span class="badge ${p.prioridad==='alta'?'badge-red':p.prioridad==='media'?'badge-amber':'badge-green'}">${p.prioridad}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text3)">
              <span>👤 ${p.responsable}</span>
              ${d!==null?`<span style="color:${d<0?'var(--red)':d<=14?'var(--amber)':'var(--text3)'}">📅 ${d<0?'Vencido':d===0?'Hoy':d+'d'}</span>`:''}
            </div>
          </div>`;
        }).join('') || '<p style="color:var(--text3);font-size:12px">Sin planes activos.</p>'}
      </div>
    </div>
  `;
}

// ══════════════════════════════════════════════════════════════
//  TERCEROS
// ══════════════════════════════════════════════════════════════
let terFilter = { search:'', riesgo:'', ambito:'', pais:'' };

function renderTerceros() {
  const terceros = state.data.terceros.filter(t => {
    const s = terFilter.search.toLowerCase();
    if (s && !t.nombre.toLowerCase().includes(s) && !(t.cif||'').toLowerCase().includes(s)) return false;
    if (terFilter.riesgo && t.riesgo !== terFilter.riesgo) return false;
    if (terFilter.ambito && !(t.ambitos||[]).includes(terFilter.ambito)) return false;
    if (terFilter.pais && t.pais !== terFilter.pais) return false;
    return true;
  });
  const paises = [...new Set(state.data.terceros.map(t=>t.pais).filter(Boolean))];

  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Maestro de Terceros</div><div class="section-sub">${terceros.length} de ${state.data.terceros.length} terceros</div></div>
      <button class="btn btn-primary" onclick="showTerceroModal(null)">${SVG.plus} Dar de Alta Tercero</button>
    </div>
    <div class="toolbar">
      <div class="search-bar" style="flex:1;max-width:300px;">${SVG.search}<input placeholder="Nombre o CIF..." oninput="terFilter.search=this.value;renderTerceros()" value="${terFilter.search}"></div>
      <select class="form-select" style="width:auto" onchange="terFilter.riesgo=this.value;renderTerceros()">
        <option value="">Todos los riesgos</option>
        ${['sin valorar','en proceso','alto','medio','bajo'].map(r=>`<option value="${r}" ${terFilter.riesgo===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.ambito=this.value;renderTerceros()">
        <option value="">Todos los ámbitos</option>
        ${state.data.ambitos.map(a=>`<option value="${a.nombre}" ${terFilter.ambito===a.nombre?'selected':''}>${a.nombre}</option>`).join('')}
      </select>
      <select class="form-select" style="width:auto" onchange="terFilter.pais=this.value;renderTerceros()">
        <option value="">Todos los países</option>
        ${paises.map(p=>`<option value="${p}" ${terFilter.pais===p?'selected':''}>${p}</option>`).join('')}
      </select>
    </div>
    <div class="card" style="padding:0;">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nombre</th><th>CIF</th><th>País</th><th>Tipo</th><th>Ámbitos</th><th>Responsable</th><th>Sig. Homologación</th><th>Riesgo</th><th>Estado Hom.</th><th>Acciones</th></tr></thead>
          <tbody>
            ${terceros.length ? terceros.map(t => {
              const d = daysUntil(t.fechaSiguiente);
              const urgent = d !== null && d <= 30 && d > 0;
              return `<tr>
                <td><div style="color:var(--text);font-weight:500">${t.nombre}</div><div style="font-size:11px;color:var(--text3)">${t.denominacion||''}</div></td>
                <td><code style="font-size:11px">${t.cif||'—'}</code></td>
                <td>${t.pais||'—'}</td>
                <td><span class="badge badge-blue">${t.tipo||'—'}</span></td>
                <td><div style="display:flex;flex-wrap:wrap;gap:3px">${(t.ambitos||[]).slice(0,3).map(a=>{
                  const am=state.data.ambitos.find(x=>x.nombre===a);
                  return `<span class="badge" style="background:${(am?.color||'#888')+'22'};color:${am?.color||'#888'}">${a}</span>`;
                }).join('')}${(t.ambitos||[]).length>3?`<span class="badge badge-gray">+${t.ambitos.length-3}</span>`:''}</div></td>
                <td style="color:var(--text)">${t.responsable||'—'}</td>
                <td><span ${urgent?'style="color:var(--amber)"':''}>${fmtDate(t.fechaSiguiente)}</span>${urgent?`<span class="badge badge-amber" style="margin-left:4px">${d}d</span>`:''}</td>
                <td>${riskBadge(t.riesgo)}</td>
                <td>${homBadge(getActiveHom(t.id)?.fase || getLastHom(t.id)?.fase || 'pendiente')}</td>
                <td>
                  <div style="display:flex;gap:4px;">
                    <button class="btn btn-success btn-sm" onclick="iniciarHom('${t.id}')" title="${getActiveHom(t.id)?'Continuar homologación':'Iniciar homologación'}">${SVG.play} ${getActiveHom(t.id)?'Continuar':'Homologar'}</button>
                    <button class="btn btn-ghost btn-icon btn-sm" title="Editar" onclick="showTerceroModal('${t.id}')">${SVG.edit}</button>
                    <button class="btn btn-danger btn-icon btn-sm" title="Eliminar" onclick="deleteTercero('${t.id}')">${SVG.trash}</button>
                  </div>
                </td>
              </tr>`;
            }).join('') : `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text3)">Sin resultados</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

async function deleteTercero(id) {
  if (!confirm('¿Eliminar este tercero?')) return;
  await deleteItem('terceros', id);
  notify('Tercero eliminado');
  renderTerceros();
}

// ── TERCERO MODAL ────────────────────────────────────────────
function showTerceroModal(id) {
  const t = id ? state.data.terceros.find(x=>x.id===id) : null;
  const isNew = !t;

  openModal(`
    <div class="modal modal-xl">
      <div class="modal-header">
        <div class="modal-title">${isNew ? 'Dar de Alta Tercero' : 'Editar Tercero: ' + t.nombre}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="tabs" id="t-tabs">
          <div class="tab active" onclick="switchTab('datos')">Datos Generales</div>
          <div class="tab" onclick="switchTab('riesgo')">Riesgo & Comentarios</div>
          <div class="tab" onclick="switchTab('remediacion')">Plan de Remediación</div>
          ${!isNew ? `<div class="tab" onclick="switchTab('fechas')">Homologación</div>` : ''}
        </div>

        <!-- TAB: DATOS -->
        <div id="ttab-datos">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="t-nombre" value="${t?.nombre||''}" placeholder="Nombre comercial"></div>
            <div class="form-group"><label class="form-label">Denominación Social *</label><input class="form-input" id="t-denominacion" value="${t?.denominacion||''}" placeholder="Razón social"></div>
            <div class="form-group"><label class="form-label">Grupo Empresarial</label><input class="form-input" id="t-grupo" value="${t?.grupo||''}" placeholder="Grupo al que pertenece"></div>
            <div class="form-group"><label class="form-label">CIF / NIF</label><input class="form-input" id="t-cif" value="${t?.cif||''}" placeholder="B12345678"></div>
            <div class="form-group"><label class="form-label">Domicilio Fiscal</label><input class="form-input" id="t-domicilio" value="${t?.domicilio||''}" placeholder="Dirección fiscal"></div>
            <div class="form-group"><label class="form-label">País</label><input class="form-input" id="t-pais" value="${t?.pais||''}" placeholder="España" list="countries-list"><datalist id="countries-list">${COUNTRIES.map(c=>`<option value="${c}">`).join('')}</datalist></div>
            <div class="form-group"><label class="form-label">Nombre Representante</label><input class="form-input" id="t-representante" value="${t?.representante||''}" placeholder="Nombre y apellidos"></div>
            <div class="form-group"><label class="form-label">Responsable en la Compañía</label>
              <select class="form-select" id="t-responsable">
                <option value="">Seleccionar...</option>
                ${state.data.usuarios.map(u=>`<option value="${u.nombre}" ${t?.responsable===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de Tercero</label>
            <select class="form-select" id="t-tipo" style="max-width:300px">
              <option value="">Seleccionar...</option>
              ${['Proveedor Directo','Proveedor Indirecto','Cliente'].map(tp=>`<option value="${tp}" ${t?.tipo===tp?'selected':''}>${tp}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ámbitos de Riesgo Aplicables</label>
            <div class="chip-group">
              ${renderChipGroup(state.data.ambitos.map(a=>({value:a.nombre,label:a.nombre,color:a.color})), t?.ambitos||[], 'ter-ambitos')}
            </div>
          </div>
          ${isNew ? `
            <div class="info-box" style="margin-top:12px">
              ℹ️ Las fechas de homologación se registrarán una vez se complete el cuestionario de evaluación del tercero.
            </div>
          ` : ''}
        </div>

        <!-- TAB: RIESGO -->
        <div id="ttab-riesgo" style="display:none">
          <div class="form-group">
            <label class="form-label">Nivel de Riesgo</label>
            <select class="form-select" id="t-riesgo" style="max-width:280px">
              <option value="sin valorar" ${(t?.riesgo||'sin valorar')==='sin valorar'?'selected':''}>Sin valorar</option>
              <option value="en proceso" ${t?.riesgo==='en proceso'?'selected':''}>En proceso</option>
              <option value="alto" ${t?.riesgo==='alto'?'selected':''}>Alto</option>
              <option value="medio" ${t?.riesgo==='medio'?'selected':''}>Medio</option>
              <option value="bajo" ${t?.riesgo==='bajo'?'selected':''}>Bajo</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Comentarios</label>
            <textarea class="form-textarea" id="t-comentarios" rows="6" placeholder="Notas, observaciones, contexto...">${t?.comentarios||''}</textarea>
          </div>
        </div>

        <!-- TAB: REMEDIACION -->
        <div id="ttab-remediacion" style="display:none">
          <div class="form-group">
            <label class="form-label">Plan de Remediación</label>
            <textarea class="form-textarea" id="t-remediacion" rows="6" placeholder="Describe las acciones de remediación necesarias...">${t?.remediacion||''}</textarea>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Asignado a</label>
              <select class="form-select" id="t-remediacionUser">
                <option value="">Sin asignar</option>
                ${state.data.usuarios.map(u=>`<option value="${u.email}" ${t?.remediacionUser===u.email?'selected':''}>${u.nombre}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha Límite</label>
              <input class="form-input" id="t-remediacionFecha" type="date" value="${t?.remediacionFecha||''}">
            </div>
          </div>
        </div>

        <!-- TAB: FECHAS (solo edición) -->
        ${!isNew ? `
          <div id="ttab-fechas" style="display:none">
            <div class="warn-box" style="margin-bottom:16px">
              ⚠️ Las fechas de homologación deben actualizarse únicamente tras completar el proceso de evaluación mediante cuestionario.
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Fecha Primera Homologación</label>
                <input class="form-input" id="t-fechaPrimera" type="date" value="${t?.fechaPrimera||''}">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Última Homologación</label>
                <input class="form-input" id="t-fechaUltima" type="date" value="${t?.fechaUltima||''}">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Siguiente Homologación</label>
                <input class="form-input" id="t-fechaSiguiente" type="date" value="${t?.fechaSiguiente||''}">
              </div>
            </div>
          </div>
        ` : ''}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveTercero('${id||''}')">${SVG.check} ${isNew ? 'Dar de Alta' : 'Guardar Cambios'}</button>
      </div>
    </div>
  `);
}

function switchTab(name) {
  ['datos','riesgo','remediacion','fechas'].forEach(t => {
    const el = document.getElementById('ttab-'+t); if (el) el.style.display = t===name?'block':'none';
  });
  document.querySelectorAll('#t-tabs .tab').forEach((el,i) => {
    const names = ['datos','riesgo','remediacion','fechas'];
    el.classList.toggle('active', names[i]===name);
  });
}

async function saveTercero(id) {
  const nombre = document.getElementById('t-nombre')?.value?.trim();
  if (!nombre) { notify('El nombre es obligatorio', 'error'); return; }

  const ambitos = getChipValues('ter-ambitos');

  const existing = id ? state.data.terceros.find(x=>x.id===id) : null;
  const item = {
    id: id || genId(),
    nombre,
    denominacion: document.getElementById('t-denominacion')?.value||'',
    grupo:        document.getElementById('t-grupo')?.value||'',
    cif:          document.getElementById('t-cif')?.value||'',
    domicilio:    document.getElementById('t-domicilio')?.value||'',
    pais:         document.getElementById('t-pais')?.value||'',
    representante:document.getElementById('t-representante')?.value||'',
    responsable:  document.getElementById('t-responsable')?.value||'',
    tipo:         document.getElementById('t-tipo')?.value||'',
    ambitos,
    // Fechas: solo en edición (tab fechas); en creación se quedan vacías
    fechaPrimera:  document.getElementById('t-fechaPrimera')?.value  || existing?.fechaPrimera  || '',
    fechaUltima:   document.getElementById('t-fechaUltima')?.value   || existing?.fechaUltima   || '',
    fechaSiguiente:document.getElementById('t-fechaSiguiente')?.value|| existing?.fechaSiguiente|| '',
    riesgo:        document.getElementById('t-riesgo')?.value || existing?.riesgo || 'sin valorar',
    comentarios:   document.getElementById('t-comentarios')?.value||'',
    remediacion:   document.getElementById('t-remediacion')?.value||'',
    remediacionUser:document.getElementById('t-remediacionUser')?.value||'',
    remediacionFecha:document.getElementById('t-remediacionFecha')?.value||'',
    activo: true,
  };
  await saveItem('terceros', item);
  notify(id ? 'Tercero actualizado correctamente' : 'Tercero dado de alta correctamente');
  closeModal();
  renderTerceros();
}

// ══════════════════════════════════════════════════════════════
//  PLANES DE ACCIÓN
// ══════════════════════════════════════════════════════════════
function renderPlanes() {
  const planes = state.data.planes || [];
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Planes de Acción</div><div class="section-sub">${planes.length} planes registrados</div></div>
      <button class="btn btn-primary" onclick="showPlanModal(null)">${SVG.plus} Nuevo Plan</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
      ${[['pendiente','Pendiente','var(--amber)'],['en_progreso','En Progreso','var(--accent)'],['completado','Completado','var(--green)']].map(([s,l,c])=>`
        <div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="color:${c}">${planes.filter(p=>p.estado===s).length}</div></div>
      `).join('')}
    </div>
    ${['pendiente','en_progreso','completado'].map(estado => {
      const group = planes.filter(p=>p.estado===estado);
      if (!group.length) return '';
      const labels = {pendiente:'Pendiente',en_progreso:'En Progreso',completado:'Completado'};
      const colors = {pendiente:'var(--amber)',en_progreso:'var(--accent)',completado:'var(--green)'};
      return `<div style="margin-bottom:24px;">
        <div style="font-size:11px;font-weight:700;color:${colors[estado]};text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">${labels[estado]} · ${group.length}</div>
        ${group.map(p => {
          const d = daysUntil(p.fechaLimite);
          return `<div class="action-plan-card">
            <div style="display:flex;justify-content:space-between;gap:16px">
              <div style="flex:1">
                <div style="color:var(--text);font-weight:500;margin-bottom:3px">${p.titulo}</div>
                <div style="font-size:12px;color:var(--text3)">${p.terceroNombre}</div>
                ${p.descripcion?`<div style="font-size:12px;color:var(--text2);margin-top:6px">${p.descripcion}</div>`:''}
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
                <span class="badge ${p.prioridad==='alta'?'badge-red':p.prioridad==='media'?'badge-amber':'badge-green'}">${p.prioridad}</span>
                ${d!==null?`<span style="font-size:11px;color:${d<0?'var(--red)':d<=7?'var(--amber)':'var(--text3)'}">📅 ${d<0?'Vencido '+Math.abs(d)+'d':d===0?'Hoy':d+' días'}</span>`:''}
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
              <span style="font-size:12px;color:var(--text3)">👤 ${p.responsable||'Sin asignar'}</span>
              <div style="display:flex;gap:6px">
                <button class="btn btn-secondary btn-sm" onclick="showPlanModal('${p.id}')">${SVG.edit} Editar</button>
                ${estado!=='completado'?`<button class="btn btn-ghost btn-sm" onclick="completePlan('${p.id}')">${SVG.check} Completar</button>`:''}
                <button class="btn btn-danger btn-icon btn-sm" onclick="deletePlan('${p.id}')">${SVG.trash}</button>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }).join('')}
    ${!planes.length?`<div class="empty-state"><p>No hay planes de acción registrados.</p></div>`:''}
  `;
}

async function completePlan(id) {
  const p = state.data.planes.find(x=>x.id===id); if(!p) return;
  p.estado = 'completado'; await saveItem('planes', p); notify('Plan completado'); renderPlanes();
}
async function deletePlan(id) {
  if (!confirm('¿Eliminar este plan?')) return;
  await deleteItem('planes', id); notify('Plan eliminado'); renderPlanes();
}

function showPlanModal(id) {
  const p = id ? state.data.planes.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">${p?'Editar Plan':'Nuevo Plan de Acción'}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Tercero</label>
          <select class="form-select" id="p-tercero">
            <option value="">Seleccionar...</option>
            ${state.data.terceros.map(t=>`<option value="${t.id}" data-nombre="${t.nombre}" ${p?.terceroId===t.id?'selected':''}>${t.nombre}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">Título *</label><input class="form-input" id="p-titulo" value="${p?.titulo||''}" placeholder="Título del plan"></div>
        <div class="form-group"><label class="form-label">Descripción</label><textarea class="form-textarea" id="p-descripcion">${p?.descripcion||''}</textarea></div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Responsable</label>
            <select class="form-select" id="p-responsable">
              <option value="">Sin asignar</option>
              ${state.data.usuarios.map(u=>`<option value="${u.email}" ${p?.responsable===u.email?'selected':''}>${u.nombre}</option>`).join('')}
            </select>
          </div>
          <div class="form-group"><label class="form-label">Fecha Límite</label><input class="form-input" id="p-fechaLimite" type="date" value="${p?.fechaLimite||''}"></div>
          <div class="form-group"><label class="form-label">Prioridad</label>
            <select class="form-select" id="p-prioridad">
              <option value="alta" ${(p?.prioridad||'alta')==='alta'?'selected':''}>Alta</option>
              <option value="media" ${p?.prioridad==='media'?'selected':''}>Media</option>
              <option value="baja" ${p?.prioridad==='baja'?'selected':''}>Baja</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Estado</label>
            <select class="form-select" id="p-estado">
              <option value="pendiente" ${(p?.estado||'pendiente')==='pendiente'?'selected':''}>Pendiente</option>
              <option value="en_progreso" ${p?.estado==='en_progreso'?'selected':''}>En Progreso</option>
              <option value="completado" ${p?.estado==='completado'?'selected':''}>Completado</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="savePlan('${id||''}')">${SVG.check} Guardar</button>
      </div>
    </div>
  `);
}

async function savePlan(id) {
  const titulo = document.getElementById('p-titulo').value.trim();
  if (!titulo) { notify('El título es obligatorio', 'error'); return; }
  const sel = document.getElementById('p-tercero');
  const item = {
    id: id||genId(), titulo,
    terceroId: sel.value,
    terceroNombre: sel.options[sel.selectedIndex]?.dataset.nombre||'',
    descripcion: document.getElementById('p-descripcion').value,
    responsable: document.getElementById('p-responsable').value,
    fechaLimite: document.getElementById('p-fechaLimite').value,
    prioridad:   document.getElementById('p-prioridad').value,
    estado:      document.getElementById('p-estado').value,
    creado: id?(state.data.planes.find(p=>p.id===id)?.creado||new Date().toISOString().split('T')[0]):new Date().toISOString().split('T')[0],
  };
  await saveItem('planes', item);
  notify(id?'Plan actualizado':'Plan creado');
  closeModal(); renderPlanes();
}

// ══════════════════════════════════════════════════════════════
//  USUARIOS
// ══════════════════════════════════════════════════════════════
const ROL_COLORS = { admin:'badge-red', usuario:'badge-blue', aprobador:'badge-amber', supervisor:'badge-purple' };
const ROLES_LIST = ['admin','usuario','aprobador','supervisor'];

function renderUsuarios() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Usuarios y Roles</div><div class="section-sub">${state.data.usuarios.length} usuarios</div></div>
      <button class="btn btn-primary" onclick="showUsuarioModal(null)">${SVG.plus} Nuevo Usuario</button>
    </div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table>
        <thead><tr><th>Nombre</th><th>Email</th><th>Roles</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody>
          ${state.data.usuarios.map(u=>`<tr>
            <td><div style="display:flex;align-items:center;gap:10px">
              <div class="user-avatar" style="width:32px;height:32px;font-size:12px">${u.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div>
              <span style="color:var(--text);font-weight:500">${u.nombre}</span>
            </div></td>
            <td>${u.email}</td>
            <td><div style="display:flex;gap:4px;flex-wrap:wrap">${(u.roles||[]).map(r=>`<span class="badge ${ROL_COLORS[r]||'badge-gray'}">${r.charAt(0).toUpperCase()+r.slice(1)}</span>`).join('')}</div></td>
            <td><span class="badge ${u.activo?'badge-green':'badge-gray'}">${u.activo?'Activo':'Inactivo'}</span></td>
            <td><div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showUsuarioModal('${u.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteUsuario('${u.id}')">${SVG.trash}</button>
            </div></td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-title">Descripción de Roles</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        ${[['Admin','admin','Acceso completo. Configura todos los módulos.'],['Usuario','usuario','Puede consultar terceros y rellenar cuestionarios.'],['Aprobador','aprobador','Valida resultados de cuestionarios y planes.'],['Supervisor','supervisor','Visibilidad global de todos los terceros y planes.']].map(([l,k,d])=>`
          <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border)">
            <span class="badge ${ROL_COLORS[k]}">${l}</span>
            <div style="font-size:12px;color:var(--text2);margin-top:8px">${d}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

async function deleteUsuario(id) {
  if (!confirm('¿Eliminar este usuario?')) return;
  await deleteItem('usuarios', id); notify('Usuario eliminado'); renderUsuarios();
}

function showUsuarioModal(id) {
  const u = id ? state.data.usuarios.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">${u?'Editar Usuario':'Nuevo Usuario'}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre completo *</label><input class="form-input" id="u-nombre" value="${u?.nombre||''}" placeholder="Nombre Apellidos"></div>
        <div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="u-email" type="email" value="${u?.email||''}" placeholder="usuario@empresa.com"></div>
        <div class="form-group">
          <label class="form-label">Roles (puede seleccionar varios)</label>
          <div class="chip-group">
            ${renderChipGroup(ROLES_LIST.map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1)})), u?.roles||[], 'usr-roles')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <div style="display:flex;align-items:center;gap:10px">
            <label class="toggle"><input type="checkbox" id="u-activo" ${u?.activo!==false?'checked':''}><span class="toggle-slider"></span></label>
            <span style="font-size:13px;color:var(--text2)">Usuario activo</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveUsuario('${id||''}')">${SVG.check} Guardar</button>
      </div>
    </div>
  `);
}

async function saveUsuario(id) {
  const nombre = document.getElementById('u-nombre').value.trim();
  const email  = document.getElementById('u-email').value.trim();
  if (!nombre||!email) { notify('Nombre y email son obligatorios', 'error'); return; }
  const roles = getChipValues('usr-roles');
  const item = { id:id||genId(), nombre, email, roles, activo:document.getElementById('u-activo').checked };
  await saveItem('usuarios', item);
  notify(id?'Usuario actualizado':'Usuario creado');
  closeModal(); renderUsuarios();
}

// ══════════════════════════════════════════════════════════════
//  ÁMBITOS
// ══════════════════════════════════════════════════════════════
function renderAmbitos() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Ámbitos de Riesgo</div><div class="section-sub">${state.data.ambitos.length} ámbitos</div></div>
      <button class="btn btn-primary" onclick="showAmbitoModal(null)">${SVG.plus} Nuevo Ámbito</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">
      ${state.data.ambitos.map(a => {
        const cuests = state.data.cuestionarios.filter(c=>c.ambito_id===a.id);
        const tercs  = state.data.terceros.filter(t=>(t.ambitos||[]).includes(a.nombre));
        return `<div class="card" style="border-left:3px solid ${a.color}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
            <div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${a.color}">${a.nombre}</div><div style="font-size:12px;color:var(--text3);margin-top:4px">${a.descripcion||''}</div></div>
            <div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showAmbitoModal('${a.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteAmbito('${a.id}')">${SVG.trash}</button>
            </div>
          </div>
          <div style="border-top:1px solid var(--border);padding-top:12px">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:8px"><span>👤 Responsable</span><span style="color:var(--text)">${a.responsable||'—'}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:8px"><span>📋 Cuestionarios</span><span class="badge" style="background:${a.color+'22'};color:${a.color}">${cuests.length}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2)"><span>🏢 Terceros</span><span class="badge badge-gray">${tercs.length}</span></div>
          </div>
          ${cuests.length?`<div style="margin-top:10px">${cuests.map(c=>`<span class="badge badge-blue" style="margin:2px">${c.nombre}</span>`).join('')}</div>`:''}
        </div>`;
      }).join('')}
    </div>
  `;
}

async function deleteAmbito(id) {
  if (!confirm('¿Eliminar este ámbito?')) return;
  await deleteItem('ambitos', id); notify('Ámbito eliminado'); renderAmbitos();
}
function showAmbitoModal(id) {
  const a = id ? state.data.ambitos.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header"><div class="modal-title">${a?'Editar Ámbito':'Nuevo Ámbito de Riesgo'}</div><button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" id="a-nombre" value="${a?.nombre||''}" placeholder="Ej: Cyber, ESG..."></div>
        <div class="form-group"><label class="form-label">Descripción</label><input class="form-input" id="a-desc" value="${a?.descripcion||''}" placeholder="Breve descripción"></div>
        <div class="form-group"><label class="form-label">Responsable</label>
          <select class="form-select" id="a-resp"><option value="">Sin responsable</option>
            ${state.data.usuarios.map(u=>`<option value="${u.nombre}" ${a?.responsable===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
          </select>
        </div>
        <div class="form-group"><label class="form-label">Color identificativo</label>
          <div style="display:flex;align-items:center;gap:12px"><input type="color" id="a-color" value="${a?.color||'#3b82f6'}" style="width:48px;height:36px;border:none;background:none;cursor:pointer;border-radius:4px"><span style="font-size:12px;color:var(--text2)">Usado para identificar el ámbito visualmente</span></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveAmbito('${id||''}')">${SVG.check} Guardar</button></div>
    </div>
  `);
}
async function saveAmbito(id) {
  const nombre = document.getElementById('a-nombre').value.trim();
  if (!nombre) { notify('Nombre obligatorio', 'error'); return; }
  const item = { id:id||genId(), nombre, descripcion:document.getElementById('a-desc').value, responsable:document.getElementById('a-resp').value, color:document.getElementById('a-color').value, cuestionarios:id?(state.data.ambitos.find(a=>a.id===id)?.cuestionarios||[]):[] };
  await saveItem('ambitos', item); notify(id?'Ámbito actualizado':'Ámbito creado'); closeModal(); renderAmbitos();
}

// ══════════════════════════════════════════════════════════════
//  TIPOS DE TERCERO
// ══════════════════════════════════════════════════════════════
function renderTipos() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Tipos de Tercero</div><div class="section-sub">Jerarquía de hasta 3 niveles</div></div>
      <button class="btn btn-primary" onclick="showTipoModal(null)">${SVG.plus} Nuevo Tipo</button>
    </div>
    <div class="card" style="padding:0"><div class="table-wrap"><table>
      <thead><tr><th>Nivel 1</th><th>Nivel 2</th><th>Nivel 3</th><th>Terceros Asociados</th><th>Acciones</th></tr></thead>
      <tbody>
        ${state.data.tipos.map(t => {
          const tercs = state.data.terceros.filter(x=>(t.terceros||[]).includes(x.id));
          return `<tr>
            <td style="color:var(--text);font-weight:500">${t.nivel1||'—'}</td>
            <td>${t.nivel2||'—'}</td><td>${t.nivel3||'—'}</td>
            <td><div style="display:flex;flex-wrap:wrap;gap:4px">
              ${tercs.slice(0,3).map(x=>`<span class="badge badge-gray">${x.nombre}</span>`).join('')}
              ${tercs.length>3?`<span class="badge badge-gray">+${tercs.length-3}</span>`:''}
              ${!tercs.length?'<span style="color:var(--text3);font-size:12px">Sin terceros</span>':''}
            </div></td>
            <td><div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon btn-sm" onclick="showTipoModal('${t.id}')">${SVG.edit}</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTipo('${t.id}')">${SVG.trash}</button>
            </div></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div></div>
  `;
}
async function deleteTipo(id) {
  if (!confirm('¿Eliminar este tipo?')) return;
  await deleteItem('tipos', id); notify('Tipo eliminado'); renderTipos();
}
function showTipoModal(id) {
  const t = id ? state.data.tipos.find(x=>x.id===id) : null;
  openModal(`
    <div class="modal">
      <div class="modal-header"><div class="modal-title">${t?'Editar Tipo':'Nuevo Tipo de Tercero'}</div><button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button></div>
      <div class="modal-body">
        <p style="font-size:12px;color:var(--text3);margin-bottom:16px">Solo el Nivel 1 es obligatorio.</p>
        <div class="form-group"><label class="form-label">Nivel 1 *</label><input class="form-input" id="tp-n1" value="${t?.nivel1||''}" placeholder="Ej: Proveedor, Cliente..."></div>
        <div class="form-group"><label class="form-label">Nivel 2</label><input class="form-input" id="tp-n2" value="${t?.nivel2||''}" placeholder="Ej: Proveedor Directo..."></div>
        <div class="form-group"><label class="form-label">Nivel 3</label><input class="form-input" id="tp-n3" value="${t?.nivel3||''}" placeholder="Ej: Proveedor Crítico TI..."></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveTipo('${id||''}')">${SVG.check} Guardar</button></div>
    </div>
  `);
}
async function saveTipo(id) {
  const n1 = document.getElementById('tp-n1').value.trim();
  if (!n1) { notify('Nivel 1 obligatorio', 'error'); return; }
  const item = { id:id||genId(), nivel1:n1, nivel2:document.getElementById('tp-n2').value, nivel3:document.getElementById('tp-n3').value, terceros:id?(state.data.tipos.find(t=>t.id===id)?.terceros||[]):[] };
  await saveItem('tipos', item); notify(id?'Tipo actualizado':'Tipo creado'); closeModal(); renderTipos();
}

// ══════════════════════════════════════════════════════════════
//  CUESTIONARIOS — WIZARD (estado en objeto JS, no en DOM)
// ══════════════════════════════════════════════════════════════
let W = {}; // wizard state

function initWizard(id) {
  const c = id ? state.data.cuestionarios.find(x=>x.id===id) : null;
  W = {
    step: 1,
    id: id||null,
    nombre: c?.nombre||'',
    tipo: c?.tipo||'due_diligence',
    ambito_id: c?.ambito_id||'',
    ambito: c?.ambito||'',
    umbralMaterial: c?.umbralMaterial||2,
    aplicaTodos: c?.aplicaTodos !== false,
    paises: c?.paises ? [...c.paises] : [],
    ambitosAplicables: c?.ambitosAplicables ? [...c.ambitosAplicables] : [],
    nivelesRiesgo: c?.nivelesRiesgo ? [...c.nivelesRiesgo] : [],
    tiposProveedor: c?.tiposProveedor ? [...c.tiposProveedor] : [],
    preguntas: c?.preguntas ? JSON.parse(JSON.stringify(c.preguntas)) : [],
    nivelRiesgoBajo:  c?.nivelRiesgoBajo  || {min:0, max:3},
    nivelRiesgoMedio: c?.nivelRiesgoMedio || {min:4, max:6},
    nivelRiesgoAlto:  c?.nivelRiesgoAlto  || {min:7, max:99},
    bloqueoRedFlag: c?.bloqueoRedFlag !== false,
    aprobadores: c?.aprobadores ? {...c.aprobadores} : {alto:'',medio:'',bajo:''},
    creado: c?.creado || new Date().toISOString().split('T')[0],
  };
}

function renderCuestionarios() {
  document.getElementById('content').innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Cuestionarios</div><div class="section-sub">${state.data.cuestionarios.length} cuestionarios</div></div>
      <button class="btn btn-primary" onclick="openWizard(null)">${SVG.plus} Nuevo Cuestionario</button>
    </div>
    ${!state.data.cuestionarios.length ? `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>Sin cuestionarios. Crea el primero.</p></div>` : `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px">
        ${state.data.cuestionarios.map(c => {
          const amb = state.data.ambitos.find(a=>a.id===c.ambito_id);
          const tipoLabel = {general:'🌐 General',scope_check:'🔍 Scope Check',risk_scoring:'📊 Risk Scoring',due_diligence:'📋 Due Diligence'}[c.tipo]||c.tipo||'Due Diligence';
          const tipoBadge = {general:'background:rgba(6,182,212,.12);color:#06b6d4',scope_check:'background:rgba(139,92,246,.12);color:#8b5cf6',risk_scoring:'background:var(--amber-soft);color:var(--amber)',due_diligence:'background:var(--accent-glow);color:var(--accent)'}[c.tipo]||'background:var(--surface3);color:var(--text2)';
          const scOnly = (c.preguntas||[]).filter(p=>p.soloCompleta).length;
          return `<div class="card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
              <div style="flex:1">
                <span class="badge" style="${tipoBadge};margin-bottom:8px">${tipoLabel}</span>
                <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:6px;margin-top:6px">${c.nombre}</div>
                ${amb?`<span class="badge" style="background:${amb.color+'22'};color:${amb.color}">${amb.nombre}</span>`:''}
              </div>
              <div style="display:flex;gap:4px">
                <button class="btn btn-ghost btn-icon btn-sm" onclick="openWizard('${c.id}')">${SVG.edit}</button>
                <button class="btn btn-danger btn-icon btn-sm" onclick="deleteCuestionario('${c.id}')">${SVG.trash}</button>
              </div>
            </div>
            <div style="border-top:1px solid var(--border);padding-top:12px">
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px"><span>📝 Preguntas</span><span class="badge badge-blue">${(c.preguntas||[]).length}${scOnly?` (${scOnly} solo completa)`:''}</span></div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px"><span>🌍 Aplica a todos</span><span class="badge ${c.aplicaTodos?'badge-green':'badge-amber'}">${c.aplicaTodos?'Sí':'Filtros específicos'}</span></div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2)"><span>📅 Modificado</span><span>${fmtDate(c.modificado||c.creado)}</span></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    `}
  `;
}

async function deleteCuestionario(id) {
  if (!confirm('¿Eliminar este cuestionario?')) return;
  await deleteItem('cuestionarios', id); notify('Cuestionario eliminado'); renderCuestionarios();
}

function openWizard(id) {
  initWizard(id);
  renderWizardModal();
}

function renderWizardModal() {
  const STEPS = ['Información general','Preguntas','Niveles de riesgo','Aprobadores'];
  openModal(`
    <div class="modal modal-xl">
      <div class="modal-header">
        <div style="flex:1">
          <div class="modal-title">${W.id ? 'Editar Cuestionario' : 'Nuevo Cuestionario'}</div>
          <div class="wizard-steps" style="margin-top:10px">
            ${STEPS.map((s,i) => {
              const cls = i+1 === W.step ? 'active' : i+1 < W.step ? 'done' : '';
              return `<div class="wizard-step ${cls}"><div class="step-dot">${i+1 < W.step ? '✓' : i+1}</div>${s}</div>${i<STEPS.length-1?'<span class="step-sep">›</span>':''}`;
            }).join('')}
          </div>
        </div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
      </div>
      <div class="modal-body" id="wbody">${renderWStep()}</div>
      <div class="modal-footer">
        <div style="flex:1">
          ${W.step > 1 ? `<button class="btn btn-secondary" onclick="wNav(-1)">← Anterior</button>` : ''}
        </div>
        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        ${W.step < 4
          ? `<button class="btn btn-primary" onclick="wNav(1)">Siguiente →</button>`
          : `<button class="btn btn-primary" onclick="wSave()">${SVG.check} Guardar Cuestionario</button>`}
      </div>
    </div>
  `);
}

function renderWStep() {
  if (W.step === 1) {
    return `
      <div class="form-group">
        <label class="form-label">Nombre del Cuestionario *</label>
        <input class="form-input" id="wn" value="${W.nombre}" placeholder="Ej: Cuestionario Cyber Básico" oninput="W.nombre=this.value">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo de Cuestionario *</label>
        <select class="form-select" id="wt" onchange="W.tipo=this.value; document.getElementById('wa-row').style.display=this.value==='due_diligence'?'block':'none'; document.getElementById('umb-row').style.display=this.value==='scope_check'?'block':'none'">
          <option value="general" ${W.tipo==='general'?'selected':''}>🌐 General — Aplica siempre, primero en Due Diligence</option>
          <option value="scope_check" ${W.tipo==='scope_check'?'selected':''}>🔍 Scope Check — Determina si el tercero es material</option>
          <option value="risk_scoring" ${W.tipo==='risk_scoring'?'selected':''}>📊 Risk Scoring — Evaluación interna de riesgo inicial</option>
          <option value="due_diligence" ${W.tipo==='due_diligence'?'selected':''}>📋 Due Diligence — Por ámbito de riesgo específico</option>
        </select>
        <div style="margin-top:8px;padding:10px;background:var(--surface3);border-radius:var(--radius-sm);font-size:12px;color:var(--text3)">
          <strong style="color:var(--text2)">Scope Check / Risk Scoring / General:</strong> Un único activo. &nbsp;·&nbsp;
          <strong style="color:var(--text2)">Due Diligence:</strong> Uno por ámbito. Las preguntas pueden marcarse "Solo Completa" para aparecer solo en DD de riesgo alto.
        </div>
      </div>
      <div id="umb-row" style="display:${W.tipo==='scope_check'?'block':'none'}">
        <div class="form-group">
          <label class="form-label">Umbral de materialidad (puntuación mínima para ser material)</label>
          <input class="form-input" type="number" id="wumb" value="${W.umbralMaterial}" style="max-width:120px" oninput="W.umbralMaterial=parseInt(this.value)||0">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Terceros con puntuación ≥ este valor continuarán el proceso de homologación.</div>
        </div>
      </div>
      <div id="wa-row" style="display:${W.tipo==='due_diligence'?'block':'none'}">
      <div class="form-group">
        <label class="form-label">Ámbito de Riesgo *</label>
        <select class="form-select" id="wa" onchange="W.ambito_id=this.value; const opt=this.options[this.selectedIndex]; W.ambito=opt?opt.text:''; ">
          <option value="">Seleccionar ámbito...</option>
          ${state.data.ambitos.map(a=>`<option value="${a.id}" ${W.ambito_id===a.id?'selected':''}>${a.nombre}</option>`).join('')}
        </select>
      </div>
      </div><!-- /wa-row -->
      <hr class="divider">
      <div class="form-group">
        <label class="form-label">Aplicabilidad del cuestionario</label>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
            <input type="radio" name="wapl" value="todos" ${W.aplicaTodos?'checked':''} onchange="W.aplicaTodos=true; document.getElementById('wfiltros').style.display='none'">
            <span style="font-size:13px">Aplicar a <strong>todos</strong> los terceros</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
            <input type="radio" name="wapl" value="filtro" ${!W.aplicaTodos?'checked':''} onchange="W.aplicaTodos=false; document.getElementById('wfiltros').style.display='block'">
            <span style="font-size:13px">Aplicar según <strong>filtros específicos</strong></span>
          </label>
        </div>
      </div>
      <div id="wfiltros" style="display:${!W.aplicaTodos?'block':'none'};background:var(--surface2);border-radius:var(--radius);padding:16px;border:1px solid var(--border)">
        <div class="form-group">
          <label class="form-label">Por País</label>
          <div class="tag-wrap-pos">
            <div class="tag-input-wrap" id="country-tag-wrap" onclick="document.getElementById('country-input').focus()">
              ${W.paises.map(p=>`<span class="tag-pill">${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">×</button></span>`).join('')}
              <input class="tag-input-field" id="country-input" placeholder="${W.paises.length?'':'Escribir país...'}" oninput="filterCountries(this.value)" onkeydown="countryKeydown(event)" autocomplete="off">
            </div>
            <div class="tag-dropdown" id="country-dd" style="display:none"></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Por Ámbito de Riesgo</label>
          <div class="chip-group">${renderChipGroup(state.data.ambitos.map(a=>({value:a.nombre,label:a.nombre,color:a.color})), W.ambitosAplicables, 'wamb')}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Por Nivel de Riesgo</label>
          <div class="chip-group">${renderChipGroup(['alto','medio','bajo','sin valorar'].map(r=>({value:r,label:r.charAt(0).toUpperCase()+r.slice(1)})), W.nivelesRiesgo, 'wniv')}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Por Tipo de Proveedor</label>
          <div class="chip-group">${renderChipGroup(['Proveedor Directo','Proveedor Indirecto','Cliente'].map(tp=>({value:tp,label:tp})), W.tiposProveedor, 'wtp')}</div>
        </div>
      </div>
    `;
  }

  if (W.step === 2) {
    return `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span style="font-size:13px;color:var(--text2)">${W.preguntas.length} pregunta(s)</span>
        <button class="btn btn-secondary btn-sm" onclick="wAddQ()">${SVG.plus} Añadir Pregunta</button>
      </div>
      <div id="wqlist">${W.preguntas.map((p,i)=>renderQCard(p,i)).join('')}</div>
      ${!W.preguntas.length?'<div class="empty-state" style="padding:30px"><p>Sin preguntas. Pulsa "Añadir Pregunta".</p></div>':''}
    `;
  }

  if (W.step === 3) {
    return `
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Configura los rangos de puntuación para determinar el nivel de riesgo final, basado en la suma de valores de respuestas.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        ${[['bajo','🟢 Bajo','var(--green)'],['medio','🟡 Medio','var(--amber)'],['alto','🔴 Alto','var(--red)']].map(([k,l,c])=>`
          <div class="card" style="border-color:${c}">
            <div style="color:${c};font-weight:700;margin-bottom:12px">${l}</div>
            <div class="form-group"><label class="form-label">Mínimo</label><input class="form-input" type="number" step="0.5" id="r-${k}-min" value="${W['nivelRiesgo'+k.charAt(0).toUpperCase()+k.slice(1)].min}" oninput="W['nivelRiesgo${k.charAt(0).toUpperCase()+k.slice(1)}'].min=parseFloat(this.value)||0"></div>
            <div class="form-group"><label class="form-label">Máximo</label><input class="form-input" type="number" step="0.5" id="r-${k}-max" value="${W['nivelRiesgo'+k.charAt(0).toUpperCase()+k.slice(1)].max}" oninput="W['nivelRiesgo${k.charAt(0).toUpperCase()+k.slice(1)}'].max=parseFloat(this.value)||0"></div>
          </div>
        `).join('')}
      </div>
      <div class="card" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:500;font-size:13px">Bloqueo automático por Red Flag</div>
            <div style="font-size:12px;color:var(--text3);margin-top:4px">Si alguna respuesta tiene flag activado, el resultado se bloqueará para revisión.</div>
          </div>
          <label class="toggle"><input type="checkbox" id="wredflag" ${W.bloqueoRedFlag?'checked':''} onchange="W.bloqueoRedFlag=this.checked"><span class="toggle-slider"></span></label>
        </div>
      </div>
    `;
  }

  if (W.step === 4) {
    const aprobadores = state.data.usuarios.filter(u=>(u.roles||[]).some(r=>r==='aprobador'||r==='admin'));
    return `
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Configura qué usuarios deben aprobar los resultados según el nivel de riesgo detectado.</p>
      ${[['alto','🔴 Riesgo Alto','var(--red)'],['medio','🟡 Riesgo Medio','var(--amber)'],['bajo','🟢 Riesgo Bajo','var(--green)']].map(([nivel,label,color])=>`
        <div class="form-group">
          <label class="form-label" style="color:${color}">${label} — Aprobador</label>
          <select class="form-select" id="apr-${nivel}" onchange="W.aprobadores['${nivel}']=this.value">
            <option value="">Sin aprobador requerido</option>
            ${aprobadores.map(u=>`<option value="${u.nombre}" ${W.aprobadores[nivel]===u.nombre?'selected':''}>${u.nombre}</option>`).join('')}
          </select>
        </div>
      `).join('')}
      <div class="info-box" style="margin-top:16px">ℹ️ Los aprobadores recibirán notificaciones cuando un cuestionario alcance su nivel de riesgo asignado.</div>
    `;
  }
}

// Country tag input helpers
let _countryHighlight = -1;
function filterCountries(val) {
  const dd = document.getElementById('country-dd');
  if (!val.trim()) { dd.style.display='none'; return; }
  const matches = COUNTRIES.filter(c => c.toLowerCase().includes(val.toLowerCase()) && !W.paises.includes(c)).slice(0,8);
  if (!matches.length) { dd.style.display='none'; return; }
  _countryHighlight = -1;
  dd.innerHTML = matches.map((c,i)=>`<div class="tag-option" data-idx="${i}" onclick="addPaisWizard('${c}')">${c}</div>`).join('');
  dd.style.display='block';
}
function countryKeydown(e) {
  const dd = document.getElementById('country-dd');
  const opts = dd.querySelectorAll('.tag-option');
  if (e.key==='ArrowDown') { _countryHighlight=Math.min(_countryHighlight+1,opts.length-1); opts.forEach((o,i)=>o.classList.toggle('highlighted',i===_countryHighlight)); e.preventDefault(); }
  else if (e.key==='ArrowUp') { _countryHighlight=Math.max(_countryHighlight-1,0); opts.forEach((o,i)=>o.classList.toggle('highlighted',i===_countryHighlight)); e.preventDefault(); }
  else if (e.key==='Enter') { if (_countryHighlight>=0&&opts[_countryHighlight]) { addPaisWizard(opts[_countryHighlight].textContent); e.preventDefault(); } }
  else if (e.key==='Escape') { dd.style.display='none'; }
}
function addPaisWizard(pais) {
  if (!W.paises.includes(pais)) { W.paises.push(pais); }
  document.getElementById('country-input').value='';
  document.getElementById('country-dd').style.display='none';
  // Re-render tags
  const wrap = document.getElementById('country-tag-wrap');
  if (wrap) {
    // Remove existing pills
    wrap.querySelectorAll('.tag-pill').forEach(p=>p.remove());
    const inp = document.getElementById('country-input');
    W.paises.forEach(p => {
      const pill = document.createElement('span');
      pill.className='tag-pill';
      pill.innerHTML=`${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">×</button>`;
      wrap.insertBefore(pill, inp);
    });
  }
}
function removePaisWizard(pais) {
  W.paises = W.paises.filter(p=>p!==pais);
  const wrap = document.getElementById('country-tag-wrap');
  if (wrap) {
    wrap.querySelectorAll('.tag-pill').forEach(p=>p.remove());
    const inp = document.getElementById('country-input');
    W.paises.forEach(p => {
      const pill = document.createElement('span');
      pill.className='tag-pill';
      pill.innerHTML=`${p}<button onclick="removePaisWizard('${p}');event.stopPropagation()">×</button>`;
      wrap.insertBefore(pill, inp);
    });
  }
}

// Question builder
function renderQCard(p, idx) {
  return `<div class="question-card">
    <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px">
      <div style="color:var(--text3);cursor:grab;padding:4px">${SVG.drag}</div>
      <div class="question-num">${idx+1}</div>
      <div style="flex:1">
        <input class="form-input" placeholder="Texto de la pregunta..." value="${(p.texto||'').replace(/"/g,'&quot;')}" oninput="W.preguntas[${idx}].texto=this.value" style="margin-bottom:8px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="form-select" style="width:auto" onchange="wChangeTipo(${idx},this.value)">
            <option value="abierta" ${p.tipo==='abierta'?'selected':''}>Respuesta abierta</option>
            <option value="select_unico" ${p.tipo==='select_unico'?'selected':''}>Desplegable (única)</option>
            <option value="select_multiple" ${p.tipo==='select_multiple'?'selected':''}>Desplegable (múltiple)</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
            <input type="checkbox" ${p.obligatoria?'checked':''} onchange="W.preguntas[${idx}].obligatoria=this.checked"> Obligatoria
          </label>
          ${W.tipo==='due_diligence' ? `<span style="font-size:10px;padding:2px 7px;border-radius:4px;cursor:pointer;border:1px solid ${p.soloCompleta?'#8b5cf6':'var(--border)'};background:${p.soloCompleta?'rgba(139,92,246,.12)':'var(--surface)'};color:${p.soloCompleta?'#8b5cf6':'var(--text3)'}" onclick="W.preguntas[${idx}].soloCompleta=!W.preguntas[${idx}].soloCompleta;wRefreshQ()" title="Solo aparece en DD de riesgo Alto">Solo Completa</span>` : ''}
        </div>
      </div>
      <button class="btn btn-danger btn-icon btn-sm" onclick="wRemoveQ(${idx})">${SVG.trash}</button>
    </div>
    ${p.tipo!=='abierta' ? `
      <div style="padding-left:44px">
        <div style="display:flex;font-size:11px;color:var(--text3);gap:8px;padding:0 4px;margin-bottom:6px">
          <span style="flex:1">Opción</span><span style="width:64px;text-align:center">Valor</span><span style="width:28px;text-align:center">🚩</span><span style="width:28px"></span>
        </div>
        ${(p.opciones||[]).map((op,oi)=>`
          <div class="option-row">
            <input class="option-input" value="${(op.texto||'').replace(/"/g,'&quot;')}" placeholder="Texto de la opción..." oninput="W.preguntas[${idx}].opciones[${oi}].texto=this.value">
            <input class="option-score" type="number" step="0.5" value="${op.valor??0}" title="Puntuación" oninput="W.preguntas[${idx}].opciones[${oi}].valor=parseFloat(this.value)||0">
            <div class="flag-btn ${op.flag?'on':''}" onclick="wToggleFlag(${idx},${oi})" title="${op.flag?'Quitar flag':'Marcar como red flag'}">🚩</div>
            <button class="btn btn-ghost btn-icon" style="width:28px;height:28px;padding:0" onclick="wRemoveOp(${idx},${oi})">${SVG.x}</button>
          </div>
        `).join('')}
        <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="wAddOp(${idx})">${SVG.plus} Añadir opción</button>
      </div>
    ` : '<div style="padding-left:44px;font-size:12px;color:var(--text3);font-style:italic;margin-top:4px">Campo de texto libre — sin opciones</div>'}
  </div>`;
}

function wRefreshQ() { document.getElementById('wqlist').innerHTML = W.preguntas.map((p,i)=>renderQCard(p,i)).join(''); }
function wAddQ() { W.preguntas.push({id:genId(),texto:'',tipo:'select_unico',obligatoria:false,opciones:[{texto:'',valor:0,flag:false}]}); wRefreshQ(); }
function wRemoveQ(idx) { W.preguntas.splice(idx,1); wRefreshQ(); }
function wChangeTipo(idx,tipo) { W.preguntas[idx].tipo=tipo; if(tipo!=='abierta'&&!W.preguntas[idx].opciones?.length) W.preguntas[idx].opciones=[{texto:'',valor:0,flag:false}]; wRefreshQ(); }
function wAddOp(idx) { W.preguntas[idx].opciones=W.preguntas[idx].opciones||[]; W.preguntas[idx].opciones.push({texto:'',valor:0,flag:false}); wRefreshQ(); }
function wRemoveOp(idx,oi) { W.preguntas[idx].opciones.splice(oi,1); wRefreshQ(); }
function wToggleFlag(idx,oi) { W.preguntas[idx].opciones[oi].flag=!W.preguntas[idx].opciones[oi].flag; wRefreshQ(); }

function wCollectStep() {
  // Collect current step data into W before navigating
  if (W.step===1) {
    W.nombre = document.getElementById('wn')?.value||W.nombre;
    const wt = document.getElementById('wt'); if (wt) W.tipo = wt.value;
    const wumb = document.getElementById('wumb'); if (wumb) W.umbralMaterial = parseInt(wumb.value)||0;
    const wa = document.getElementById('wa');
    if (wa) { W.ambito_id=wa.value; const sel=wa.options[wa.selectedIndex]; W.ambito=sel&&wa.value?sel.text:''; }
    // collect chips if filters visible
    if (!W.aplicaTodos) {
      W.ambitosAplicables = getChipValues('wamb');
      W.nivelesRiesgo = getChipValues('wniv');
      W.tiposProveedor = getChipValues('wtp');
    }
  }
  if (W.step===3) {
    ['bajo','medio','alto'].forEach(k => {
      const K = k.charAt(0).toUpperCase()+k.slice(1);
      const mn = document.getElementById(`r-${k}-min`); const mx = document.getElementById(`r-${k}-max`);
      if(mn) W[`nivelRiesgo${K}`].min = parseFloat(mn.value)||0;
      if(mx) W[`nivelRiesgo${K}`].max = parseFloat(mx.value)||0;
    });
    const rf = document.getElementById('wredflag'); if(rf) W.bloqueoRedFlag=rf.checked;
  }
  if (W.step===4) {
    ['alto','medio','bajo'].forEach(n => {
      const el = document.getElementById(`apr-${n}`); if(el) W.aprobadores[n]=el.value;
    });
  }
}

function wValidateStep() {
  if (W.step===1) {
    if (!W.nombre.trim()) { notify('El nombre del cuestionario es obligatorio', 'error'); return false; }
    if (W.tipo === 'due_diligence' && !W.ambito_id) { notify('Selecciona un ámbito de riesgo', 'error'); return false; }
  }
  return true;
}

function wNav(dir) {
  wCollectStep();
  if (dir > 0 && !wValidateStep()) return;
  W.step = Math.max(1, Math.min(4, W.step+dir));
  renderWizardModal();
}

async function wSave() {
  wCollectStep();
  const item = {
    id: W.id||genId(),
    nombre: W.nombre,
    tipo: W.tipo||'due_diligence',
    ambito: W.ambito,
    ambito_id: W.ambito_id,
    umbralMaterial: W.umbralMaterial||2,
    aplicaTodos: W.aplicaTodos,
    paises: W.paises,
    ambitosAplicables: W.ambitosAplicables,
    nivelesRiesgo: W.nivelesRiesgo,
    tiposProveedor: W.tiposProveedor,
    preguntas: W.preguntas,
    nivelRiesgoBajo: W.nivelRiesgoBajo,
    nivelRiesgoMedio: W.nivelRiesgoMedio,
    nivelRiesgoAlto: W.nivelRiesgoAlto,
    bloqueoRedFlag: W.bloqueoRedFlag,
    aprobadores: W.aprobadores,
    creado: W.creado,
    modificado: new Date().toISOString().split('T')[0],
  };
  await saveItem('cuestionarios', item);
  // Link to ambito
  const amb = state.data.ambitos.find(a=>a.id===item.ambito_id);
  if (amb) { amb.cuestionarios=amb.cuestionarios||[]; if(!amb.cuestionarios.includes(item.id)) { amb.cuestionarios.push(item.id); await saveItem('ambitos',amb); } }
  notify('Cuestionario guardado correctamente');
  closeModal(); renderCuestionarios();
}

// ══════════════════════════════════════════════════════════════
//  HOMOLOGACIÓN — helpers
// ══════════════════════════════════════════════════════════════
const addMonths = (date, m) => { const d = new Date(date); d.setMonth(d.getMonth() + m); return d.toISOString().split('T')[0]; };

function homBadge(fase) {
  return ({
    pendiente:   '<span class="hom-status hom-pendiente">Sin iniciar</span>',
    fuera_scope: '<span class="hom-status hom-fuera">Fuera de scope</span>',
    scope_check: '<span class="hom-status hom-scope">🔍 Scope Check</span>',
    risk_scoring:'<span class="hom-status hom-scoring">📊 Risk Scoring</span>',
    due_diligence:'<span class="hom-status hom-dd">📋 Due Diligence</span>',
    aprobacion:  '<span class="hom-status hom-aprobacion">⏳ Aprobación</span>',
    completada:  '<span class="hom-status hom-completada">✅ Homologado</span>',
  }[fase] || '<span class="hom-status hom-pendiente">—</span>');
}

function getActiveHom(tid) { return state.data.homologaciones.find(h => h.terceroId === tid && !['completada','fuera_scope'].includes(h.fase)); }
function getLastHom(tid) { return state.data.homologaciones.filter(h => h.terceroId === tid).sort((a,b) => new Date(b.fechaInicio)-new Date(a.fechaInicio))[0]; }

function calcScore(preguntas, respuestas) {
  let score = 0, hasFlag = false;
  preguntas.forEach(p => {
    const resp = respuestas[p.id];
    if (resp !== undefined && resp !== '') {
      const op = (p.opciones||[]).find(o => o.texto === resp);
      if (op) { score += op.valor||0; if (op.flag) hasFlag = true; }
    }
  });
  return { score, hasFlag };
}

function getRiskLevel(cq, score, hasFlag) {
  if (hasFlag && cq.bloqueoRedFlag) return 'alto';
  if (score <= cq.nivelRiesgoBajo.max) return 'bajo';
  if (score <= cq.nivelRiesgoMedio.max) return 'medio';
  return 'alto';
}

function getDDCuestionarios(tercero) {
  const general = state.data.cuestionarios.find(c => c.tipo === 'general');
  const porAmbito = state.data.cuestionarios.filter(c => c.tipo === 'due_diligence' && (tercero.ambitos||[]).includes(c.ambito));
  return [...(general ? [general] : []), ...porAmbito];
}

function filterByDDLevel(preguntas, nivel) {
  return nivel === 'alto' ? preguntas : preguntas.filter(p => !p.soloCompleta);
}

// ══════════════════════════════════════════════════════════════
//  HOMOLOGACIÓN — wizard
// ══════════════════════════════════════════════════════════════
let HW = {};

function iniciarHom(terceroId) {
  const tercero = state.data.terceros.find(t => t.id === terceroId);
  if (!tercero) return;
  let hom = getActiveHom(terceroId);
  if (!hom) {
    hom = {
      id: genId(), terceroId, terceroNombre: tercero.nombre, fase: 'scope_check',
      fechaInicio: new Date().toISOString().split('T')[0], fechaCierre: '',
      scopeCheck:   { respuestas:{}, score:0, resultado:'' },
      riskScoring:  { respuestas:{}, score:0, resultado:'', hasFlag:false },
      dueDiligence: { nivel:'', cuestionariosOrder:[], respuestasPorCuestionario:{}, resultadoPorCuestionario:{}, resultadoFinal:'', cuestionarioActual:0 },
      aprobacion:   { estado:'', aprobadoPor:'', fecha:'', comentario:'' },
      riesgoFinal: '', creadoPor: 'Admin Usuario'
    };
  }
  HW = { hom, tercero };
  renderHW();
}

function renderHW() {
  const h = HW.hom;
  const faseIdx = { scope_check:0, risk_scoring:1, due_diligence:2, aprobacion:3, completada:4 };
  const ci = faseIdx[h.fase] ?? 0;
  const faseNames = ['Scope Check','Risk Scoring','Due Diligence','Aprobación','Completada'];
  const fases = ['scope_check','risk_scoring','due_diligence','aprobacion','completada'];
  const steps = fases.map((f,i) => {
    const done = i < ci, active = i === ci;
    const bg = active ? 'var(--accent)' : done ? 'var(--green)' : 'var(--surface3)';
    const col = active ? 'var(--accent)' : done ? 'var(--green)' : 'var(--text3)';
    const wc = active || done ? 'white' : 'var(--text3)';
    return `<div style="display:flex;align-items:center;gap:5px;font-size:11px;color:${col}">
      <div style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;background:${bg};color:${wc}">${done?'✓':i+1}</div>
      ${faseNames[i]}${i<4?'<span style="color:var(--border2);margin-left:5px">›</span>':''}
    </div>`;
  }).join('');
  openModal(`<div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <div style="flex:1">
        <div class="modal-title">Homologación: ${HW.tercero.nombre}</div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">${steps}</div>
      </div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal()">${SVG.x}</button>
    </div>
    <div class="modal-body" id="hw-body">${hwStep()}</div>
    <div class="modal-footer" id="hw-footer">${hwFooter()}</div>
  </div>`);
}

function hwStep() {
  const h = HW.hom, t = HW.tercero;

  if (h.fase === 'scope_check') {
    const cq = state.data.cuestionarios.find(c => c.tipo === 'scope_check');
    if (!cq) return `<div class="warn-box">⚠️ No hay cuestionario de Scope Check configurado. Créalo en la sección Cuestionarios (tipo: Scope Check).</div>`;
    return `<div class="info-box" style="margin-bottom:16px">🔍 <strong>Scope Check</strong> — Determina si este tercero requiere homologación formal.<br><small style="margin-top:4px;display:block">Umbral de materialidad: puntuación ≥ ${cq.umbralMaterial||2}</small></div>${renderQs(cq, h.scopeCheck.respuestas, 'hw-sc')}`;
  }

  if (h.fase === 'risk_scoring') {
    const cq = state.data.cuestionarios.find(c => c.tipo === 'risk_scoring');
    if (!cq) return `<div class="warn-box">⚠️ No hay cuestionario de Risk Scoring configurado.</div>`;
    return `<div class="success-box" style="margin-bottom:12px">✅ Scope Check completado — Tercero <strong>material</strong> (puntuación: ${h.scopeCheck.score})</div>
      <div class="info-box" style="margin-bottom:16px">📊 <strong>Risk Scoring</strong> — Evaluación interna de riesgo inicial.<br><small style="margin-top:4px;display:block">Bajo → Homologación automática · Medio → DD Reducida · Alto → DD Completa</small></div>
      ${renderQs(cq, h.riskScoring.respuestas, 'hw-rs')}`;
  }

  if (h.fase === 'due_diligence') {
    const dd = h.dueDiligence, cuests = getDDCuestionarios(t);
    if (!cuests.length) return `<div class="warn-box">⚠️ No hay cuestionarios DD configurados para los ámbitos de este tercero.</div>`;
    const idx = dd.cuestionarioActual||0, cq = cuests[idx];
    const preguntas = filterByDDLevel(cq.preguntas||[], dd.nivel);
    const rsColor = h.riskScoring.resultado==='alto'?'var(--red)':h.riskScoring.resultado==='medio'?'var(--amber)':'var(--green)';
    return `<div style="margin-bottom:16px">
      <div class="${h.riskScoring.resultado==='bajo'?'success-box':'warn-box'}" style="margin-bottom:10px">📊 Risk Scoring: <strong style="color:${rsColor}">${h.riskScoring.resultado?.toUpperCase()}</strong> → DD <strong>${dd.nivel==='alto'?'Completa':'Reducida'}</strong></div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div class="info-box" style="flex:1">📋 <strong>${cq.nombre}</strong>${cq.tipo==='general'?'<span class="badge" style="background:rgba(6,182,212,.12);color:#06b6d4;margin-left:8px">General — siempre primero</span>':''}${dd.nivel!=='alto'&&(cq.preguntas||[]).some(p=>p.soloCompleta)?'<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px">Versión reducida</span>':''}</div>
        <span style="font-size:12px;color:var(--text3);flex-shrink:0">${idx+1} / ${cuests.length}</span>
      </div>
    </div>
    ${renderQs({...cq, preguntas}, dd.respuestasPorCuestionario[cq.id]||{}, 'hw-dd')}`;
  }

  if (h.fase === 'aprobacion') {
    const dd = h.dueDiligence, cuests = getDDCuestionarios(t);
    const resColor = dd.resultadoFinal==='alto'?'var(--red)':dd.resultadoFinal==='medio'?'var(--amber)':'var(--green)';
    return `<div class="warn-box" style="margin-bottom:16px">⏳ <strong>Pendiente de aprobación.</strong> Resultado DD: <strong style="color:${resColor}">${dd.resultadoFinal?.toUpperCase()}</strong></div>
      <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text)">Resumen por cuestionario:</div>
      ${cuests.map(cq => {
        const r = dd.resultadoPorCuestionario[cq.id];
        const cls = r?.resultado==='alto'?'border-color:var(--red);background:rgba(239,68,68,.08)':r?.resultado==='bajo'?'border-color:var(--green);background:rgba(16,185,129,.08)':'border-color:var(--accent);background:var(--accent-glow)';
        return `<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--radius);border:1px solid var(--border);${cls};margin-bottom:8px">
          <div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;background:${r?.resultado==='bajo'?'var(--green)':r?.resultado==='alto'?'var(--red)':'var(--accent)'};color:white;flex-shrink:0">${r?.resultado==='bajo'?'✓':r?.resultado==='alto'?'!':'?'}</div>
          <div style="flex:1"><div style="font-weight:500;font-size:13px">${cq.nombre}</div><div style="font-size:12px;color:var(--text2);margin-top:2px">Puntuación: ${r?.score??'—'} · Resultado: ${r?.resultado||'—'}${r?.hasFlag?' 🚩':''}</div></div>
          ${riskBadge(r?.resultado||'sin valorar')}
        </div>`;
      }).join('')}
      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <div class="form-group"><label class="form-label">Comentario de aprobación (opcional)</label><textarea class="form-textarea" id="apr-com" rows="3" placeholder="Observaciones..."></textarea></div>`;
  }

  if (h.fase === 'completada') {
    const dd = h.dueDiligence;
    const resColor = h.riesgoFinal==='alto'?'var(--red)':h.riesgoFinal==='medio'?'var(--amber)':'var(--green)';
    const ter = state.data.terceros.find(t2 => t2.id === h.terceroId);
    return `<div class="success-box" style="margin-bottom:20px;font-size:14px">✅ <strong>Homologación completada.</strong> Nivel de riesgo asignado: <strong style="color:${resColor}">${h.riesgoFinal?.toUpperCase()}</strong></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Fecha inicio</div><div style="font-weight:500;margin-top:4px">${fmtDate(h.fechaInicio)}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Fecha cierre</div><div style="font-weight:500;margin-top:4px">${fmtDate(h.fechaCierre)}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Risk Scoring</div><div style="font-weight:500;margin-top:4px">${h.riskScoring.resultado?.toUpperCase()||'—'}</div></div>
        <div class="card" style="padding:14px"><div style="font-size:11px;color:var(--text3)">Nivel DD</div><div style="font-weight:500;margin-top:4px">${dd.nivel?(dd.nivel==='alto'?'Completa':'Reducida'):'Automática (Bajo)'}</div></div>
      </div>
      ${ter?.fechaSiguiente?`<div class="info-box">📅 Próxima renovación: <strong>${fmtDate(ter.fechaSiguiente)}</strong></div>`:''}`;
  }
  return '';
}

function hwFooter() {
  const h = HW.hom;
  if (h.fase === 'scope_check')  return `<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="hwSubmitScope()">Continuar →</button>`;
  if (h.fase === 'risk_scoring') return `<button class="btn btn-secondary" onclick="closeModal()">Guardar y cerrar</button><button class="btn btn-primary" onclick="hwSubmitRisk()">Continuar →</button>`;
  if (h.fase === 'due_diligence') {
    const cuests = getDDCuestionarios(HW.tercero), idx = HW.hom.dueDiligence.cuestionarioActual||0;
    const isLast = idx >= cuests.length-1;
    return `<button class="btn btn-secondary" onclick="closeModal()">Guardar y cerrar</button><button class="btn btn-primary" onclick="hwSubmitDD()">${isLast?'Finalizar Due Diligence →':'Siguiente cuestionario →'}</button>`;
  }
  if (h.fase === 'aprobacion')   return `<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn btn-success" onclick="hwAprobar()">${SVG.check} Aprobar y Homologar</button>`;
  return `<button class="btn btn-primary" onclick="closeModal()">Cerrar</button>`;
}

function renderQs(cq, respuestas, prefix) {
  return (cq.preguntas||[]).map((p, i) => `<div class="questionnaire-question">
    <div class="question-text">${i+1}. ${p.texto}${p.obligatoria?'<span style="color:var(--red);margin-left:4px">*</span>':''}${p.soloCompleta?'<span class="badge" style="background:rgba(139,92,246,.12);color:#8b5cf6;margin-left:8px;font-size:10px">Solo completa</span>':''}</div>
    ${p.tipo==='abierta'
      ? `<textarea class="form-textarea" id="${prefix}-${p.id}" rows="2" placeholder="Respuesta libre...">${respuestas[p.id]||''}</textarea>`
      : `<div style="display:flex;flex-direction:column;gap:8px">${(p.opciones||[]).map(op => {
          const isSel = respuestas[p.id] === op.texto;
          return `<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid ${isSel?(op.flag?'var(--red)':'var(--accent)'):'var(--border2)'};background:${isSel?(op.flag?'rgba(239,68,68,.08)':'var(--accent-glow)'):'transparent'};cursor:pointer;transition:all .15s" onclick="qSel(this,'${prefix}','${p.id}')">
            <input type="radio" name="${prefix}-${p.id}" value="${op.texto.replace(/"/g,'&quot;')}" ${isSel?'checked':''} style="pointer-events:none;accent-color:var(--accent)">
            <span style="flex:1">${op.texto}</span>
            ${op.valor?`<span style="font-size:11px;color:var(--amber)">${op.valor}pts</span>`:''}
            ${op.flag?`<span style="color:var(--red);margin-left:4px">🚩</span>`:''}
          </label>`;
        }).join('')}</div>`}
  </div>`).join('');
}

function qSel(labelEl, prefix, qId) {
  const group = labelEl.closest('[style*="flex-direction:column"]');
  group.querySelectorAll('label').forEach(l => {
    const r = l.querySelector('input');
    const isFlag = l.innerHTML.includes('🚩');
    l.style.borderColor = 'var(--border2)';
    l.style.background = 'transparent';
    if (r) r.checked = false;
  });
  const isFlag = labelEl.innerHTML.includes('🚩');
  labelEl.style.borderColor = isFlag ? 'var(--red)' : 'var(--accent)';
  labelEl.style.background = isFlag ? 'rgba(239,68,68,.08)' : 'var(--accent-glow)';
  const inp = labelEl.querySelector('input'); if (inp) inp.checked = true;
}

function collectQs(prefix, preguntas) {
  const resp = {};
  preguntas.forEach(p => {
    if (p.tipo === 'abierta') { const el = document.getElementById(`${prefix}-${p.id}`); if (el) resp[p.id] = el.value; }
    else { const c = document.querySelector(`input[name="${prefix}-${p.id}"]:checked`); if (c) resp[p.id] = c.value; }
  });
  return resp;
}

async function hwSubmitScope() {
  const cq = state.data.cuestionarios.find(c => c.tipo === 'scope_check');
  if (!cq) { notify('Sin cuestionario de Scope Check', 'error'); return; }
  const resp = collectQs('hw-sc', cq.preguntas||[]);
  const missing = (cq.preguntas||[]).filter(p => p.obligatoria && !resp[p.id]);
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const { score, hasFlag } = calcScore(cq.preguntas||[], resp);
  const material = score >= (cq.umbralMaterial||2);
  HW.hom.scopeCheck = { respuestas:resp, score, resultado: material?'material':'no_material' };
  if (!material) {
    HW.hom.fase = 'fuera_scope'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
    await saveItem('homologaciones', HW.hom);
    notify('Tercero marcado como Fuera de Scope — no requiere homologación');
    closeModal(); renderTerceros(); return;
  }
  HW.hom.fase = 'risk_scoring';
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwSubmitRisk() {
  const cq = state.data.cuestionarios.find(c => c.tipo === 'risk_scoring');
  if (!cq) { notify('Sin cuestionario de Risk Scoring', 'error'); return; }
  const resp = collectQs('hw-rs', cq.preguntas||[]);
  const missing = (cq.preguntas||[]).filter(p => p.obligatoria && !resp[p.id]);
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const { score, hasFlag } = calcScore(cq.preguntas||[], resp);
  const nivel = getRiskLevel(cq, score, hasFlag);
  HW.hom.riskScoring = { respuestas:resp, score, resultado:nivel, hasFlag };

  if (nivel === 'bajo' && !hasFlag) {
    HW.hom.riesgoFinal = 'bajo'; HW.hom.fase = 'completada'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
    const plazos = state.data.plazos||{bajo:36};
    const tercero = state.data.terceros.find(t => t.id === HW.hom.terceroId);
    if (tercero) { tercero.riesgo = 'bajo'; tercero.fechaUltima = HW.hom.fechaCierre; if (!tercero.fechaPrimera) tercero.fechaPrimera = HW.hom.fechaCierre; tercero.fechaSiguiente = addMonths(HW.hom.fechaCierre, plazos.bajo||36); await saveItem('terceros', tercero); HW.tercero = tercero; }
    await saveItem('homologaciones', HW.hom);
    notify('✅ Risk Scoring Bajo — Homologado automáticamente');
    document.getElementById('hw-body').innerHTML = hwStep();
    document.getElementById('hw-footer').innerHTML = hwFooter(); return;
  }

  const ddNivel = (nivel === 'alto' || hasFlag) ? 'alto' : 'medio';
  const cuests = getDDCuestionarios(HW.tercero);
  HW.hom.dueDiligence = { nivel:ddNivel, cuestionariosOrder:cuests.map(c=>c.id), respuestasPorCuestionario:{}, resultadoPorCuestionario:{}, resultadoFinal:'', cuestionarioActual:0 };
  HW.hom.fase = 'due_diligence';
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwSubmitDD() {
  const dd = HW.hom.dueDiligence, cuests = getDDCuestionarios(HW.tercero);
  const idx = dd.cuestionarioActual||0, cq = cuests[idx];
  const preguntas = filterByDDLevel(cq.preguntas||[], dd.nivel);
  const resp = collectQs('hw-dd', preguntas);
  const missing = preguntas.filter(p => p.obligatoria && !resp[p.id]);
  if (missing.length) { notify(`Faltan ${missing.length} respuesta(s) obligatoria(s)`, 'error'); return; }
  const { score, hasFlag } = calcScore(preguntas, resp);
  const nivel = getRiskLevel(cq, score, hasFlag);
  dd.respuestasPorCuestionario[cq.id] = resp;
  dd.resultadoPorCuestionario[cq.id] = { score, hasFlag, resultado:nivel };

  if (idx < cuests.length-1) { dd.cuestionarioActual = idx+1; await saveItem('homologaciones', HW.hom); document.getElementById('hw-body').innerHTML = hwStep(); document.getElementById('hw-footer').innerHTML = hwFooter(); return; }

  const results = Object.values(dd.resultadoPorCuestionario);
  dd.resultadoFinal = results.some(r=>r.hasFlag||r.resultado==='alto') ? 'alto' : results.some(r=>r.resultado==='medio') ? 'medio' : 'bajo';

  const cqG = state.data.cuestionarios.find(c => c.tipo === 'general');
  const aprobador = cqG?.aprobadores?.[dd.resultadoFinal]||'';
  if (aprobador) { HW.hom.fase = 'aprobacion'; } else { await hwCompletar(); return; }
  await saveItem('homologaciones', HW.hom);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

async function hwAprobar() {
  HW.hom.aprobacion = { estado:'aprobado', aprobadoPor:'Admin Usuario', fecha:new Date().toISOString().split('T')[0], comentario:document.getElementById('apr-com')?.value||'' };
  await hwCompletar();
}

async function hwCompletar() {
  const dd = HW.hom.dueDiligence;
  HW.hom.riesgoFinal = dd.resultadoFinal||'bajo'; HW.hom.fase = 'completada'; HW.hom.fechaCierre = new Date().toISOString().split('T')[0];
  const plazos = state.data.plazos||{alto:12,medio:24,bajo:36};
  const meses = plazos[HW.hom.riesgoFinal]||24;
  const tercero = state.data.terceros.find(t => t.id === HW.hom.terceroId);
  if (tercero) { tercero.riesgo = HW.hom.riesgoFinal; tercero.fechaUltima = HW.hom.fechaCierre; if (!tercero.fechaPrimera) tercero.fechaPrimera = HW.hom.fechaCierre; tercero.fechaSiguiente = addMonths(HW.hom.fechaCierre, meses); await saveItem('terceros', tercero); HW.tercero = tercero; }
  await saveItem('homologaciones', HW.hom);
  notify(`✅ Homologación completada — Riesgo ${HW.hom.riesgoFinal.toUpperCase()}`);
  document.getElementById('hw-body').innerHTML = hwStep();
  document.getElementById('hw-footer').innerHTML = hwFooter();
}

// ══════════════════════════════════════════════════════════════
//  HOMOLOGACIONES — list page
// ══════════════════════════════════════════════════════════════
function renderHomologaciones() {
  const homs = state.data.homologaciones;
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="section-header">
      <div><div class="section-title">Homologaciones</div><div class="section-sub">${homs.length} registros</div></div>
    </div>
    ${!homs.length ? `<div style="text-align:center;padding:80px 20px;color:var(--text3)"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 16px;display:block;opacity:.4"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><p>Sin homologaciones. Inicia una desde el Maestro de Terceros.</p></div>` : `
    <div class="card" style="padding:0">
      <div class="table-wrap"><table>
        <thead><tr><th>Tercero</th><th>Inicio</th><th>Fase</th><th>Scope</th><th>Risk Scoring</th><th>DD Nivel</th><th>Resultado</th><th>Cierre</th><th>Acciones</th></tr></thead>
        <tbody>${homs.sort((a,b)=>new Date(b.fechaInicio)-new Date(a.fechaInicio)).map(h => `<tr>
          <td style="color:var(--text);font-weight:500">${h.terceroNombre}</td>
          <td>${fmtDate(h.fechaInicio)}</td>
          <td>${homBadge(h.fase)}</td>
          <td>${h.scopeCheck?.resultado ? `<span class="badge ${h.scopeCheck.resultado==='material'?'badge-amber':'badge-gray'}">${h.scopeCheck.resultado}</span>` : '—'}</td>
          <td>${h.riskScoring?.resultado ? riskBadge(h.riskScoring.resultado) : '—'}</td>
          <td>${h.dueDiligence?.nivel ? `<span class="badge ${h.dueDiligence.nivel==='alto'?'badge-red':'badge-amber'}">${h.dueDiligence.nivel==='alto'?'Completa':'Reducida'}</span>` : '—'}</td>
          <td>${h.riesgoFinal ? riskBadge(h.riesgoFinal) : '—'}</td>
          <td>${fmtDate(h.fechaCierre)}</td>
          <td><div style="display:flex;gap:4px">
            ${!['completada','fuera_scope'].includes(h.fase) ? `<button class="btn btn-success btn-sm" onclick="resumeHom('${h.id}')">${SVG.play} Continuar</button>` : ''}
            <button class="btn btn-danger btn-icon btn-sm" onclick="deleteHom('${h.id}')">${SVG.trash}</button>
          </div></td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>`}`;
}

async function deleteHom(id) { if (!confirm('¿Eliminar esta homologación?')) return; await deleteItem('homologaciones', id); notify('Eliminada'); renderHomologaciones(); }
function resumeHom(id) { const h = state.data.homologaciones.find(x=>x.id===id); const t = state.data.terceros.find(x=>x.id===h?.terceroId); if (!h||!t) return; HW = {hom:h, tercero:t}; renderHW(); }

// ══════════════════════════════════════════════════════════════
//  PLAZOS — config page
// ══════════════════════════════════════════════════════════════
function renderPlazos() {
  const p = state.data.plazos||{alto:12,medio:24,bajo:36};
  document.getElementById('content').innerHTML = `
    <div class="section-header"><div><div class="section-title">Plazos de Renovación</div><div class="section-sub">Meses hasta la siguiente homologación según resultado</div></div></div>
    <div class="info-box" style="margin-bottom:20px">ℹ️ Al completar una homologación, el sistema calcula automáticamente la fecha de siguiente renovación: fecha de cierre + los meses configurados aquí.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px">
      ${[['alto','🔴 Riesgo Alto','var(--red)'],['medio','🟡 Riesgo Medio','var(--amber)'],['bajo','🟢 Riesgo Bajo','var(--green)']].map(([k,l,c]) => `
        <div class="card" style="border-left:3px solid ${c}">
          <div style="color:${c};font-weight:700;font-family:'Syne',sans-serif;font-size:15px;margin-bottom:16px">${l}</div>
          <div class="form-group"><label class="form-label">Meses hasta renovación</label>
            <input class="form-input" type="number" min="1" max="120" id="pl-${k}" value="${p[k]||0}" style="max-width:120px">
          </div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Equivale a <strong style="color:var(--text2)">${((p[k]||0)/12).toFixed(1)} años</strong></div>
        </div>`).join('')}
    </div>
    <div style="margin-top:24px;display:flex;justify-content:flex-end">
      <button class="btn btn-primary" onclick="savePlazos()">${SVG.check} Guardar Plazos</button>
    </div>`;
}

async function savePlazos() {
  state.data.plazos = { alto: parseInt(document.getElementById('pl-alto').value)||12, medio: parseInt(document.getElementById('pl-medio').value)||24, bajo: parseInt(document.getElementById('pl-bajo').value)||36 };
  if (db) { try { await db.collection('config').doc('plazos').set(state.data.plazos); } catch(e){} }
  notify('Plazos guardados'); renderPlazos();
}

// ══════════════════════════════════════════════════════════════
//  INIT — auto-connect Firestore, then render
// ══════════════════════════════════════════════════════════════
FS.init().then(() => navigate('dashboard'));
</script>
</body>
</html>
